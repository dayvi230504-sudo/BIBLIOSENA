<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mensajes - Administrador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
  <style>
    .mensajes-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 968px) {
      .mensajes-container {
        grid-template-columns: 1fr;
      }
    }
    .panel-mensajes {
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }
    .mensaje-item {
      padding: 14px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .mensaje-item:hover {
      background: #f5f5f5;
    }
    .mensaje-item.no-leido {
      background: #fff3cd;
      font-weight: 600;
      border-left: 4px solid #ff9800;
    }
    .panel-formulario {
      background: white;
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 20px;
    }
    .btn-conectar {
      background: #9c27b0;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      margin-bottom: 16px;
    }
    .usuario-chat {
      background: #e3f2fd;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  {% set active_page = 'admin' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarMensajesAdmin' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <h1 class="page-title">ğŸ’¬ Centro de Mensajes - Admin</h1>
    <div class="mensajes-container">
      <!-- Panel de mensajes recibidos -->
      <div class="panel-mensajes">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0; color:#667eea;">ğŸ“¥ Mensajes Recibidos</h3>
          <button onclick="cargarMensajesAdmin()" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">ğŸ”„ Actualizar</button>
        </div>
        <div id="panelMensajes">
          <div style="text-align:center; padding:20px; color:#666;">Cargando mensajes...</div>
        </div>
      </div>

      <!-- Panel de acciones -->
      <div class="panel-formulario">
        <h3 style="margin-top:0; color:#4caf50;">âš™ï¸ Acciones</h3>
        <button class="btn-conectar" onclick="mostrarFormConectar()">ğŸ”— Conectar Dos Usuarios para Chat</button>
        <div style="background:#f0f7ff; padding:12px; border-radius:8px; font-size:13px; color:#555;">
          <strong>ğŸ’¡ Conectar usuarios:</strong> Permite que dos usuarios chateen entre sÃ­ directamente. Ãštil cuando un usuario necesita preguntar a otro sobre un equipo prestado.
        </div>
        
        <div style="margin-top:24px; padding-top:24px; border-top:2px solid #e0e0e0;">
          <h4>ğŸ“Š Resumen de Mensajes</h4>
          <div id="resumenMensajes" style="background:#f8f9fa; padding:16px; border-radius:8px; font-size:14px;">
            <div>ğŸ“¨ Total: <strong id="totalMensajes">0</strong></div>
            <div>ğŸ“¬ No leÃ­dos: <strong id="noLeidosMensajes" style="color:#ff9800;">0</strong></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ProtecciÃ³n: solo admins
    (function(){
      const t = localStorage.getItem('token');
      if (t !== 'admin-token') {
        alert('Acceso restringido a administradores');
        window.location.href = 'principal.html';
      }
    })();

    async function cargarMensajesAdmin() {
      const panel = document.getElementById('panelMensajes');
      if (!panel) return;
      try {
        const res = await fetch('/api/mensajes?admin=true');
        const mensajes = res.ok ? await res.json() : [];
        
        // Actualizar resumen
        const noLeidos = mensajes.filter(m => !m.leido && m.id_destinatario === 'admin').length;
        document.getElementById('totalMensajes').textContent = mensajes.length;
        document.getElementById('noLeidosMensajes').textContent = noLeidos;
        
        if (!mensajes.length) {
          panel.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">No hay mensajes recibidos</div>';
          return;
        }
        
        let html = '';
        for (const msg of mensajes) {
          const fecha = new Date(msg.creado_en).toLocaleString('es-ES');
          const clase = !msg.leido && msg.id_destinatario === 'admin' ? 'no-leido' : '';
          const esNoLeido = !msg.leido && msg.id_destinatario === 'admin';
          
          // Obtener info del remitente
          let nombreRemitente = msg.id_remitente;
          let documentoRemitente = '';
          let fichaRemitente = '';
          if (msg.id_remitente && msg.id_remitente !== 'admin') {
            try {
              const resUser = await fetch(`/api/usuarios/${msg.id_remitente}`);
              if (resUser.ok) {
                const userData = await resUser.json();
                nombreRemitente = userData.nombre || msg.id_remitente;
                documentoRemitente = userData.documento || '';
                fichaRemitente = userData.numero_ficha || '';
              }
            } catch(e) {}
          }
          
          html += `
            <div class="mensaje-item ${clase}" onclick="responderMensaje('${msg.id}', '${msg.id_remitente}', ${esNoLeido})">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                <div style="flex:1;">
                  <div class="usuario-chat">
                    ğŸ‘¤ De: <strong>${nombreRemitente}</strong>
                    ${documentoRemitente ? `<br>ğŸ†” Doc: ${documentoRemitente}` : ''}
                    ${fichaRemitente ? `<br>ğŸ“‹ Ficha: ${fichaRemitente}` : ''}
                  </div>
                  ${msg.asunto ? `<div style="color:#667eea; margin-top:6px; font-weight:600;">ğŸ“Œ ${msg.asunto}</div>` : ''}
                </div>
                <div style="font-size:11px; color:#999; text-align:right;">
                  ${fecha}
                  ${esNoLeido ? '<div style="color:#ff9800; font-weight:bold; margin-top:4px;">NUEVO</div>' : ''}
                </div>
              </div>
              <div style="margin-top:8px; color:#333;">${msg.contenido}</div>
            </div>`;
        }
        panel.innerHTML = html;
      } catch(e) {
        panel.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando mensajes</div>';
      }
    }

    async function responderMensaje(msgId, remitente, esNoLeido) {
      // Si es no leÃ­do, marcarlo como leÃ­do primero
      if (esNoLeido) {
        try {
          await fetch(`/api/mensajes/${msgId}/leer`, { method: 'PUT' });
        } catch(e) {}
      }
      
      const mensaje = prompt('Escribe tu respuesta:', '');
      if (!mensaje) return;
      
      try {
        const res = await fetch('/api/mensajes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id_remitente: 'admin',
            id_destinatario: remitente,
            asunto: 'Respuesta del administrador',
            contenido: mensaje,
            tipo: 'respuesta'
          })
        });
        
        const data = await res.json().catch(()=>({}));
        if (res.ok && data.ok) {
          alert('âœ“ Mensaje enviado al usuario');
          cargarMensajesAdmin();
        } else {
          alert('âœ— ' + (data.error || 'Error al enviar mensaje'));
        }
      } catch(e) {
        alert('Error de conexiÃ³n');
      }
    }

    function mostrarFormConectar() {
      const usuario1 = prompt('ID, documento o username del primer usuario:');
      if (!usuario1) return;
      const usuario2 = prompt('ID, documento o username del segundo usuario:');
      if (!usuario2) return;
      const mensaje = prompt('Mensaje inicial (opcional):', 'El administrador te ha conectado para chatear directamente.');
      
      fetch('/api/mensajes/conectar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          usuario1: usuario1,
          usuario2: usuario2,
          mensaje: mensaje || 'El administrador te ha conectado para chatear directamente.'
        })
      }).then(res => res.json()).then(data => {
        if (data.ok) {
          alert('âœ“ Usuarios conectados. Ahora pueden chatear entre sÃ­.');
        } else {
          alert('âœ— ' + (data.error || 'Error al conectar usuarios'));
        }
      }).catch(e => {
        alert('Error de conexiÃ³n');
      });
    }

    // Cargar mensajes al inicio
    cargarMensajesAdmin();
    // Auto-refresh cada 10 segundos
    setInterval(cargarMensajesAdmin, 10000);
  </script>
</body>
</html>

