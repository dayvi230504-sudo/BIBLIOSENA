<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca SENA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">

<style>
/* Toasts - bottom-right */
#toast-container {
  position: fixed;
  right: 20px;
  bottom: 20px;
  z-index: 2147483647;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: flex-end;
  pointer-events: none; /* allow clicks through when no toasts */
}
.toast {
  min-width: 260px;
  max-width: 360px;
  padding: 12px 16px;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  transform: translateY(16px);
  opacity: 0;
  transition: transform 260ms ease, opacity 260ms ease;
  pointer-events: auto;
}
.toast-show {
  transform: translateY(0);
  opacity: 1;
}
.toast-success { background: linear-gradient(90deg,#2ecc71,#27ae60); }
.toast-error   { background: linear-gradient(90deg,#e74c3c,#c0392b); }
.toast-info    { background: linear-gradient(90deg,#3498db,#2c82d6); }
.toast .toast-title {
  font-weight: 600;
  margin-bottom: 4px;
}
.toast .toast-body {
  opacity: 0.95;
  line-height: 1.2;
}
.toast-close {
  position: absolute;
  top: 6px;
  right: 8px;
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.9);
  font-size: 16px;
  cursor: pointer;
}
</style>

</head>
<body>

  <header class="encabezado">
    <img src="/static/uploads/logosena.jpg" alt="Logo SENA" class="logo">
    <div class="buscador">
      <input type="text" id="buscadorInput" placeholder="ğŸ¤– Buscar libros... (ej: tecnologÃ­a, historia, agricultura)">
      <button id="btnBuscarLibros"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06zM10.5 7a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0" clip-rule="evenodd"/></svg></button>
    </div>
    <div class="usuario" id="usuarioContainer" style="position: relative; cursor: pointer;">
      <span id="nombreUsuario">Usuario</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 48 48"><path fill="currentColor" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="5" d="M24 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14M6 40.8V42h36v-1.2c0-4.48 0-6.72-.872-8.432a8 8 0 0 0-3.496-3.496C35.92 28 33.68 28 29.2 28H18.8c-4.48 0-6.72 0-8.432.872a8 8 0 0 0-3.496 3.496C6 34.08 6 36.32 6 40.8"/></svg>
      <div class="usuario-menu" id="usuarioMenu" style="display: none; position: fixed; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 180px; z-index: 999999; overflow: hidden;">
        <a href="#" id="linkFavoritos" style="display: block; padding: 12px 20px; color: #2c3e50; text-decoration: none; border-bottom: 1px solid #eee; transition: background 0.2s;">
          â¤ï¸ Mis Favoritos
        </a>
        <a href="#" id="linkPerfil" style="display: block; padding: 12px 20px; color: #2c3e50; text-decoration: none; border-bottom: 1px solid #eee; transition: background 0.2s;">
          ğŸ‘¤ Ver Perfil
        </a>
        <a href="#" id="linkCerrarSesion" style="display: block; padding: 12px 20px; color: #e74c3c; text-decoration: none; transition: background 0.2s;">
          ğŸšª Cerrar SesiÃ³n
        </a>
      </div>
    </div>
  </header>
  <nav class="menu">
    <a href="prestamo.html"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M5 15q-.425 0-.712-.288T4 14v-1H3q-.425 0-.712-.288T2 12t.288-.712T3 11h1v-1q0-.425.288-.712T5 9t.713.288T6 10v1h1q.425 0 .713.288T8 12t-.288.713T7 13H6v1q0 .425-.288.713T5 15m9 6V3h6q.825 0 1.413.588T22 5v14q0 .825-.587 1.413T20 21zm-8 0q-.825 0-1.412-.587T4 19v-1.1q0-.4.3-.663T5 17q2.075 0 3.538-1.45T10 12T8.537 8.45T5 7q-.4 0-.7-.25T4 6.1V5q0-.825.588-1.412T6 3h6v18z"/></svg>
    <a id="linkLibro" href="libro.html" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M7 6a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1zm1.5 1.5h7v-1h-7zM4 4.5A2.5 2.5 0 0 1 6.5 2H18a2.5 2.5 0 0 1 2.5 2.5v7.232a6.5 6.5 0 0 0-1.5-.558V4.5a1 1 0 0 0-1-1H6.5a1 1 0 0 0-1 1V18h5.519q.061.782.294 1.5H5.5a1 1 0 0 0 1 1h5.232A6.5 6.5 0 0 0 12.81 22H6.5A2.5 2.5 0 0 1 4 19.5zm19 13a5.5 5.5 0 1 0-11 0a5.5 5.5 0 0 0 11 0m-5 .5l.001 2.503a.5.5 0 1 1-1 0V18h-2.505a.5.5 0 0 1 0-1H17v-2.5a.5.5 0 1 1 1 0V17h2.497a.5.5 0 0 1 0 1z"/></svg></a>
    <a id="linkMensajes" href="mensajes.html" style="display:none;">ğŸ’¬ Chat</a>
    <a id="linkMisPrestamos" href="mis_prestamos.html" style="display:none;">ğŸ“š Mis PrÃ©stamos</a>
    <a href="https://www.sena.edu.co/es-co/Paginas/noticias" target="_blank" rel="noopener">Novedades (SENA)</a>
    <a href="libros.html">ğŸ“š Libros</a>
    <a href="equipos.html">ğŸ’» Equipos</a>
    <div class="dropdown" data-context="inicio">
      <button class="dropdown__toggle" id="catToggle">CategorÃ­as</button>
      <div class="dropdown__menu" id="catMenu">
        <a href="#" onclick="filtrarPorCategoria('')">Todas</a>
        <a href="#" onclick="filtrarPorCategoria('Libros')">ğŸ“š Libros</a>
        <a href="#" onclick="filtrarPorCategoria('Equipos InformÃ¡ticos')">ğŸ’» Equipos</a>
        <a href="#" onclick="filtrarPorCategoria('Ciencia')">ğŸ”¬ Ciencia</a>
        <a href="#" onclick="filtrarPorCategoria('Historia')">ğŸ“œ Historia</a>
        <a href="#" onclick="filtrarPorCategoria('TecnologÃ­a')">ğŸ’¡ TecnologÃ­a</a>
        <a href="#" onclick="filtrarPorCategoria('Literatura')">âœï¸ Literatura</a>
      </div>
    </div>
    <a id="adminLink" href="admin.html" style="display:none">Admin</a>
  </nav>

  <main class="content">
    <!-- SecciÃ³n Hero / PresentaciÃ³n -->
    <section class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">ğŸ“š Bienvenido a BIBLIOSENA</h1>
        <p class="hero-subtitle">Tu biblioteca digital del SENA. Descubre, presta y explora un mundo de conocimiento.</p>
        <div class="hero-stats">
          <div class="stat-card">
            <div class="stat-number" id="totalLibros">-</div>
            <div class="stat-label">ğŸ“– Libros Disponibles</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalEquipos">-</div>
            <div class="stat-label">ğŸ’» Equipos Disponibles</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalDisponibles">-</div>
            <div class="stat-label">âœ… Elementos Activos</div>
          </div>
        </div>
        <div class="hero-actions">
          <a href="libros.html" class="btn-hero btn-primary">Explorar Libros</a>
          <a href="equipos.html" class="btn-hero btn-secondary">Ver Equipos</a>
        </div>
      </div>
    </section>

    <!-- SecciÃ³n de Nuevos TÃ­tulos -->
    <section class="section-novedades">
      <div class="section-header">
        <h2>âœ¨ Nuevos TÃ­tulos</h2>
        <p class="section-description">Descubre los Ãºltimos libros agregados a nuestra colecciÃ³n</p>
      </div>
      <div class="carousel-container">
        <section class="carousel" aria-label="Carrusel de libros">
          <button type="button" class="carousel__btn carousel__btn--prev" id="prevBtn" aria-label="Anterior">â®</button>
          <div class="carousel__viewport" id="carouselViewport">
            <div class="carousel__track" id="carouselTrack"></div>
          </div>
          <button type="button" class="carousel__btn carousel__btn--next" id="nextBtn" aria-label="Siguiente">â¯</button>
        </section>
      </div>
    </section>

    <!-- SecciÃ³n de Accesos RÃ¡pidos -->
    <section class="section-accesos">
      <h2>ğŸš€ Accesos RÃ¡pidos</h2>
      <div class="accesos-grid">
        <a href="libros.html" class="acceso-card">
          <div class="acceso-icon">ğŸ“š</div>
          <h3>CatÃ¡logo de Libros</h3>
          <p>Explora nuestra colecciÃ³n completa de libros</p>
        </a>
        <a href="equipos.html" class="acceso-card">
          <div class="acceso-icon">ğŸ’»</div>
          <h3>Equipos TecnolÃ³gicos</h3>
          <p>PortÃ¡tiles, tablets y equipos disponibles</p>
        </a>
        <a href="prestamo.html" class="acceso-card">
          <div class="acceso-icon">ğŸ“–</div>
          <h3>Solicitar PrÃ©stamo</h3>
          <p>Pide prestado un libro o equipo</p>
        </a>
        <a href="mis_prestamos.html" class="acceso-card" id="accesoMisPrestamos" style="display:none;">
          <div class="acceso-icon">ğŸ“‹</div>
          <h3>Mis PrÃ©stamos</h3>
          <p>Consulta tus prÃ©stamos activos</p>
        </a>
      </div>
    </section>
  </main>
  <footer class="pie">
    <a href="#">Listado de editoriales</a>
    <a href="#">Contacto</a>
    <a href="#">Ayuda</a>
  </footer>

<!-- Contenedor de toasts -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<div id="botBubble" style="position: fixed; bottom: 20px; right: 20px; width: 300px; height: 400px; background: #f0f7ff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: none;">
  <div style="padding: 10px; font-size: 14px; font-weight: bold; background: #667eea; color: white; border-radius: 12px 12px 0 0;">Asistente Inteligente</div>
  <div id="botContent" style="padding: 10px; overflow-y: auto; height: calc(100% - 40px);">
    <!-- AquÃ­ se mostrarÃ¡n los mensajes del bot -->
  </div>
</div>
<button id="toggleBot" style="position: fixed; bottom: 20px; right: 20px; background: #667eea; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">ğŸ¤–</button>
<script>
  document.getElementById('toggleBot').addEventListener('click', () => {
    const botBubble = document.getElementById('botBubble');
    botBubble.style.display = botBubble.style.display === 'none' ? 'block' : 'none';
  });
</script>

<script>
(function(){
  // mostrarToast(tipo, mensaje, opciones)
  // tipo: 'success' | 'error' | 'info'
  window.mostrarToast = function(mensaje, tipo='info', opts={duration:3500}) {
    try {
      const container = document.getElementById('toast-container');
      if (!container) return console.warn('No toast container found');
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + (tipo === 'success' ? 'success' : (tipo === 'error' ? 'error' : 'info'));
      toast.innerHTML = '<button class="toast-close" aria-label="Cerrar">&times;</button>'
                      + '<div class="toast-title">'+ (tipo==='success'? 'Ã‰xito' : tipo==='error'? 'Error' : 'InformaciÃ³n') +'</div>'
                      + '<div class="toast-body"></div>';
      toast.querySelector('.toast-body').textContent = mensaje;
      // append and animate
      container.appendChild(toast);
      // force reflow then show
      void toast.offsetWidth;
      toast.classList.add('toast-show');
      // close handler
      toast.querySelector('.toast-close').addEventListener('click', () => {
        hideToast(toast);
      });
      const duration = opts.duration || 3500;
      const timeout = setTimeout(() => hideToast(toast), duration);
      toast.addEventListener('mouseenter', () => clearTimeout(timeout));
      function hideToast(t) {
        if (!t) return;
        t.classList.remove('toast-show');
        setTimeout(()=>{ try{ t.remove(); }catch(e){} }, 260);
      }
    } catch(e) {
      console.error('mostrarToast error', e);
    }
  };
})();
</script>

</body>
<script src="/static/js/main.js" defer></script>
<script src="/static/js/app_helpers.js" defer></script>
<script>
  let categoriaFiltro = '';
  
  // Cargar estadÃ­sticas
  async function cargarEstadisticas() {
    try {
      const res = await fetch('/api/libros');
      if (!res.ok) return;
      const elementos = await res.json();
      const libros = elementos.filter(e => (e.categoria || '').toLowerCase() === 'libros');
      const equipos = elementos.filter(e => {
        const cat = (e.categoria || '').toLowerCase();
        return cat.includes('equipo') || cat.includes('pc') || cat.includes('portÃ¡til');
      });
      const disponibles = elementos.filter(e => (e.cantidad_disponible || 0) > 0);
      
      document.getElementById('totalLibros').textContent = libros.length;
      document.getElementById('totalEquipos').textContent = equipos.length;
      document.getElementById('totalDisponibles').textContent = disponibles.length;
    } catch (e) {
      console.error('Error cargando estadÃ­sticas:', e);
    }
  }
  
  // Cargar libros desde la API y poblar el carrusel (solo los mÃ¡s recientes)
  async function cargarCarrusel() {
    try {
      const res = await fetch('/api/libros');
      if (!res.ok) return;
      const todosLibros = await res.json();
      
      // FILTRAR SOLO LIBROS (excluir equipos/PCs)
      let libros = todosLibros.filter(l => {
        const cat = (l.categoria || '').toLowerCase();
        // Excluir equipos, PCs, tablets, proyectores - solo mostrar libros
        const esEquipo = cat.includes('equipo') || 
                        cat.includes('informÃ¡tico') || 
                        cat.includes('pc') || 
                        cat.includes('portÃ¡til') ||
                        cat === 'tablets' || 
                        cat === 'proyectores' ||
                        cat === 'otros';
        // Solo incluir si NO es equipo Y (es "libros" o estÃ¡ vacÃ­o/categorÃ­a indefinida que podrÃ­a ser libro)
        return !esEquipo && (cat === 'libros' || cat === '' || (!cat.includes('equipo') && !cat.includes('pc')));
      });
      
      // Aplicar filtro de categorÃ­a si existe (solo para libros)
      if (categoriaFiltro) {
        libros = libros.filter(l => {
          const cat = (l.categoria || '').toLowerCase();
          const subcat = (l.subcategoria || '').toLowerCase();
          const filtro = categoriaFiltro.toLowerCase();
          // Si el filtro es especÃ­fico de libros, aplicar
          if (filtro === 'libros' || filtro === 'literatura' || filtro === 'ciencia' || filtro === 'historia' || filtro === 'tecnologÃ­a' || filtro === 'arte') {
            return cat === filtro || subcat === filtro || cat === 'libros';
          }
          return cat === filtro || subcat === filtro;
        });
      }
      
      // Ordenar por fecha de creaciÃ³n (mÃ¡s recientes primero) y tomar solo los Ãºltimos 10
      libros.sort((a, b) => {
        const fechaA = new Date(a.creado_en || 0);
        const fechaB = new Date(b.creado_en || 0);
        return fechaB - fechaA;
      });
      libros = libros.slice(0, 10);
      
      const track = document.getElementById('carouselTrack');
      track.innerHTML = '';
      
      if (libros.length === 0) {
        track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay elementos disponibles en esta categorÃ­a.</div>';
        return;
      }
      
      for (const libro of libros) {
        const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : '/static/uploads/libro1.jpg';
        const disponible = (libro.cantidad_disponible || 0) > 0;
        const art = document.createElement('article');
        art.className = 'book';
        art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
        art.innerHTML = `
          <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}"></div>
          ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">âœ…</div>` : ''}
          <div class="book__overlay">
            <h3>${libro.titulo || ''}</h3>
            <p>${libro.autor || ''}</p>
            <p>${libro.editorial || ''}</p>
            <p>${libro.categoria || ''}</p>
            ${disponible ? `<p style="color:#4caf50; font-weight:600;">âœ… Disponible</p>` : ''}
          </div>`;
        track.appendChild(art);
      }
    } catch (e) {
      console.error('Error cargando carrusel:', e);
    }
  }
  
  function filtrarPorCategoria(cat) {
    categoriaFiltro = cat;
    cargarCarrusel();
    // Cerrar dropdown
    const dropdown = document.querySelector('.dropdown');
    if (dropdown) dropdown.classList.remove('open');
    const menu = document.getElementById('catMenu');
    if (menu) menu.style.display = 'none';
  }
  
  cargarEstadisticas();
  cargarCarrusel();
  
  // Bot de bÃºsqueda inteligente mejorado
  async function buscarLibrosIA(consulta) {
    try {
      const res = await fetch('/api/libros');
      const todosLibros = res.ok ? await res.json() : [];
      
      if (!consulta.trim()) {
        // Si no hay bÃºsqueda, mostrar solo disponibles
        return todosLibros.filter(l => (l.cantidad_disponible || 0) > 0).slice(0, 20);
      }
      
      // BÃºsqueda inteligente: busca en tÃ­tulo, autor, categorÃ­a, subcategorÃ­a, descripciÃ³n
      const palabras = consulta.toLowerCase().split(' ').filter(p => p.length > 0);
      const resultados = todosLibros.filter(libro => {
        const texto = `${libro.titulo || ''} ${libro.autor || ''} ${libro.categoria || ''} ${libro.subcategoria || ''} ${libro.descripcion || ''}`.toLowerCase();
        return palabras.some(pal => texto.includes(pal));
      });
      
      // Ordenar: disponibles primero
      resultados.sort((a, b) => {
        const dispA = (a.cantidad_disponible || 0) > 0 ? 1 : 0;
        const dispB = (b.cantidad_disponible || 0) > 0 ? 1 : 0;
        return dispB - dispA;
      });
      
      return resultados.slice(0, 20);
    } catch (e) {
      return [];
    }
  }

  // Mostrar sugerencias de bÃºsqueda
  function mostrarSugerencias() {
    const sugerencias = [
      'ğŸ’¡ Intenta buscar por: tecnologÃ­a, agricultura, historia, ciencia, literatura',
      'ğŸ” Puedes buscar por categorÃ­a, autor, tÃ­tulo o palabras clave',
      'ğŸ“š Escribe el nombre del libro o autor que buscas'
    ];
    const track = document.getElementById('carouselTrack');
    if (track && track.children.length === 0) {
      track.innerHTML = `<div style="padding:40px; text-align:center; color:#667eea;">
        <h3 style="margin-bottom:16px;">ğŸ” BÃºsqueda Inteligente</h3>
        <div style="font-size:14px; color:#666; line-height:1.8;">
          ${sugerencias.join('<br>')}
        </div>
        <div style="margin-top:20px; padding:12px; background:#e3f2fd; border-radius:8px; font-size:13px;">
          <strong>Ejemplos:</strong><br>
          â€¢ "libros de tecnologÃ­a"<br>
          â€¢ "agricultura"<br>
          â€¢ "ciencia ficciÃ³n"
        </div>
      </div>`;
    }
  }

  async function realizarBusqueda(consulta) {
    const resultados = await buscarLibrosIA(consulta);
    const track = document.getElementById('carouselTrack');
    if (!track) return;
    
    track.innerHTML = '';
    if (resultados.length === 0) {
      track.innerHTML = `<div style="padding:40px; text-align:center; color:#666;">
        <div style="font-size:18px; margin-bottom:12px;">ğŸ” No se encontraron libros</div>
        <div style="font-size:14px; color:#999; margin-bottom:16px;">Intenta con otras palabras clave</div>
        <div style="background:#f0f7ff; padding:16px; border-radius:8px; text-align:left; max-width:400px; margin:0 auto;">
          <strong>ğŸ’¡ Sugerencias:</strong><br>
          â€¢ Busca por categorÃ­a: tecnologÃ­a, historia, ciencia<br>
          â€¢ Busca por autor o tÃ­tulo<br>
          â€¢ Intenta palabras mÃ¡s generales
        </div>
      </div>`;
      return;
    }
    
    // Mostrar contador de resultados
    const contador = document.createElement('div');
    contador.style.cssText = 'padding:12px; background:#e3f2fd; border-radius:8px; margin-bottom:16px; text-align:center; font-weight:600; color:#1976d2;';
    contador.textContent = `ğŸ“š ${resultados.length} resultado(s) encontrado(s)${consulta ? ` para "${consulta}"` : ''}`;
    track.appendChild(contador);
    
    for (const libro of resultados) {
      const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : '/static/uploads/libro1.jpg';
      const disponible = (libro.cantidad_disponible || 0) > 0;
      const art = document.createElement('article');
      art.className = 'book';
      art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
      art.innerHTML = `
        <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}"></div>
        <div style="position:absolute; top:8px; right:8px; background:${disponible ? '#4caf50' : '#f44336'}; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">
          ${disponible ? 'âœ… Disponible' : 'âŒ Agotado'}
        </div>
        <div class="book__overlay">
          <h3>${libro.titulo || ''}</h3>
          <p>${libro.autor || ''}</p>
          <p>${libro.editorial || ''}</p>
          <p>${libro.categoria || ''}</p>
          ${disponible ? `<p style="color:#4caf50; font-weight:600;">âœ… ${libro.cantidad_disponible || 0} disponible(s)</p>` : ''}
        </div>`;
      track.appendChild(art);
    }
  }

  document.getElementById('btnBuscarLibros')?.addEventListener('click', () => {
    const input = document.getElementById('buscadorInput');
    if (input) {
      const valor = input.value.trim();
      if (valor) {
        realizarBusqueda(valor);
      } else {
        // Si estÃ¡ vacÃ­o, mostrar todos
        cargarCarrusel();
      }
    }
  });

  document.getElementById('buscadorInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const valor = e.target.value.trim();
      if (valor) {
        realizarBusqueda(valor);
      } else {
        cargarCarrusel();
      }
    }
  });

  // Mostrar sugerencias si no hay bÃºsqueda
  setTimeout(mostrarSugerencias, 1000);

  // Mostrar link Admin y agregar libro solo si es admin
  // Mostrar mensajes para usuarios logueados
  (function(){
    const t = localStorage.getItem('token');
    if (t === 'admin-token') {
      const l = document.getElementById('adminLink');
      if (l) l.style.display = 'inline-block';
      const linkLibro = document.getElementById('linkLibro');
      if (linkLibro) linkLibro.style.display = 'inline-block';
    } else if (t && t.startsWith('user-')) {
      const linkMensajes = document.getElementById('linkMensajes');
      if (linkMensajes) linkMensajes.style.display = 'inline-block';
      const linkMisPrestamos = document.getElementById('linkMisPrestamos');
      if (linkMisPrestamos) linkMisPrestamos.style.display = 'inline-block';
      const accesoMisPrestamos = document.getElementById('accesoMisPrestamos');
      if (accesoMisPrestamos) accesoMisPrestamos.style.display = 'block';
    }
    
    // Cargar nombre de usuario
    async function cargarNombreUsuario() {
      const token = localStorage.getItem('token');
      const nombreEl = document.getElementById('nombreUsuario');
      if (!nombreEl) return;
      
      // Intentar desde localStorage
      const userData = localStorage.getItem('userData');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          if (user.name || user.nombre) {
            nombreEl.textContent = user.name || user.nombre;
            return;
          }
        } catch (e) {}
      }
      
      // Si hay token, intentar obtener desde API
      if (token && token.startsWith('user-')) {
        const userId = token.replace('user-', '');
        try {
          const res = await fetch(`/api/usuarios/${userId}`);
          if (res.ok) {
            const user = await res.json();
            if (user.nombre) {
              nombreEl.textContent = user.nombre;
              // Guardar en localStorage
              localStorage.setItem('userData', JSON.stringify({ name: user.nombre, id: user.id }));
            }
          }
        } catch (e) {
          console.error('Error cargando usuario:', e);
        }
      } else if (token === 'admin-token') {
        nombreEl.textContent = 'Administrador';
      }
    }
    
    // Configurar menÃº de usuario
    function configurarMenuUsuario() {
      const container = document.getElementById('usuarioContainer');
      const menu = document.getElementById('usuarioMenu');
      const linkPerfil = document.getElementById('linkPerfil');
      const linkCerrar = document.getElementById('linkCerrarSesion');
      
      if (!container || !menu) return;
      
      // Toggle menÃº al hacer clic
      container.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menu.style.display === 'block';
        if (isOpen) {
          menu.style.display = 'none';
        } else {
          // Calcular posiciÃ³n del menÃº
          const rect = container.getBoundingClientRect();
          menu.style.display = 'block';
          menu.style.position = 'fixed';
          menu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
          menu.style.right = (window.innerWidth - rect.right) + 'px';
          menu.style.zIndex = '999999';
        }
      });
      
      // Cerrar menÃº al hacer clic fuera
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target) && !menu.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
      
      // Evitar que el clic en el menÃº lo cierre
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // AcciÃ³n cerrar sesiÃ³n
      if (linkCerrar) {
        linkCerrar.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('userData');
            localStorage.removeItem('miId');
            // Cerrar menÃº primero
            menu.style.display = 'none';
            // Luego redirigir sin sobreposiciÃ³n
            setTimeout(() => {
              window.location.replace('login.html');
            }, 100);
          }
        });
      }
      
      // AcciÃ³n perfil
      if (linkPerfil) {
        linkPerfil.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.location.href = 'perfil.html';
        });
      }
      
      // AcciÃ³n favoritos
      const linkFavoritos = document.getElementById('linkFavoritos');
      if (linkFavoritos) {
        linkFavoritos.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.location.href = 'favoritos.html';
        });
      }
    }
    
    cargarNombreUsuario();
    configurarMenuUsuario();
  })();
</script>
</html>


