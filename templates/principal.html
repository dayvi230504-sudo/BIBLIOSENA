<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca SENA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">

<style>
/* Toasts - bottom-right */
#toast-container {
  position: fixed;
  right: 20px;
  bottom: 100px;
  z-index: 2147483646;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: flex-end;
  pointer-events: none; /* allow clicks through when no toasts */
}
.toast {
  min-width: 260px;
  max-width: 360px;
  padding: 12px 16px;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  transform: translateY(16px);
  opacity: 0;
  transition: transform 260ms ease, opacity 260ms ease;
  pointer-events: auto;
}
.toast-show {
  transform: translateY(0);
  opacity: 1;
}
.toast-success { background: linear-gradient(90deg,#2ecc71,#27ae60); }
.toast-error   { background: linear-gradient(90deg,#e74c3c,#c0392b); }
.toast-info    { background: linear-gradient(90deg,#3498db,#2c82d6); }
.toast .toast-title {
  font-weight: 600;
  margin-bottom: 4px;
}
.toast .toast-body {
  opacity: 0.95;
  line-height: 1.2;
}
.toast-close {
  position: absolute;
  top: 6px;
  right: 8px;
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.9);
  font-size: 16px;
  cursor: pointer;
}
</style>

</head>
<body>

  {% set active_page = 'inicio' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarPrincipal' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <!-- Secci√≥n Hero / Presentaci√≥n -->
    <section class="hero-section">
      <div class="hero-layout">
        <div class="hero-content">
          <span class="hero-chip">üöÄ Biblioteca inteligente</span>
          <h1 class="hero-title">Explora, aprende y comparte con <span>BIBLIOSENA</span></h1>
          <p class="hero-subtitle">Inicia tu b√∫squeda entre cientos de libros, equipos y recursos creados para potenciar tu formaci√≥n en el SENA.</p>
          <div class="hero-actions">
            <a href="libros.html" class="btn-hero btn-primary">Explorar cat√°logos</a>
            <a href="prestamo.html" class="btn-hero btn-secondary">Solicitar pr√©stamo</a>
          </div>
          <div class="hero-perks">
            <div class="hero-perk">
              <span>‚ö°</span>
              <div>
                <strong>Acceso inmediato</strong>
                <small>Gesti√≥n en l√≠nea desde cualquier dispositivo</small>
              </div>
            </div>
            <div class="hero-perk">
              <span>ü§ñ</span>
              <div>
                <strong>Asistente inteligente</strong>
                <small>Encuentra resultados personalizados</small>
              </div>
            </div>
          </div>
        </div>
        <div class="hero-visual">
          <div class="hero-card hero-card--stats">
            <h3>Disponibilidad en tiempo real</h3>
            <div class="hero-stat-grid">
              <div>
                <span id="totalLibros" class="stat-number">-</span>
                <p>Libros totales</p>
              </div>
              <div>
                <span id="librosActivos" class="stat-number">-</span>
                <p>Libros disponibles</p>
              </div>
              <div>
                <span id="totalEquipos" class="stat-number">-</span>
                <p>Equipos totales</p>
              </div>
              <div>
                <span id="equiposActivos" class="stat-number">-</span>
                <p>Equipos disponibles</p>
              </div>
            </div>
          </div>
          <div class="hero-card hero-card--quote">
            <p>‚ÄúUna biblioteca en l√≠nea es una puerta abierta a nuevas oportunidades de aprendizaje.‚Äù</p>
            <small>‚Äî Comunidad SENA</small>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n de Nuevos T√≠tulos -->
    <section class="section-novedades">
      <div class="section-header">
        <h2>‚ú® Nuevos T√≠tulos</h2>
        <p class="section-description">Descubre los √∫ltimos libros agregados a nuestra colecci√≥n</p>
      </div>
      <div class="carousel-container">
        <section class="carousel" aria-label="Carrusel de libros">
          <button type="button" class="carousel__btn carousel__btn--prev" id="prevBtn" aria-label="Anterior">‚ùÆ</button>
          <div class="carousel__viewport" id="carouselViewport">
            <div class="carousel__track" id="carouselTrack"></div>
          </div>
          <button type="button" class="carousel__btn carousel__btn--next" id="nextBtn" aria-label="Siguiente">‚ùØ</button>
        </section>
      </div>
    </section>

    <!-- Secci√≥n de Accesos R√°pidos -->
    <section class="section-accesos">
      <h2>üî• Accesos r√°pidos</h2>
      <div class="accesos-grid">
        <a href="libros.html" class="acceso-card">
          <div class="acceso-icon">üìö</div>
          <h3>Cat√°logo de Libros</h3>
          <p>Explora nuestra colecci√≥n completa de libros</p>
        </a>
        <a href="equipos.html" class="acceso-card">
          <div class="acceso-icon">üíª</div>
          <h3>Equipos Tecnol√≥gicos</h3>
          <p>Port√°tiles, tablets y equipos disponibles</p>
        </a>
        <a href="prestamo.html" class="acceso-card">
          <div class="acceso-icon">üìñ</div>
          <h3>Solicitar Pr√©stamo</h3>
          <p>Pide prestado un libro o equipo</p>
        </a>
        <a href="mis_prestamos.html" class="acceso-card" id="accesoMisPrestamos" style="display:none;">
          <div class="acceso-icon">üìã</div>
          <h3>Mis Pr√©stamos</h3>
          <p>Consulta tus pr√©stamos activos</p>
        </a>
      </div>
    </section>

    <section class="section-inspiracion">
      <div class="inspiracion-card">
        <h2>üåü Explora por intereses</h2>
        <p>Selecciona una tem√°tica e inicia un viaje de aprendizaje curado para tus proyectos.</p>
        <div class="inspiracion-tags">
          <button onclick="filtrarPorCategoria('Tecnolog√≠a')">#Tecnolog√≠a</button>
          <button onclick="filtrarPorCategoria('Emprendimiento')">#Emprendimiento</button>
          <button onclick="filtrarPorCategoria('Control Ambiental')">#Ambiental</button>
          <button onclick="filtrarPorCategoria('Dise√±o')">#Dise√±o</button>
          <button onclick="filtrarPorCategoria('Agricultura')">#Agro</button>
        </div>
      </div>
      <div class="inspiracion-card inspiracion-card--light">
        <h3>¬øNo sabes por d√≥nde empezar?</h3>
        <p>Abre el asistente ü§ñ y p√≠dele recomendaciones con base en tus metas. Siempre hay algo nuevo por descubrir.</p>
        <a href="#" onclick="document.getElementById('toggleBot')?.click(); return false;" class="btn-link">Hablar con el asistente</a>
      </div>
    </section>
  </main>
  <footer class="pie">
    <a href="#">Listado de editoriales</a>
    <a href="#">Contacto</a>
    <a href="#">Ayuda</a>
  </footer>

<!-- Contenedor de toasts -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<div id="botBubble" style="position: fixed; bottom: 80px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: none; z-index: 2147483647; flex-direction: column; overflow: hidden;">
  <div style="padding: 16px; font-size: 16px; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
    <span>ü§ñ Asistente Inteligente</span>
    <button id="cerrarBot" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
  </div>
  <div id="botContent" style="padding: 16px; overflow-y: auto; flex: 1; background: #f9fafb;">
    <!-- Aqu√≠ se mostrar√°n los mensajes del bot -->
  </div>
  <form id="formBot" style="padding: 12px; border-top: 1px solid #e5e7eb; background: white; display: flex; gap: 8px;">
    <input type="text" id="inputBot" placeholder="Escribe tu pregunta..." style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 20px; font-size: 14px; outline: none;" autocomplete="off">
    <button type="submit" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">‚û§</button>
  </form>
</div>
<button id="toggleBot" style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2147483646; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;">ü§ñ</button>
<script>
  // Funci√≥n para agregar mensaje al chat
  function agregarMensajeBot(autor, mensaje, esIA = false) {
    const chat = document.getElementById('botContent');
    if (!chat) return;
    
    const hora = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    const div = document.createElement('div');
    div.style.cssText = `margin-bottom: 12px; display: flex; ${esIA ? 'justify-content: flex-start;' : 'justify-content: flex-end;'}`;
    
    const mensajeDiv = document.createElement('div');
    mensajeDiv.style.cssText = `max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; ${
      esIA 
        ? 'background: #e3f2fd; color: #1976d2; border-bottom-left-radius: 4px;' 
        : 'background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-bottom-right-radius: 4px;'
    }`;
    
    mensajeDiv.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 4px; font-size: 12px; opacity: 0.8;">
        ${esIA ? 'ü§ñ Asistente' : 'üë§ T√∫'} - ${hora}
      </div>
      <div>${mensaje}</div>
    `;
    
    div.appendChild(mensajeDiv);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // Funci√≥n para procesar consultas del bot
  async function procesarConsultaBot(consulta) {
    const texto = consulta.toLowerCase().trim();
    
    // Ayuda
    if (texto.includes('ayuda') || texto === '?' || texto === 'help') {
      return `¬°Hola! Soy tu asistente de biblioteca. Puedo ayudarte con:<br><br>
        ‚Ä¢ <strong>Buscar libros</strong>: Escribe el t√≠tulo, autor o categor√≠a<br>
        ‚Ä¢ <strong>Pr√©stamos</strong>: Pregunta sobre tus pr√©stamos<br>
        ‚Ä¢ <strong>Disponibilidad</strong>: Consulta qu√© hay disponible<br>
        ‚Ä¢ <strong>Informaci√≥n</strong>: Preg√∫ntame sobre la biblioteca<br><br>
        Solo escribe tu pregunta de forma natural y te ayudar√©.`;
    }
    
    // B√∫squeda de libros
    if (texto.includes('buscar') || texto.includes('libro') || texto.includes('encontrar') || texto.length > 3) {
      const resultados = await buscarLibrosIA(consulta);
      if (resultados.length === 0) {
        return `No encontr√© libros que coincidan con "${consulta}". Intenta con otras palabras clave o escribe "ayuda" para m√°s informaci√≥n.`;
      }
      let respuesta = `Encontr√© <strong>${resultados.length}</strong> resultado(s):<br><br>`;
      resultados.slice(0, 5).forEach(libro => {
        const disponible = (libro.cantidad_disponible || 0) > 0;
        respuesta += `üìö <strong>${libro.titulo || 'Sin t√≠tulo'}</strong><br>`;
        if (libro.autor) respuesta += `   Autor: ${libro.autor}<br>`;
        respuesta += `   ${disponible ? '‚úÖ Disponible' : '‚ùå No disponible'}<br><br>`;
      });
      if (resultados.length > 5) {
        respuesta += `... y ${resultados.length - 5} m√°s. Busca en el cat√°logo para ver todos.`;
      }
      return respuesta;
    }
    
    // Pr√©stamos
    if (texto.includes('pr√©stamo') || texto.includes('prestamo') || texto.includes('tengo prestado')) {
      const token = localStorage.getItem('token');
      if (!token || !token.startsWith('user-')) {
        return 'Para consultar tus pr√©stamos, primero debes iniciar sesi√≥n.';
      }
      try {
        const userId = token.replace('user-', '');
        const res = await fetch(`/api/prestamos?usuario_id=${userId}`);
        if (res.ok) {
          const prestamos = await res.json();
          if (prestamos.length === 0) {
            return 'No tienes pr√©stamos registrados en este momento.';
          }
          const activos = prestamos.filter(p => p.estado === 'aprobado');
          let respuesta = `Tienes <strong>${prestamos.length}</strong> pr√©stamo(s) en total:<br><br>`;
          if (activos.length > 0) {
            respuesta += `<strong>Pr√©stamos activos (${activos.length}):</strong><br>`;
            activos.slice(0, 3).forEach(p => {
              respuesta += `üìñ ${p.titulo || 'Elemento'} - Devoluci√≥n: ${p.fecha_devolucion || 'No definida'}<br>`;
            });
          }
          return respuesta;
        }
      } catch (e) {
        return 'Error al obtener tus pr√©stamos. Intenta m√°s tarde.';
      }
    }
    
    // Respuesta por defecto
    return `Entiendo que buscas informaci√≥n sobre "${consulta}". Puedo ayudarte a buscar libros, consultar pr√©stamos o responder dudas sobre la biblioteca. Escribe "ayuda" para ver todas las opciones disponibles.`;
  }

  // Configurar bot flotante
  const toggleBot = document.getElementById('toggleBot');
  const botBubble = document.getElementById('botBubble');
  const cerrarBot = document.getElementById('cerrarBot');
  const formBot = document.getElementById('formBot');
  const inputBot = document.getElementById('inputBot');

  if (toggleBot && botBubble) {
    toggleBot.addEventListener('click', () => {
      const isVisible = botBubble.style.display !== 'none';
      if (isVisible) {
        botBubble.style.display = 'none';
        toggleBot.style.transform = 'scale(1)';
      } else {
        botBubble.style.display = 'flex';
        toggleBot.style.transform = 'scale(0.9)';
        // Mostrar mensaje de bienvenida si est√° vac√≠o
        if (botBubble.querySelector('#botContent').children.length === 0) {
          agregarMensajeBot('ia', '¬°Hola! Soy tu asistente de biblioteca. Puedes preguntarme sobre libros, pr√©stamos o escribir "ayuda" para ver todos los comandos disponibles. üòä', true);
        }
        // Enfocar el input
        setTimeout(() => inputBot?.focus(), 100);
      }
    });
  }

  if (cerrarBot && botBubble && toggleBot) {
    cerrarBot.addEventListener('click', () => {
      botBubble.style.display = 'none';
      toggleBot.style.transform = 'scale(1)';
    });
  }

  if (formBot && inputBot) {
    formBot.addEventListener('submit', async (e) => {
      e.preventDefault();
      const consulta = inputBot.value.trim();
      if (!consulta) return;
      
      // Mostrar pregunta del usuario
      agregarMensajeBot('usuario', consulta, false);
      inputBot.value = '';
      
      // Procesar consulta y mostrar respuesta
      const respuesta = await procesarConsultaBot(consulta);
      agregarMensajeBot('ia', respuesta, true);
      
      // Enfocar el input de nuevo
      setTimeout(() => inputBot.focus(), 100);
    });
  }
</script>

<script>
(function(){
  // mostrarToast(tipo, mensaje, opciones)
  // tipo: 'success' | 'error' | 'info'
  window.mostrarToast = function(mensaje, tipo='info', opts={duration:3500}) {
    try {
      const container = document.getElementById('toast-container');
      if (!container) return console.warn('No toast container found');
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + (tipo === 'success' ? 'success' : (tipo === 'error' ? 'error' : 'info'));
      toast.innerHTML = '<button class="toast-close" aria-label="Cerrar">&times;</button>'
                      + '<div class="toast-title">'+ (tipo==='success'? '√âxito' : tipo==='error'? 'Error' : 'Informaci√≥n') +'</div>'
                      + '<div class="toast-body"></div>';
      toast.querySelector('.toast-body').textContent = mensaje;
      // append and animate
      container.appendChild(toast);
      // force reflow then show
      void toast.offsetWidth;
      toast.classList.add('toast-show');
      // close handler
      toast.querySelector('.toast-close').addEventListener('click', () => {
        hideToast(toast);
      });
      const duration = opts.duration || 3500;
      const timeout = setTimeout(() => hideToast(toast), duration);
      toast.addEventListener('mouseenter', () => clearTimeout(timeout));
      function hideToast(t) {
        if (!t) return;
        t.classList.remove('toast-show');
        setTimeout(()=>{ try{ t.remove(); }catch(e){} }, 260);
      }
    } catch(e) {
      console.error('mostrarToast error', e);
    }
  };
})();
</script>

</body>
<script src="/static/js/main.js" defer></script>
<script src="/static/js/app_helpers.js" defer></script>
<script>
  let categoriaFiltro = '';
  
  // Cargar estad√≠sticas
  async function cargarEstadisticas() {
    try {
      const res = await fetch('/api/libros');
      if (!res.ok) {
        console.error('Error al obtener elementos:', res.status);
        return;
      }
      const elementos = await res.json();
      
      if (!elementos || elementos.length === 0) {
        console.log('No hay elementos en la respuesta');
        return;
      }
      
      // Separar libros y equipos
      const libros = elementos.filter(e => {
        const cat = (e.categoria || '').toLowerCase();
        return cat === 'libros' || (!cat.includes('equipo') && !cat.includes('pc') && !cat.includes('port√°til') && !cat.includes('desktop') && !cat.includes('tablet') && !cat.includes('proyector') && !cat.includes('inform√°tico'));
      });
      
      const equipos = elementos.filter(e => {
        const cat = (e.categoria || '').toLowerCase();
        return cat.includes('equipo') || cat.includes('inform√°tico') || cat.includes('pc') || cat.includes('port√°til') || cat.includes('desktop') || cat.includes('tablet') || cat.includes('proyector');
      });
      
      // Calcular totales: sumar stock de todos los elementos
      let totalLibros = 0;
      let totalEquipos = 0;
      let librosActivos = 0; // Disponibles = stock - prestados
      let equiposActivos = 0;
      
      // Sumar totales y activos de libros
      libros.forEach(libro => {
        const stock = parseInt(libro.stock || 0);
        const disponibles = parseInt(libro.cantidad_disponible || 0);
        totalLibros += stock;
        librosActivos += disponibles;
      });
      
      // Sumar totales y activos de equipos
      equipos.forEach(equipo => {
        const stock = parseInt(equipo.stock || 0);
        const disponibles = parseInt(equipo.cantidad_disponible || 0);
        totalEquipos += stock;
        equiposActivos += disponibles;
      });
      
      // Mostrar estad√≠sticas
      document.getElementById('totalLibros').textContent = totalLibros;
      document.getElementById('totalEquipos').textContent = totalEquipos;
      document.getElementById('librosActivos').textContent = librosActivos;
      document.getElementById('equiposActivos').textContent = equiposActivos;
      
      console.log('Estad√≠sticas cargadas:', {
        totalLibros,
        totalEquipos,
        librosActivos,
        equiposActivos,
        librosCount: libros.length,
        equiposCount: equipos.length
      });
    } catch (e) {
      console.error('Error cargando estad√≠sticas:', e);
    }
  }
  
  // Cargar libros desde la API y poblar el carrusel (solo los m√°s recientes)
  async function cargarCarrusel() {
    try {
      const res = await fetch('/api/libros');
      if (!res.ok) return;
      const todosLibros = await res.json();
      
      // FILTRAR SOLO LIBROS (excluir equipos/PCs)
      let libros = todosLibros.filter(l => {
        const cat = (l.categoria || '').toLowerCase();
        // Excluir equipos, PCs, tablets, proyectores - solo mostrar libros
        const esEquipo = cat.includes('equipo') || 
                        cat.includes('inform√°tico') || 
                        cat.includes('pc') || 
                        cat.includes('port√°til') ||
                        cat === 'tablets' || 
                        cat === 'proyectores' ||
                        cat === 'otros';
        // Solo incluir si NO es equipo Y (es "libros" o est√° vac√≠o/categor√≠a indefinida que podr√≠a ser libro)
        return !esEquipo && (cat === 'libros' || cat === '' || (!cat.includes('equipo') && !cat.includes('pc')));
      });
      
      // Aplicar filtro de categor√≠a si existe (solo para libros)
      if (categoriaFiltro) {
        libros = libros.filter(l => {
          const cat = (l.categoria || '').toLowerCase();
          const subcat = (l.subcategoria || '').toLowerCase();
          const filtro = categoriaFiltro.toLowerCase();
          // Si el filtro es espec√≠fico de libros, aplicar
          if (filtro === 'libros' || filtro === 'literatura' || filtro === 'ciencia' || filtro === 'historia' || filtro === 'tecnolog√≠a' || filtro === 'arte') {
            return cat === filtro || subcat === filtro || cat === 'libros';
          }
          return cat === filtro || subcat === filtro;
        });
      }
      
      // Ordenar por fecha de creaci√≥n (m√°s recientes primero) y tomar solo los √∫ltimos 10
      libros.sort((a, b) => {
        const fechaA = new Date(a.creado_en || 0);
        const fechaB = new Date(b.creado_en || 0);
        return fechaB - fechaA;
      });
      libros = libros.slice(0, 10);
      
      const track = document.getElementById('carouselTrack');
      track.innerHTML = '';
      
      if (libros.length === 0) {
        track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay elementos disponibles en esta categor√≠a.</div>';
        return;
      }
      
      const placeholder = '/static/img/placeholder-book.svg';
      for (const libro of libros) {
        const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : placeholder;
        const disponible = (libro.cantidad_disponible || 0) > 0;
        const art = document.createElement('article');
        art.className = 'book';
        art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
        art.innerHTML = `
        <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}" onerror="this.src='${placeholder}'"></div>
          ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">‚úÖ</div>` : ''}
          <div class="book__overlay">
            <h3>${libro.titulo || ''}</h3>
            <p>${libro.autor || ''}</p>
            <p>${libro.editorial || ''}</p>
            <p>${libro.categoria || ''}</p>
            ${disponible ? `<p style="color:#4caf50; font-weight:600;">‚úÖ Disponible</p>` : ''}
          </div>`;
        track.appendChild(art);
      }
    } catch (e) {
      console.error('Error cargando carrusel:', e);
    }
  }
  
  function filtrarPorCategoria(cat) {
    categoriaFiltro = cat;
    cargarCarrusel();
    // Cerrar dropdown
    const dropdown = document.querySelector('.dropdown');
    if (dropdown) dropdown.classList.remove('open');
    const menu = document.getElementById('catMenu');
    if (menu) menu.style.display = 'none';
  }
  
  cargarEstadisticas();
  cargarCarrusel();
  
  // Bot de b√∫squeda inteligente mejorado
  async function buscarLibrosIA(consulta) {
    try {
      const res = await fetch('/api/libros');
      const todosLibros = res.ok ? await res.json() : [];
      
      if (!consulta.trim()) {
        // Si no hay b√∫squeda, mostrar solo disponibles
        return todosLibros.filter(l => (l.cantidad_disponible || 0) > 0).slice(0, 20);
      }
      
      // B√∫squeda inteligente: busca en t√≠tulo, autor, categor√≠a, subcategor√≠a, descripci√≥n
      const palabras = consulta.toLowerCase().split(' ').filter(p => p.length > 0);
      const resultados = todosLibros.filter(libro => {
        const texto = `${libro.titulo || ''} ${libro.autor || ''} ${libro.categoria || ''} ${libro.subcategoria || ''} ${libro.descripcion || ''}`.toLowerCase();
        return palabras.some(pal => texto.includes(pal));
      });
      
      // Ordenar: disponibles primero
      resultados.sort((a, b) => {
        const dispA = (a.cantidad_disponible || 0) > 0 ? 1 : 0;
        const dispB = (b.cantidad_disponible || 0) > 0 ? 1 : 0;
        return dispB - dispA;
      });
      
      return resultados.slice(0, 20);
    } catch (e) {
      return [];
    }
  }

  // Mostrar sugerencias de b√∫squeda
  function mostrarSugerencias() {
    const sugerencias = [
      'üí° Intenta buscar por: tecnolog√≠a, agricultura, historia, ciencia, literatura',
      'üîç Puedes buscar por categor√≠a, autor, t√≠tulo o palabras clave',
      'üìö Escribe el nombre del libro o autor que buscas'
    ];
    const track = document.getElementById('carouselTrack');
    if (track && track.children.length === 0) {
      track.innerHTML = `<div style="padding:40px; text-align:center; color:#667eea;">
        <h3 style="margin-bottom:16px;">üîç B√∫squeda Inteligente</h3>
        <div style="font-size:14px; color:#666; line-height:1.8;">
          ${sugerencias.join('<br>')}
        </div>
        <div style="margin-top:20px; padding:12px; background:#e3f2fd; border-radius:8px; font-size:13px;">
          <strong>Ejemplos:</strong><br>
          ‚Ä¢ "libros de tecnolog√≠a"<br>
          ‚Ä¢ "agricultura"<br>
          ‚Ä¢ "ciencia ficci√≥n"
        </div>
      </div>`;
    }
  }

  async function realizarBusqueda(consulta) {
    const resultados = await buscarLibrosIA(consulta);
    const track = document.getElementById('carouselTrack');
    if (!track) return;
    
    track.innerHTML = '';
    if (resultados.length === 0) {
      track.innerHTML = `<div style="padding:40px; text-align:center; color:#666;">
        <div style="font-size:18px; margin-bottom:12px;">üîç No se encontraron libros</div>
        <div style="font-size:14px; color:#999; margin-bottom:16px;">Intenta con otras palabras clave</div>
        <div style="background:#f0f7ff; padding:16px; border-radius:8px; text-align:left; max-width:400px; margin:0 auto;">
          <strong>üí° Sugerencias:</strong><br>
          ‚Ä¢ Busca por categor√≠a: tecnolog√≠a, historia, ciencia<br>
          ‚Ä¢ Busca por autor o t√≠tulo<br>
          ‚Ä¢ Intenta palabras m√°s generales
        </div>
      </div>`;
      return;
    }
    
    // Mostrar contador de resultados
    const contador = document.createElement('div');
    contador.style.cssText = 'padding:12px; background:#e3f2fd; border-radius:8px; margin-bottom:16px; text-align:center; font-weight:600; color:#1976d2;';
    contador.textContent = `üìö ${resultados.length} resultado(s) encontrado(s)${consulta ? ` para "${consulta}"` : ''}`;
    track.appendChild(contador);
    
    for (const libro of resultados) {
      const placeholder = '/static/img/placeholder-book.svg';
      const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : placeholder;
      const disponible = (libro.cantidad_disponible || 0) > 0;
      const art = document.createElement('article');
      art.className = 'book';
      art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
      art.innerHTML = `
        <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}" onerror="this.src='${placeholder}'"></div>
        <div style="position:absolute; top:8px; right:8px; background:${disponible ? '#4caf50' : '#f44336'}; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">
          ${disponible ? '‚úÖ Disponible' : '‚ùå Agotado'}
        </div>
        <div class="book__overlay">
          <h3>${libro.titulo || ''}</h3>
          <p>${libro.autor || ''}</p>
          <p>${libro.editorial || ''}</p>
          <p>${libro.categoria || ''}</p>
          ${disponible ? `<p style="color:#4caf50; font-weight:600;">‚úÖ ${libro.cantidad_disponible || 0} disponible(s)</p>` : ''}
        </div>`;
      track.appendChild(art);
    }
  }

  document.getElementById('btnBuscarLibros')?.addEventListener('click', () => {
    const input = document.getElementById('buscadorInput');
    if (input) {
      const valor = input.value.trim();
      if (valor) {
        realizarBusqueda(valor);
      } else {
        // Si est√° vac√≠o, mostrar todos
        cargarCarrusel();
      }
    }
  });

  document.getElementById('buscadorInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const valor = e.target.value.trim();
      if (valor) {
        realizarBusqueda(valor);
      } else {
        cargarCarrusel();
      }
    }
  });

  // Mostrar sugerencias si no hay b√∫squeda
  setTimeout(mostrarSugerencias, 1000);

  window.initializeTopbar && window.initializeTopbar();
</script>
</html>


