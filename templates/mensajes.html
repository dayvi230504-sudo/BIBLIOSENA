<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mensajes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
  <style>
    .inbox-container {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 20px 48px rgba(15, 37, 77, 0.12);
      border: 1px solid rgba(102,126,234,0.12);
      overflow: hidden;
      min-height: 540px;
    }
    .inbox-sidebar {
      background: linear-gradient(165deg, #f5f7ff, #eef1ff);
      border-right: 1px solid rgba(102,126,234,0.15);
      display: flex;
      flex-direction: column;
    }
    .inbox-sidebar__header {
      padding: 24px;
      border-bottom: 1px solid rgba(102,126,234,0.12);
    }
    .inbox-sidebar__header h2 {
      margin: 0;
      font-size: 18px;
      color: #1c2751;
    }
    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .conversation-card {
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(102,126,234,0.14);
      border-radius: 16px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
    }
    .conversation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(102,126,234,0.15);
    }
    .conversation-card.is-active {
      border-color: rgba(102,126,234,0.55);
      box-shadow: 0 18px 36px rgba(102,126,234,0.18);
      background: #ffffff;
    }
    .conversation-card__name {
      font-weight: 700;
      color: #28345c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .conversation-card__preview {
      font-size: 13px;
      color: #5a6685;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .badge-pill {
      background: rgba(102,126,234,0.18);
      color: #394a8a;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .badge-pill--alert {
      background: rgba(244,67,54,0.18);
      color: #b71c1c;
    }
    .chat-panel {
      display: flex;
      flex-direction: column;
      background: #f9faff;
    }
    .chat-panel__header {
      padding: 24px;
      border-bottom: 1px solid rgba(102,126,234,0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .chat-panel__title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #1c2751;
    }
    .chat-panel__subtitle {
      font-size: 13px;
      color: #5f6f92;
    }
    .chat-panel__messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 14px 16px;
      border-radius: 18px;
      background: #ffffff;
      border: 1px solid rgba(102,126,234,0.12);
      box-shadow: 0 12px 24px rgba(15,37,77,0.08);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #1d284f;
    }
    .chat-bubble--self {
      margin-left: auto;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #ffffff;
      border: none;
      box-shadow: 0 14px 32px rgba(102,126,234,0.35);
    }
    .chat-bubble__meta {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
    }
    .chat-bubble__text {
      font-size: 14px;
      line-height: 1.5;
    }
    .chat-bubble__status {
      font-size: 11px;
      opacity: 0.65;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .chat-empty-state {
      margin: auto;
      text-align: center;
      color: #5a6685;
      max-width: 320px;
      line-height: 1.6;
    }
    .chat-empty-state strong {
      display: block;
      font-size: 18px;
      color: #1c2751;
      margin-bottom: 8px;
    }
    .chat-composer {
      padding: 20px 24px;
      border-top: 1px solid rgba(102,126,234,0.12);
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .composer-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .composer-row label {
      font-size: 12px;
      font-weight: 600;
      color: #39476b;
    }
    .composer-row input,
    .composer-row textarea {
      border: 1px solid rgba(102,126,234,0.25);
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
      background: rgba(249,250,255,0.9);
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    .composer-row input:focus,
    .composer-row textarea:focus {
      outline: none;
      border-color: rgba(102,126,234,0.6);
      box-shadow: 0 0 0 3px rgba(102,126,234,0.18);
      background: #ffffff;
    }
    .chat-composer__actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .chat-composer__actions button {
      border: none;
      border-radius: 14px;
      padding: 12px 24px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #42a5f5, #7b61ff);
      color: #ffffff;
      box-shadow: 0 14px 32px rgba(66,165,245,0.28);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chat-composer__actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(66,165,245,0.35);
    }
    .chat-composer__hint {
      font-size: 12px;
      color: #6b7b93;
    }
    @media (max-width: 1024px) {
      .inbox-container {
        grid-template-columns: 1fr;
        min-height: auto;
      }
      .inbox-sidebar {
        border-right: none;
        border-bottom: 1px solid rgba(102,126,234,0.12);
      }
      .conversation-list {
        flex-direction: row;
        overflow-x: auto;
        gap: 14px;
      }
      .conversation-card {
        min-width: 220px;
      }
    }
    @media (max-width: 640px) {
      .chat-composer__actions {
        flex-direction: column;
        align-items: stretch;
      }
      .chat-composer__actions button {
        width: 100%;
      }
      .chat-panel__messages {
        padding: 18px;
      }
      .chat-bubble {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  {% set active_page = 'mensajes' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarMensajes' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <h1 class="page-title">üí¨ Mensajes y soporte</h1>
    <p style="color:#5f6f92; margin:-6px 0 24px 0;">Centraliza todas tus conversaciones con el administrador o con otros usuarios conectados por soporte.</p>

    <section class="inbox-container">
      <aside class="inbox-sidebar">
        <div class="inbox-sidebar__header">
          <h2>Conversaciones</h2>
        </div>
        <div id="conversationList" class="conversation-list"></div>
      </aside>

      <section class="chat-panel">
        <div class="chat-panel__header">
          <h3 id="chatTitle" class="chat-panel__title">Selecciona una conversaci√≥n</h3>
          <span id="chatSubtitle" class="chat-panel__subtitle">Ning√∫n hilo activo</span>
        </div>
        <div id="chatMessages" class="chat-panel__messages">
          <div class="chat-empty-state">
            <strong>No has seleccionado un chat.</strong>
            Elige una conversaci√≥n de la lista para revisar los mensajes o escribir uno nuevo.
          </div>
        </div>
        <form id="chatComposer" class="chat-composer">
          <div class="composer-row" id="subjectRow">
            <label for="composerSubject">Asunto (solo para mensajes al administrador)</label>
            <input type="text" id="composerSubject" placeholder="Consulta sobre pr√©stamos, reporte de falla, etc.">
          </div>
          <div class="composer-row">
            <label for="composerMessage">Mensaje</label>
            <textarea id="composerMessage" rows="3" placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
          </div>
          <div class="chat-composer__actions">
            <span class="chat-composer__hint">Presiona ‚ÄúEnviar‚Äù para compartir tu mensaje. El historial se actualizar√° autom√°ticamente.</span>
            <button type="submit">üì® Enviar mensaje</button>
          </div>
        </form>
      </section>
    </section>
  </main>

  <script>
    function mostrarSwal(icono, titulo, texto, opciones = {}) {
      return Swal.fire({
        icon: icono,
        title: titulo,
        text: texto,
        confirmButtonText: 'Aceptar',
        confirmButtonColor: '#3085d6',
        ...opciones
      });
    }

    function obtenerMiId() {
      const guardado = localStorage.getItem('miId');
      if (guardado) return guardado;
      const token = localStorage.getItem('token');
      if (token && token.startsWith('user-')) {
        const id = token.replace('user-', '');
        localStorage.setItem('miId', id);
        return id;
      }
      const userData = localStorage.getItem('userData');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          const id = user.id || user.documento;
          if (id) {
            localStorage.setItem('miId', id);
            return id;
          }
        } catch (e) {}
      }
      mostrarSwal('warning', 'Inicia sesi√≥n', 'Necesitas iniciar sesi√≥n para usar los mensajes.')
        .then(() => { window.location.href = 'login.html'; });
      return null;
    }

    const miId = obtenerMiId();
    const conversationListEl = document.getElementById('conversationList');
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatTitleEl = document.getElementById('chatTitle');
    const chatSubtitleEl = document.getElementById('chatSubtitle');
    const composerForm = document.getElementById('chatComposer');
    const composerMessage = document.getElementById('composerMessage');
    const composerSubject = document.getElementById('composerSubject');
    const subjectRow = document.getElementById('subjectRow');

    let conversaciones = {};
    let conversacionActiva = 'admin';
    let cacheUsuarios = {};

    function escapeHtml(text) {
      return (text || '').replace(/[&<>"']/g, (char) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char]));
    }

    async function obtenerNombreUsuario(idUsuario) {
      if (!idUsuario || idUsuario === 'admin') return 'Administrador';
      if (cacheUsuarios[idUsuario]) return cacheUsuarios[idUsuario];
      try {
        const res = await fetch(`/api/usuarios/${idUsuario}`);
        if (res.ok) {
          const user = await res.json();
          const nombre = user.nombre || user.documento || idUsuario;
          cacheUsuarios[idUsuario] = nombre;
          return nombre;
        }
      } catch (e) {}
      return idUsuario;
    }

    function obtenerIdConversacion(msg) {
      const remitente = msg.id_remitente;
      const destinatario = msg.id_destinatario;
      if (remitente === 'admin' || destinatario === 'admin') return 'admin';
      return remitente === miId ? destinatario : remitente;
    }

    function obtenerOrdenConversaciones() {
      return Object.values(conversaciones)
        .sort((a, b) => {
          const fechaA = a.ultimoMensaje ? new Date(a.ultimoMensaje.creado_en).getTime() : 0;
          const fechaB = b.ultimoMensaje ? new Date(b.ultimoMensaje.creado_en).getTime() : 0;
          return fechaB - fechaA;
        });
    }

    async function cargarMensajes() {
      if (!miId) return;

      conversationListEl.innerHTML = 'Cargando...';

      try {
        const res = await fetch(`/api/mensajes?usuario=${miId}`);
        const mensajes = res.ok ? await res.json() : [];

        const mapa = new Map();

        const asegurarConversacion = (id) => {
          if (!mapa.has(id)) {
            mapa.set(id, {
              id,
              nombre: id === 'admin' ? 'Administrador' : id,
              mensajes: [],
              sinLeer: 0,
              ultimoMensaje: null
            });
          }
          return mapa.get(id);
        };

        for (const msg of mensajes) {
          const convId = obtenerIdConversacion(msg);
          const conv = asegurarConversacion(convId);
          conv.mensajes.push(msg);
          if (!conv.ultimoMensaje || new Date(msg.creado_en) > new Date(conv.ultimoMensaje.creado_en)) {
            conv.ultimoMensaje = msg;
          }
          if (msg.id_destinatario === miId && !msg.leido) {
            conv.sinLeer += 1;
          }
        }

        asegurarConversacion('admin'); // garantizar conversaci√≥n con admin

        const idsPorResolver = Array.from(mapa.keys()).filter(id => id !== 'admin');
        await Promise.all(idsPorResolver.map(async id => {
          const nombre = await obtenerNombreUsuario(id);
          const conv = mapa.get(id);
          if (conv) conv.nombre = nombre;
        }));

        conversaciones = Object.fromEntries(mapa.entries());

        if (!conversaciones[conversacionActiva]) {
          conversacionActiva = 'admin';
        }

        renderConversaciones();
        renderConversacion(conversacionActiva);
      } catch (error) {
        conversationListEl.innerHTML = '<div style="padding:16px; color:#b71c1c;">No se pudieron cargar los mensajes.</div>';
      }
    }

    function renderConversaciones() {
      const orden = obtenerOrdenConversaciones();
      if (!orden.length) {
        conversationListEl.innerHTML = '<div class="chat-empty-state">Sin conversaciones todav√≠a. Env√≠a un mensaje al administrador para iniciar.</div>';
        return;
      }

      conversationListEl.innerHTML = orden.map(conv => {
        const preview = conv.ultimoMensaje
          ? `${conv.ultimoMensaje.contenido.slice(0, 80)}${conv.ultimoMensaje.contenido.length > 80 ? '...' : ''}`
          : 'Sin mensajes';
        const fecha = conv.ultimoMensaje
          ? new Date(conv.ultimoMensaje.creado_en).toLocaleString('es-ES', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' })
          : '';
        return `
          <article class="conversation-card ${conv.id === conversacionActiva ? 'is-active' : ''}" data-id="${conv.id}">
            <div class="conversation-card__name">
              <span>${conv.nombre}</span>
              <div style="display:flex; gap:6px; align-items:center;">
                ${fecha ? `<span style="font-size:11px; color:#7a87ab;">${fecha}</span>` : ''}
                ${conv.sinLeer > 0 ? `<span class="badge-pill badge-pill--alert">${conv.sinLeer}</span>` : ''}
              </div>
            </div>
            <div class="conversation-card__preview">${escapeHtml(preview)}</div>
          </article>
        `;
      }).join('');

      conversationListEl.querySelectorAll('.conversation-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.id;
          conversacionActiva = id;
          renderConversaciones();
          renderConversacion(id);
        });
      });
    }

    async function renderConversacion(id) {
      const conv = conversaciones[id];
      if (!conv) {
        chatTitleEl.textContent = 'Selecciona una conversaci√≥n';
        chatSubtitleEl.textContent = 'Ning√∫n hilo activo';
        chatMessagesEl.innerHTML = '<div class="chat-empty-state"><strong>No hay mensajes por mostrar.</strong></div>';
        subjectRow.style.display = 'none';
        return;
      }

      chatTitleEl.textContent = conv.nombre;
      if (id === 'admin') {
        chatSubtitleEl.textContent = 'Mensaje directo con el personal administrativo.';
        subjectRow.style.display = '';
      } else {
        chatSubtitleEl.textContent = 'Chat habilitado por el administrador.';
        subjectRow.style.display = 'none';
      }

      if (!conv.mensajes.length) {
        chatMessagesEl.innerHTML = '<div class="chat-empty-state"><strong>A√∫n sin mensajes.</strong> Escribe para iniciar la conversaci√≥n.</div>';
      } else {
        const burbujas = conv.mensajes
          .sort((a, b) => new Date(a.creado_en) - new Date(b.creado_en))
          .map(msg => {
            const esMio = msg.id_remitente === miId;
            const autor = esMio ? 'T√∫' : conv.nombre;
            const fecha = new Date(msg.creado_en).toLocaleString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            return `
              <div class="chat-bubble ${esMio ? 'chat-bubble--self' : ''}">
                <div class="chat-bubble__meta">${autor} ¬∑ ${fecha}</div>
                <div class="chat-bubble__text">${escapeHtml(msg.contenido)}</div>
                ${esMio ? `<div class="chat-bubble__status">${msg.leido ? '‚úÖ Le√≠do' : '‚è≥ Enviado'}</div>` : ''}
              </div>
            `;
          }).join('');
        chatMessagesEl.innerHTML = burbujas;
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }

      await marcarConversacionLeida(conv);
      conv.sinLeer = 0;
      renderConversaciones();
    }

    async function marcarConversacionLeida(conv) {
      const pendientes = conv.mensajes.filter(msg => msg.id_destinatario === miId && !msg.leido);
      await Promise.all(pendientes.map(msg => fetch(`/api/mensajes/${msg.id}/leer`, { method: 'PUT' }).catch(() => {})));
    }

    composerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!miId || !conversacionActiva) return;

      const mensaje = composerMessage.value.trim();
      if (!mensaje) return;

      const destinatario = conversacionActiva;
      const payload = {
        id_remitente: miId,
        id_destinatario: destinatario,
        contenido: mensaje,
        tipo: destinatario === 'admin' ? 'consulta' : 'chat',
        asunto: destinatario === 'admin'
          ? (composerSubject.value.trim() || 'Consulta general')
          : 'Chat'
      };

      try {
        const res = await fetch('/api/mensajes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) {
          composerMessage.value = '';
          if (destinatario === 'admin') composerSubject.value = '';
          await cargarMensajes();
        } else {
        await mostrarSwal('error', 'No se pudo enviar', data.error || 'Intenta nuevamente.');
        }
      } catch (error) {
      await mostrarSwal('error', 'Error de conexi√≥n', 'No se pudo enviar el mensaje.');
      }
    });

    if (miId) {
      cargarMensajes();
      setInterval(cargarMensajes, 10000);
    }
  </script>
</body>
</html>

