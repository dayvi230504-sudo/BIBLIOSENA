<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Libros Disponibles</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
</head>
<body>
  {% set active_page = 'libros' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarLibros' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <h2 style="margin-top:8px">üìö CAT√ÅLOGO DE LIBROS</h2>
    <section class="carousel" aria-label="Carrusel de libros">
      <button type="button" class="carousel__btn carousel__btn--prev" id="prevBtn" aria-label="Anterior">‚ùÆ</button>
      <div class="carousel__viewport" id="carouselViewport">
        <div class="carousel__track" id="carouselTrack"></div>
      </div>
      <button type="button" class="carousel__btn carousel__btn--next" id="nextBtn" aria-label="Siguiente">‚ùØ</button>
    </section>
  </main>

  <script src="/static/js/main.js" defer></script>
  <script>
    let categoriaActual = 'Libros'; // Solo mostrar libros en esta p√°gina
    
    async function cargarCarrusel() {
      try {
        const res = await fetch('/api/libros');
        if (!res.ok) return;
        const todosLibros = await res.json();
        // Filtrar solo libros (no PCs/equipos)
        const libros = todosLibros.filter(l => {
          const cat = (l.categoria || '').toLowerCase();
          return cat === 'libros' || !cat.includes('equipo') && !cat.includes('pc');
        });
        
        const track = document.getElementById('carouselTrack');
        track.innerHTML = '';
        
        if (libros.length === 0) {
          track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay libros disponibles.</div>';
          return;
        }
        
        for (const libro of libros) {
      const placeholder = '/static/img/placeholder-book.svg';
      const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : placeholder;
          const disponible = (libro.cantidad_disponible || 0) > 0;
          const art = document.createElement('article');
          art.className = 'book';
          art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
          art.innerHTML = `
            <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}"></div>
            ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">‚úÖ ${libro.cantidad_disponible || 0}</div>` : ''}
            <div class="book__overlay">
              <h3>${libro.titulo || ''}</h3>
              <p>${libro.autor || ''}</p>
              <p>${libro.editorial || ''}</p>
              <p>${libro.categoria || ''}</p>
              ${disponible ? `<p style="color:#4caf50; font-weight:600;">‚úÖ ${libro.cantidad_disponible || 0} disponible(s)</p>` : '<p style="color:#f44336;">‚ùå No disponible</p>'}
            </div>`;
          track.appendChild(art);
        }
      } catch (e) {
        console.error('Error cargando libros:', e);
      }
    }
    
    function filtrarPorCategoria(cat) {
      categoriaActual = cat;
      cargarCarrusel();
    }
    
    document.getElementById('btnBuscarLibros')?.addEventListener('click', () => {
      const input = document.getElementById('buscadorInput');
      if (input && input.value.trim()) {
        realizarBusqueda(input.value);
      } else {
        cargarCarrusel();
      }
    });
    
    async function realizarBusqueda(consulta) {
      const res = await fetch('/api/libros');
      const todosLibros = res.ok ? await res.json() : [];
      const libros = todosLibros.filter(l => {
        const cat = (l.categoria || '').toLowerCase();
        return (cat === 'libros' || !cat.includes('equipo') && !cat.includes('pc'));
      });
      
      const palabras = consulta.toLowerCase().split(' ').filter(p => p.length > 0);
      const resultados = libros.filter(libro => {
        const texto = `${libro.titulo || ''} ${libro.autor || ''} ${libro.categoria || ''} ${libro.subcategoria || ''}`.toLowerCase();
        return palabras.some(pal => texto.includes(pal));
      });
      
      const track = document.getElementById('carouselTrack');
      track.innerHTML = '';
      
      if (resultados.length === 0) {
        track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No se encontraron libros.</div>';
        return;
      }
      
      resultados.sort((a, b) => ((b.cantidad_disponible || 0) > 0 ? 1 : 0) - ((a.cantidad_disponible || 0) > 0 ? 1 : 0));
      
      const placeholder = '/static/img/placeholder-book.svg';
      for (const libro of resultados) {
        const imgSrc = libro.imagen ? (libro.imagen.startsWith('uploads/') ? `/${libro.imagen}` : libro.imagen) : placeholder;
        const disponible = (libro.cantidad_disponible || 0) > 0;
        const art = document.createElement('article');
        art.className = 'book';
        art.onclick = () => window.location.href = `detalle_libro.html?id=${libro.id}`;
        art.innerHTML = `
          <div class="book__image"><img src="${imgSrc}" alt="${libro.titulo || ''}" onerror="this.src='${placeholder}'"></div>
          ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">‚úÖ ${libro.cantidad_disponible || 0}</div>` : ''}
          <div class="book__overlay">
            <h3>${libro.titulo || ''}</h3>
            <p>${libro.autor || ''}</p>
            <p>${disponible ? `‚úÖ ${libro.cantidad_disponible || 0} disponible(s)` : '‚ùå No disponible'}</p>
          </div>`;
        track.appendChild(art);
      }
    }
    
    cargarCarrusel();
    
    window.initializeTopbar && window.initializeTopbar();
  </script>
</body>
</html>

