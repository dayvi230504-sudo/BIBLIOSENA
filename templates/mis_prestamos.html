<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Pr√©stamos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
  <style>
    .loan-hero {
      background: linear-gradient(135deg, #4c6ef5, #9061f9);
      color: #fff;
      padding: 28px 32px;
      border-radius: 24px;
      box-shadow: 0 18px 36px rgba(76, 110, 245, 0.25);
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }
    .loan-hero::after {
      content: "";
      position: absolute;
      inset: -60px auto auto -40px;
      width: 220px;
      height: 220px;
      background: rgba(255,255,255,0.12);
      filter: blur(0);
      border-radius: 999px;
    }
    .loan-hero h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    .loan-hero p {
      margin: 12px 0 0 0;
      font-size: 16px;
      max-width: 640px;
      opacity: 0.85;
    }
    .loan-summary {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      margin-top: 24px;
    }
    .loan-summary__item {
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 16px;
      text-align: left;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.25);
    }
    .loan-summary__label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
    }
    .loan-summary__value {
      font-size: 28px;
      font-weight: 700;
      margin-top: 6px;
    }
    .loan-section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 16px 0;
      color: #223250;
    }
    .loan-section-title h3 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }
    .loan-list {
      display: grid;
      gap: 20px;
    }
    .loan-card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(102,126,234,0.12);
      box-shadow: 0 18px 36px rgba(15,37,77,0.08);
      padding: 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: relative;
      overflow: hidden;
    }
    .loan-card::before {
      content: "";
      position: absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
      pointer-events: none;
    }
    .loan-card > * {
      position: relative;
      z-index: 1;
    }
    .loan-card__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      flex-wrap: wrap;
    }
    .loan-card__title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #1c2751;
    }
    .loan-card__tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .loan-tag {
      background: rgba(102,126,234,0.18);
      color: #4059ad;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .loan-card__status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }
    .loan-card__status--ok {
      background: rgba(76,175,80,0.18);
      color: #1b5e20;
    }
    .loan-card__status--warning {
      background: rgba(255,152,0,0.2);
      color: #8d4b00;
    }
    .loan-card__status--alert {
      background: rgba(244,67,54,0.22);
      color: #b71c1c;
    }
    .loan-card__grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .loan-info {
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(102,126,234,0.14);
      border-radius: 16px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 12px 26px rgba(15,37,77,0.06);
    }
    .loan-info strong {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #42526e;
    }
    .loan-info span {
      font-size: 15px;
      color: #1c2751;
      font-weight: 600;
    }
    .loan-card__progress {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .loan-progress-bar {
      position: relative;
      flex: 1 1 220px;
      height: 10px;
      border-radius: 999px;
      background: rgba(102,126,234,0.18);
      overflow: hidden;
    }
    .loan-progress-bar div {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(135deg, #42a5f5, #7b61ff);
    }
    .loan-progress-label {
      font-size: 14px;
      font-weight: 600;
      color: #233050;
    }
    .loan-state-alert {
      background: rgba(255,244,229,0.9);
      border: 1px solid rgba(255,152,0,0.35);
      border-radius: 16px;
      padding: 14px;
      font-weight: 600;
      color: #8d4b00;
    }
    .loan-state-alert.critical {
      background: rgba(255,235,238,0.9);
      border-color: rgba(244,67,54,0.35);
      color: #b71c1c;
    }
    .sanction-list {
      display: grid;
      gap: 16px;
    }
    .sanction-card {
      background: #fff7f4;
      border-radius: 18px;
      border: 1px solid rgba(255,138,101,0.35);
      padding: 18px;
      box-shadow: 0 12px 30px rgba(255,138,101,0.18);
    }
    .sanction-card h4 {
      margin: 0 0 8px 0;
      color: #d84315;
    }
    .sanction-card__meta {
      font-size: 13px;
      color: #784421;
      margin-top: 6px;
    }
    @media (max-width: 768px) {
      .loan-hero {
        border-radius: 18px;
        padding: 24px;
      }
      .loan-card {
        padding: 20px;
      }
      .loan-card__header {
        flex-direction: column;
        align-items: flex-start;
      }
      .loan-progress-bar {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  {% set active_page = 'mis_prestamos' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarPrestamos' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <section class="loan-hero">
      <h1>üìã Resumen de pr√©stamos</h1>
      <p>Consulta el estado de tus solicitudes, conoce los pr√≥ximos vencimientos y mant√©n al d√≠a tus devoluciones para evitar sanciones.</p>
      <div id="resumenPrestamos" class="loan-summary">
        <div class="loan-summary__item">
          <span class="loan-summary__label">Total registrados</span>
          <div class="loan-summary__value" id="totalPrestamos">0</div>
        </div>
        <div class="loan-summary__item">
          <span class="loan-summary__label">Activos</span>
          <div class="loan-summary__value" id="activosPrestamos">0</div>
        </div>
        <div class="loan-summary__item">
          <span class="loan-summary__label">Vencidos</span>
          <div class="loan-summary__value" id="vencidosPrestamos">0</div>
        </div>
        <div class="loan-summary__item">
          <span class="loan-summary__label">Sanciones</span>
          <div class="loan-summary__value" id="sancionesPrestamos">0</div>
        </div>
      </div>
    </section>

    <section>
      <div class="loan-section-title">
        <h3>üìñ Mis elementos prestados</h3>
        <button onclick="cargarMisPrestamos()" style="border:none; background:linear-gradient(135deg,#42a5f5,#7b61ff); color:#fff; padding:10px 18px; border-radius:999px; box-shadow:0 12px 28px rgba(66,165,245,0.25); cursor:pointer;">üîÑ Actualizar listado</button>
    </div>
      <div id="listaPrestamos" class="loan-list"></div>
    </section>

    <section style="margin-top:40px;">
      <div class="loan-section-title">
        <h3>‚ö†Ô∏è Mis sanciones</h3>
    </div>
      <div id="listaSanciones" class="sanction-list"></div>
    </section>
  </main>

  <script>
    function mostrarSwal(icono, titulo, texto, opciones = {}) {
      return Swal.fire({
        icon: icono,
        title: titulo,
        text: texto,
        confirmButtonText: 'Aceptar',
        confirmButtonColor: '#3085d6',
        ...opciones
      });
    }

    // Obtener ID del usuario
    function obtenerMiId() {
      const miIdGuardado = localStorage.getItem('miId');
      if (miIdGuardado) return miIdGuardado;
      
      const token = localStorage.getItem('token');
      if (token && token.startsWith('user-')) {
        const id = token.replace('user-', '');
        localStorage.setItem('miId', id);
        return id;
      }
      
      const userData = localStorage.getItem('userData');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          const id = user.id || user.documento;
          if (id) {
            localStorage.setItem('miId', id);
            return id;
          }
        } catch (e) {}
      }
      
      mostrarSwal('warning', 'Inicia sesi√≥n', 'Necesitas iniciar sesi√≥n primero.')
        .then(() => { window.location.href = 'login.html'; });
      return null;
    }

    const miId = obtenerMiId();

    function escapeHtml(texto) {
      if (texto === null || texto === undefined) return '';
      return texto.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function legibleDesdeCodigo(texto) {
      if (!texto) return '';
      return texto
        .toString()
        .replace(/_/g, ' ')
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .replace(/\b\w/g, letra => letra.toUpperCase())
        .trim();
    }

    function formatearFecha(isoString) {
      if (!isoString) return '';
      try {
        const fecha = new Date(isoString);
        if (Number.isNaN(fecha.getTime())) return isoString;
        return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
      } catch (error) {
        return isoString;
      }
    }

    // Calcular fecha l√≠mite (7 d√≠as despu√©s del pr√©stamo)
    function calcularFechaLimite(fechaPrestamo) {
      const fecha = new Date(fechaPrestamo);
      fecha.setDate(fecha.getDate() + 7); // 7 d√≠as de pr√©stamo
      return fecha;
    }

    function estaVencido(fechaLimite) {
      return new Date() > new Date(fechaLimite);
    }

    function diasRestantes(fechaLimite) {
      const hoy = new Date();
      const limite = new Date(fechaLimite);
      const diff = limite - hoy;
      const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));
      return dias;
    }

    async function cargarMisPrestamos() {
      if (!miId) return;
      
      const lista = document.getElementById('listaPrestamos');
      lista.innerHTML = 'Cargando pr√©stamos...';
      
      try {
        // Cargar pr√©stamos (buscar por ID, documento o username)
        // Intentar m√∫ltiples formas de b√∫squeda
        let prestamos = [];
        try {
          // Primero intentar con el ID guardado
          let res = await fetch(`/prestamos?usuario=${miId}`);
          if (res.ok) {
            prestamos = await res.json();
          }
          
          // Si no hay resultados, intentar con documento o username del token
          if (prestamos.length === 0) {
            const token = localStorage.getItem('token');
            if (token && token.startsWith('user-')) {
              const tokenId = token.replace('user-', '');
              if (tokenId !== miId) {
                res = await fetch(`/prestamos?usuario=${tokenId}`);
                if (res.ok) {
                  prestamos = await res.json();
                }
              }
            }
            
            // Tambi√©n intentar con datos del usuario guardados
            const userData = localStorage.getItem('userData');
            if (userData && prestamos.length === 0) {
              try {
                const user = JSON.parse(userData);
                if (user.documento && user.documento !== miId) {
                  res = await fetch(`/prestamos?usuario=${user.documento}`);
                  if (res.ok) {
                    prestamos = await res.json();
                  }
                }
              } catch(e) {}
            }
          }
        } catch(e) {
          console.error('Error cargando pr√©stamos:', e);
        }
        
        // Cargar sanciones desde el nuevo endpoint
        let sanciones = [];
        try {
          const resSanciones = await fetch(`/api/sanciones?id_usuario=${encodeURIComponent(miId)}`);
          if (resSanciones.ok) {
            sanciones = await resSanciones.json();
          }
        } catch (errorSancion) {
          console.error('Error cargando sanciones del usuario:', errorSancion);
        }
        
        // Actualizar resumen
        const activos = prestamos.filter(p => p.estado === 'aprobado');
        const vencidos = activos.filter(p => {
          const limite = calcularFechaLimite(p.fecha_prestamo);
          return estaVencido(limite);
        });
        const sancionesActivas = sanciones.filter(s => (s.estado || '').toLowerCase() === 'activa');
        
        document.getElementById('totalPrestamos').textContent = prestamos.length;
        document.getElementById('activosPrestamos').textContent = activos.length;
        document.getElementById('vencidosPrestamos').textContent = vencidos.length;
        document.getElementById('sancionesPrestamos').textContent = sancionesActivas.length;
        
        if (prestamos.length === 0) {
          lista.innerHTML = '<div class="loan-state-alert" style="background:#f5f9ff; border-color:rgba(102,126,234,0.25); color:#1c2751;">A√∫n no tienes pr√©stamos registrados. Explora la biblioteca y solicita tu primer recurso.</div>';
          return;
        }
        
        // Cargar informaci√≥n de los elementos
        let html = '';
        for (const prestamo of prestamos) {
          const sancionesPrestamo = sanciones.filter(s => s.id_prestamo === prestamo.id);
          const sancionesActivasPrestamo = sancionesPrestamo.filter(s => (s.estado || '').toLowerCase() === 'activa');
          let libro = prestamo.elemento || null;
          if (!libro) {
            const resLibro = await fetch(`/api/libros/${prestamo.id_elemento}`).catch(() => null);
            libro = resLibro && resLibro.ok ? await resLibro.json().catch(() => null) : null;
          }
          
          const fechaPrestamo = prestamo.fecha_prestamo ? new Date(prestamo.fecha_prestamo) : null;
          const fechaSolicitud = prestamo.creado_en ? new Date(prestamo.creado_en) : fechaPrestamo;
          const fechaLimite = prestamo.estado === 'aprobado' && prestamo.fecha_prestamo
            ? calcularFechaLimite(prestamo.fecha_prestamo)
            : null;
          const vencido = fechaLimite ? estaVencido(fechaLimite) : false;
          const diasRest = fechaLimite ? diasRestantes(fechaLimite) : 0;
          const msPorDia = 1000 * 60 * 60 * 24;
          const totalDiasPrestamo = fechaPrestamo && fechaLimite
            ? Math.max(1, Math.ceil((fechaLimite - fechaPrestamo) / msPorDia))
            : 1;
          const avancePorcentaje = fechaLimite
            ? Math.min(100, Math.max(0, Math.round(((totalDiasPrestamo - Math.max(diasRest, 0)) / totalDiasPrestamo) * 100)))
            : 0;

          const tituloElemento = libro ? (libro.titulo || libro.categoria || 'Recurso') : prestamo.id_elemento.substring(0, 12) + '...';
          const categoria = libro?.categoria || 'Sin categor√≠a';
          const subcategoria = libro?.subcategoria || '';
          const codigoInv = libro?.codigo_inventario || prestamo.id_elemento.substring(0, 8) + '...';

          const estadoTexto = {
            pendiente: 'Pendiente de aprobaci√≥n',
            aprobado: 'Aprobado',
            rechazado: 'Rechazado',
            devuelto: 'Devuelto'
          }[prestamo.estado] || prestamo.estado;

          let statusClass = 'loan-card__status--ok';
          let statusBadge = `‚úÖ ${estadoTexto}`;

          if (prestamo.estado === 'aprobado') {
            if (vencido) {
              statusClass = 'loan-card__status--alert';
              statusBadge = `‚ö†Ô∏è Pr√©stamo vencido`;
            } else if (diasRest <= 2) {
              statusClass = 'loan-card__status--warning';
              statusBadge = `‚è∞ Pr√≥ximo a vencer`;
            } else {
              statusBadge = `üìö En curso`;
            }
          } else if (prestamo.estado === 'pendiente') {
            statusClass = 'loan-card__status--warning';
            statusBadge = `‚è≥ Pendiente de aprobaci√≥n`;
          } else if (prestamo.estado === 'rechazado') {
            statusClass = 'loan-card__status--alert';
            statusBadge = `‚ùå Solicitud rechazada`;
          } else if (prestamo.estado === 'devuelto') {
            statusClass = 'loan-card__status--ok';
            statusBadge = `üì• Devuelto`;
          }

          const badges = [
            categoria,
            subcategoria || null,
            codigoInv ? `C√≥digo: ${codigoInv}` : null
          ].filter(Boolean).map(tag => `<span class="loan-tag">${tag}</span>`).join('');
          const sancionBadge = sancionesPrestamo.length
            ? `<span class="loan-tag" style="background:rgba(244,67,54,0.16); color:#b71c1c;">Sanciones: ${sancionesPrestamo.length}</span>`
            : '';
          const badgesHtml = [badges, sancionBadge].filter(Boolean).join('');

          let progressBlock = '';
          let alertBlock = '';

          if (prestamo.estado === 'aprobado') {
            const label = vencido
              ? `Con ${Math.abs(diasRest)} d√≠a(s) de retraso`
              : `Faltan ${diasRest} d√≠a(s) para la devoluci√≥n`;
            progressBlock = `
              <div class="loan-card__progress">
                <div class="loan-progress-bar"><div style="width:${avancePorcentaje}%;"></div></div>
                <span class="loan-progress-label">${label}</span>
              </div>
            `;
            if (vencido) {
              alertBlock = `<div class="loan-state-alert critical">‚ö†Ô∏è Este pr√©stamo ya super√≥ la fecha l√≠mite. Devu√©lvelo cuanto antes para evitar sanciones.</div>`;
            } else if (diasRest <= 2) {
              alertBlock = `<div class="loan-state-alert">‚è∞ Recuerda devolver el recurso dentro de los pr√≥ximos ${diasRest} d√≠a(s) para mantener tu historial limpio.</div>`;
            }
          } else if (prestamo.estado === 'pendiente') {
            progressBlock = `<div class="loan-card__progress"><span class="loan-progress-label">Esperando confirmaci√≥n del administrador.</span></div>`;
          }

          if (sancionesPrestamo.length && prestamo.estado !== 'pendiente') {
            statusClass = 'loan-card__status--alert';
            statusBadge = sancionesActivasPrestamo.length
              ? `‚ö†Ô∏è Sanci√≥n vigente (${sancionesActivasPrestamo.length})`
              : `‚ÑπÔ∏è Sanci√≥n registrada`;
          }

          const sancionResumen = sancionesPrestamo.map((s, index) => {
            const causaNombre = escapeHtml(s.causa_legible || s.causa || `Causa #${index + 1}`);
            const descripcion = s.causa_descripcion ? `<div style="margin-top:4px; color:#5f4339;">${escapeHtml(s.causa_descripcion)}</div>` : '';
            const estado = (s.estado || '').toLowerCase() === 'resuelta' ? 'Resuelta' : 'Activa';
            return `
              <li style="margin-bottom:8px;">
                <strong>${causaNombre}</strong> ¬∑ ${estado}
                ${descripcion}
                ${s.observaciones ? `<div style="margin-top:4px; color:#795548;">üìù ${escapeHtml(s.observaciones)}</div>` : ''}
              </li>
            `;
          }).join('');

          const sancionBlock = sancionesPrestamo.length
            ? `<div class="loan-state-alert critical" style="margin-top:14px;">
                ‚ö†Ô∏è Este pr√©stamo tiene ${sancionesPrestamo.length} sanci√≥n(es) asociada(s):
                <ul style="margin:10px 0 0 18px; padding:0;">${sancionResumen}</ul>
              </div>`
            : '';

          const observaciones = prestamo.observaciones
            ? `<div class="loan-state-alert" style="background:#f5f5f5; border-color:rgba(102,126,234,0.25); color:#223250;">üìù ${prestamo.observaciones}</div>`
            : '';

          html += `
            <article class="loan-card">
              <div class="loan-card__header">
              <div>
                  <h4 class="loan-card__title">${tituloElemento}</h4>
                  <div class="loan-card__tags">
                    ${badgesHtml || '<span class="loan-tag">Sin metadatos</span>'}
              </div>
            </div>
                <span class="loan-card__status ${statusClass}">${statusBadge}</span>
              </div>
              <div class="loan-card__grid">
                <div class="loan-info">
                  <strong>üìÖ Fecha de solicitud</strong>
                  <span>${fechaSolicitud ? fechaSolicitud.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Sin registro'}</span>
                </div>
                <div class="loan-info">
                  <strong>‚è∞ Fecha l√≠mite</strong>
                  <span>${fechaLimite ? fechaLimite.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Por confirmar'}</span>
                </div>
                <div class="loan-info">
                  <strong>üìå Estado actual</strong>
                  <span>${estadoTexto}</span>
                </div>
                ${libro?.autor ? `
                  <div class="loan-info">
                    <strong>üë§ Autor / Responsable</strong>
                    <span>${libro.autor}</span>
                  </div>` : ''}
              </div>
              ${progressBlock}
              ${alertBlock}
              ${sancionBlock}
              ${observaciones}
            </article>
          `;
        }
        
        lista.innerHTML = html;
        
        // Cargar sanciones
        cargarSanciones(sanciones);
      } catch (e) {
        console.error('Error:', e);
        lista.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando pr√©stamos</div>';
      }
    }

    async function cargarSanciones(sanciones) {
      const lista = document.getElementById('listaSanciones');
      if (!sanciones || sanciones.length === 0) {
        lista.innerHTML = '<div class="loan-state-alert" style="background:#f5f9ff; border-color:rgba(102,126,234,0.25); color:#1c2751;">No tienes sanciones activas. ¬°Sigue as√≠!</div>';
        return;
      }
      
      let html = '';
      for (const sancion of sanciones) {
        const estado = (sancion.estado || '').toLowerCase();
        const activa = estado === 'activa';
        const etiquetaEstado = activa ? 'Activa' : 'Resuelta';
        const tipoLabel = sancion.tipo_codigo
          ? `${escapeHtml(sancion.tipo_codigo)} ‚Äî ${escapeHtml(sancion.tipo_descripcion || '')}`
          : escapeHtml(sancion.tipo_descripcion || 'Sanci√≥n registrada');
        const causaTexto = escapeHtml(sancion.causa_legible || sancion.causa || 'Causa no especificada');
        const descripcion = sancion.causa_descripcion ? `<div class="sanction-card__meta" style="margin-top:4px;">${escapeHtml(sancion.causa_descripcion)}</div>` : '';
        const fechaInicio = sancion.fecha_inicio ? `<div class="sanction-card__meta"><strong>Desde:</strong> ${formatearFecha(sancion.fecha_inicio)}</div>` : '';
        const fechaFin = sancion.fecha_fin ? `<div class="sanction-card__meta"><strong>Hasta:</strong> ${formatearFecha(sancion.fecha_fin)}</div>` : '';
        const prestamo = sancion.id_prestamo ? `<div class="sanction-card__meta"><strong>Pr√©stamo:</strong> ${escapeHtml(sancion.id_prestamo)}</div>` : '';
        const observaciones = sancion.observaciones ? `<p style="margin-top:12px; color:#5f4339;">${escapeHtml(sancion.observaciones)}</p>` : '';
        html += `
          <article class="sanction-card">
            <h4>${tipoLabel}</h4>
            <div class="sanction-card__meta">
              <strong>Estado:</strong> ${etiquetaEstado}${activa ? ' ¬∑ Vigente' : ''}
            </div>
            <div class="sanction-card__meta"><strong>Causa:</strong> ${causaTexto}</div>
            ${descripcion}
            ${fechaInicio}
            ${fechaFin}
            ${prestamo}
            ${observaciones}
          </article>
        `;
      }
      lista.innerHTML = html;
    }

    // Cargar al inicio
    if (miId) {
      cargarMisPrestamos();
      // Auto-refresh cada 30 segundos
      setInterval(cargarMisPrestamos, 30000);
    }
    window.initializeTopbar && window.initializeTopbar();
  </script>
</body>
</html>

