<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    .admin-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .admin-tab {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      position: relative;
    }
    .admin-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }
    .admin-tab:hover:not(.active) {
      background: #f0f0f0;
    }
    .admin-tab .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f44336;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .section-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    .section-content.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .usuario-info {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      margin-top: 8px;
      border-left: 4px solid #2196f3;
    }
    .mensajes-panel {
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    .mensaje-item {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .mensaje-item:hover {
      background: #f5f5f5;
    }
    .mensaje-item.no-leido {
      background: #fff3cd;
      font-weight: 600;
    }
    .btn-conectar {
      background: #9c27b0;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 12px;
    }
    .eliminar-todo-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .bot-busqueda {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <header class="encabezado">
    <img src="/static/uploads/logosena.jpg" alt="Logo SENA" class="logo">
    <h2 style="margin-left:16px; flex:1;">‚öôÔ∏è Panel de Administraci√≥n</h2>
    <a href="principal.html" style="background:#757575; color:white; padding:8px 16px; border:none; border-radius:6px; text-decoration:none; margin-right:8px;">‚Üê Inicio</a>
    <a href="admin_mensajes.html" style="background:#667eea; color:white; padding:8px 16px; border:none; border-radius:6px; text-decoration:none; position:relative;">
      üí¨ Mensajes
      <span id="badgeMensajesAdmin" style="display:none; position:absolute; top:-8px; right:-8px; background:#f44336; color:white; border-radius:50%; width:20px; height:20px; font-size:11px; display:flex; align-items:center; justify-content:center; font-weight:bold;">0</span>
    </a>
  </header>

  <main class="content">
    <div class="admin-header">
      <h2 style="margin:0 0 16px 0; color:white;">üìä Panel de Administraci√≥n</h2>
      <div class="admin-tabs">
        <div class="admin-tab active" data-section="pendientes">
          ‚è≥ Solicitudes Pendientes
          <span class="badge" id="badgePendientes" style="display:none;">0</span>
        </div>
        <div class="admin-tab" data-section="aprobados">‚úÖ Pr√©stamos Aprobados</div>
        <div class="admin-tab" data-section="libros">üìö Gesti√≥n de Libros</div>
        <div class="admin-tab" data-section="trazabilidad">üìä Trazabilidad</div>
        <div class="admin-tab" data-section="espera">
          üìã Lista de Espera
          <div style="font-size:11px; opacity:0.9; margin-top:2px;">(Cuando no hay stock)</div>
        </div>
        <div class="admin-tab" data-section="usuarios">üë• Gesti√≥n de Usuarios</div>
        <div class="admin-tab" data-section="sanciones">‚ö†Ô∏è Tipos de Sanci√≥n</div>
        <div class="admin-tab" data-section="importar">üì• Importar CSV/Excel</div>
      </div>
    </div>

    <!-- Secci√≥n: Solicitudes Pendientes -->
    <div id="section-pendientes" class="section-content active">
      <div class="bot-busqueda">
        <strong>üîç B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="botBuscarPendientes" placeholder="Buscar por ID pr√©stamo, nombre, documento, ficha..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <button onclick="filtrarPendientes()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">üîç Buscar</button>
        </div>
        <small style="color:#666; font-size:12px; margin-top:4px; display:block;">Puedes buscar por ID de pr√©stamo completo o parcial, nombre del usuario, documento o n√∫mero de ficha</small>
      </div>
      <h3 style="border-left:4px solid #ff9800; padding-left:12px;">‚è≥ Pr√©stamos Pendientes</h3>
      <div id="listaPendientes" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Solicitudes Aprobadas -->
    <div id="section-aprobados" class="section-content">
      <div class="bot-busqueda">
        <strong>ü§ñ Bot de B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="botBuscarAprobados" placeholder="Buscar por nombre, documento, elemento..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <button onclick="filtrarAprobados()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">üîç Buscar</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #4caf50; padding-left:12px;">‚úÖ Pr√©stamos Aprobados</h3>
      <div id="listaAprobados" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Gesti√≥n de Libros -->
    <div id="section-libros" class="section-content">
      <div class="bot-busqueda">
        <strong>ü§ñ Bot de B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <input id="fCat" placeholder="Categor√≠a" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <input id="fCodigo" placeholder="C√≥digo inventario" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <input id="fTitulo" placeholder="T√≠tulo o autor" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <button id="btnBuscar" style="background:#2196f3; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üîç Buscar</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #2196f3; padding-left:12px;">üìö Gesti√≥n de Libros</h3>
      <div style="background:#fff; padding:16px; border:1px solid #e1e8ed; border-radius:8px; margin-top:16px; margin-bottom:16px;">
        <div class="eliminar-todo-box">
          <strong>‚ö†Ô∏è Zona de Peligro</strong>
          <p style="margin:8px 0; font-size:14px;">Opciones de eliminaci√≥n masiva</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
            <button class="btn-eliminar-todo" onclick="mostrarConfirmEliminar()">üóëÔ∏è Eliminar Todos los Libros</button>
            <button class="btn-eliminar-todo" onclick="eliminarPorCategoriaAdmin()" style="background:#9c27b0;">üìÇ Eliminar por Categor√≠a</button>
          </div>
          <div class="eliminar-confirm" id="confirmEliminar" style="display:none; background:#f8d7da; border:2px solid #dc3545; padding:12px; border-radius:8px; margin-top:8px;">
            <p style="margin:0 0 8px 0; color:#721c24; font-weight:600;">‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER</p>
            <p style="margin:0 0 8px 0;">Escribe <strong>ELIMINAR TODO</strong> para confirmar:</p>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <input type="text" id="confirmText" placeholder="ELIMINAR TODO" style="padding:8px; border:2px solid #dc3545; border-radius:4px; width:200px;" />
              <button onclick="eliminarTodosLosLibros()" style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">Confirmar</button>
              <button onclick="cancelarEliminar()" style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Cancelar</button>
            </div>
          </div>
        </div>
      </div>
      <div id="listaInventario" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px;"></div>
    </div>

    <!-- Secci√≥n: Trazabilidad -->
    <div id="section-trazabilidad" class="section-content">
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üìä Trazabilidad de Pr√©stamos</h3>
      <div style="background:#fff; padding:16px; border:1px solid #e1e8ed; border-radius:8px; margin-top:16px;">
        <div style="display:flex; gap:8px; margin-bottom:16px;">
          <select id="filtroTrazabilidad" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendientes</option>
            <option value="aprobado">Aprobados</option>
            <option value="rechazado">Rechazados</option>
            <option value="devuelto">Devueltos</option>
          </select>
          <button onclick="cargarTrazabilidad()" style="background:#9c27b0; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üîç Ver</button>
        </div>
        <div id="trazabilidadContent"></div>
      </div>
    </div>

    <!-- Secci√≥n: Lista de Espera -->
    <div id="section-espera" class="section-content">
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üìã Lista de Espera</h3>
      <div id="listaEspera" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Gesti√≥n de Usuarios -->
    <div id="section-usuarios" class="section-content">
      <div class="bot-busqueda">
        <strong>üîç B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="buscarUsuarios" placeholder="Buscar por nombre, documento, username, correo..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" onkeyup="filtrarUsuarios()" />
          <button onclick="abrirModalUsuario()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ûï Agregar Usuario</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üë• Gesti√≥n de Usuarios</h3>
      <div id="listaUsuarios" style="margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Tipos de Sanci√≥n -->
    <div id="section-sanciones" class="section-content">
      <div class="bot-busqueda">
        <strong>‚ö†Ô∏è Gesti√≥n de Tipos de Sanci√≥n</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button onclick="abrirModalSancionTipo()" style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ûï Agregar Tipo de Sanci√≥n</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #f44336; padding-left:12px;">‚ö†Ô∏è Tipos de Sanci√≥n Registrados</h3>
      <div id="listaSancionTipos" style="margin-top:16px;"></div>
    </div>

    <!-- Modal para agregar/editar tipo de sanci√≥n -->
    <div id="modalSancionTipo" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px; border-radius:12px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
        <h3 id="modalSancionTipoTitulo" style="margin-top:0; color:#f44336;">‚ûï Agregar Tipo de Sanci√≥n</h3>
        <form id="formSancionTipo" onsubmit="guardarSancionTipo(event)">
          <input type="hidden" id="sancionTipoId" />
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; font-weight:600; color:#333;">C√≥digo *</label>
            <input type="text" id="sancionTipoCodigo" required placeholder="Ej: SUSP_TEMP, MULTA_RETRASO" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; text-transform:uppercase;" />
            <small style="color:#666; font-size:12px;">C√≥digo √∫nico, sin espacios, en may√∫sculas (RB1)</small>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; font-weight:600; color:#333;">Descripci√≥n *</label>
            <textarea id="sancionTipoDescripcion" required placeholder="Descripci√≥n del tipo de sanci√≥n (5-120 caracteres)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; min-height:80px; resize:vertical;" maxlength="120"></textarea>
            <small style="color:#666; font-size:12px;">Entre 5 y 120 caracteres (RB2) - <span id="contadorDescripcion">0</span>/120</small>
          </div>
          <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button type="button" onclick="cerrarModalSancionTipo()" style="background:#757575; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
            <button type="submit" style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Secci√≥n: Importar -->
    <div id="section-importar" class="section-content">
      <h3 style="border-left:4px solid #17a2b8; padding-left:12px;">üì• Importar Inventario (CSV/Excel)</h3>
      <div style="background:#fff; padding:20px; border:1px solid #e1e8ed; border-radius:8px; margin-top:16px;">
        <form id="formImport">
          <input type="file" name="file" accept=".csv,.xlsx,.xls" required style="margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
          <button type="submit" style="background:#17a2b8; color:white; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-weight:600; width:100%;">üì• Importar Archivo</button>
    </form>
        <div style="font-size:12px; color:#555; margin-top:12px; padding:12px; background:#f8f9fa; border-radius:6px;">
          <strong>Formato esperado (cabeceras):</strong><br>
          titulo, autor, isbn, editorial, anio_publicacion, categoria, subcategoria, descripcion, stock, cantidad_disponible, codigo_inventario, imagen_url
        </div>
      </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div id="modalUsuario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px; border-radius:15px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
        <h2 id="modalUsuarioTitulo" style="margin-top:0;">Agregar Usuario</h2>
        <form id="formUsuario" onsubmit="guardarUsuario(event)">
          <input type="hidden" id="usuarioIdEdit">
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Nombre</label>
            <input type="text" id="usuarioNombre" required style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Documento</label>
            <input type="text" id="usuarioDocumento" required style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Correo</label>
            <input type="email" id="usuarioCorreo" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Username</label>
            <input type="text" id="usuarioUsername" required style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Contrase√±a <span id="passwordLabel">(requerida)</span></label>
            <input type="password" id="usuarioPassword" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Rol</label>
            <select id="usuarioRole" required style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
            <button type="button" onclick="cerrarModalUsuario()" style="padding:10px 20px; border:none; border-radius:5px; cursor:pointer; background:#757575; color:white;">Cancelar</button>
            <button type="submit" style="padding:10px 20px; border:none; border-radius:5px; cursor:pointer; background:#667eea; color:white; font-weight:600;">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Sistema de tabs
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const section = tab.getAttribute('data-section');
        // Actualizar tabs activos
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // Ocultar todas las secciones
        document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
        // Mostrar secci√≥n seleccionada
        const targetSection = document.getElementById(`section-${section}`);
        if (targetSection) {
          targetSection.classList.add('active');
          // Cargar datos seg√∫n secci√≥n
          switch(section) {
            case 'pendientes': cargarPendientes(); break;
            case 'aprobados': cargarAprobados(); break;
            case 'libros': cargarInventario(); break;
            case 'trazabilidad': cargarTrazabilidad(); break;
            case 'espera': cargarEspera(); break;
            case 'usuarios': cargarUsuarios(); break;
            case 'sanciones': cargarSancionTipos(); break;
          }
        }
      });
    });

    // Cargar datos de solicitudes pendientes con informaci√≥n completa del usuario
    let cacheUsuarios = {};
    async function obtenerUsuarioInfo(idUsuario) {
      if (cacheUsuarios[idUsuario]) return cacheUsuarios[idUsuario];
      if (!idUsuario) return null;
      try {
        const res = await fetch(`/api/usuarios/${idUsuario}`);
        if (res.ok) {
          const data = await res.json();
          cacheUsuarios[idUsuario] = data;
          return data;
        }
      } catch(e) {}
      return null;
    }

    async function cargarPendientes(){
      const cont = document.getElementById('listaPendientes');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/prestamos?estado=pendiente');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay solicitudes pendientes.</div>';
          document.getElementById('badgePendientes').style.display = 'none';
          return;
        }
        
        // Actualizar badge
        const badge = document.getElementById('badgePendientes');
        if (items.length > 0) {
          badge.textContent = items.length;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }

        cont.innerHTML = '';
        for (const p of items) {
          // Usar datos del usuario desde la respuesta o buscar
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `
              <div class="usuario-info" style="background:#e3f2fd; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #2196f3;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:13px;">
                  <div><strong>üë§ Nombre:</strong> ${usuarioInfo.nombre || 'N/A'}</div>
                  <div><strong>üÜî Documento:</strong> ${usuarioInfo.documento || p.id_usuario || 'N/A'}</div>
                  <div><strong>üìã Ficha:</strong> ${usuarioInfo.numero_ficha || 'N/A'}</div>
                </div>
              </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `
              <div style="background:#f1f8f4; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #4caf50;">
                <div style="font-size:13px;">
                  <strong>üìö Elemento:</strong> ${elementoInfo.titulo || p.id_elemento.substring(0, 8) + '...'}<br>
                  ${elementoInfo.autor ? `<strong>üë§ Autor:</strong> ${elementoInfo.autor}<br>` : ''}
                  ${elementoInfo.codigo_inventario ? `<strong>üî¢ C√≥digo:</strong> ${elementoInfo.codigo_inventario}` : ''}
                </div>
              </div>`;
          }
          
          card.innerHTML = `
            <div>
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div>
                  <div><strong>üÜî ID Pr√©stamo:</strong> <code style="background:#f5f5f5; padding:2px 6px; border-radius:4px;">${p.id}</code></div>
                  <div style="font-size:12px; color:#666; margin-top:4px;"><strong>Fecha solicitud:</strong> ${new Date(p.creado_en).toLocaleString('es-ES')}</div>
                </div>
              </div>
              ${usuarioHtml}
              ${elementoHtml}
              <div style="display:flex; gap:8px; margin-top:12px;">
                <button data-id="${p.id}" class="btn-aprobar" style="background:#4caf50; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚úÖ Aprobar</button>
                <button data-id="${p.id}" class="btn-rechazar" style="background:#f44336; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ùå Rechazar</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch (e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando solicitudes</div>';
      }
    }

    async function filtrarPendientes() {
      const busqueda = document.getElementById('botBuscarPendientes').value.trim();
      if (!busqueda) {
        // Si est√° vac√≠o, mostrar todos
        document.querySelectorAll('#listaPendientes > div').forEach(card => {
          card.style.display = 'block';
        });
        return;
      }
      
      // Buscar por ID de pr√©stamo, nombre, documento o ficha
      const cards = document.querySelectorAll('#listaPendientes > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        const busquedaLower = busqueda.toLowerCase();
        // Buscar en todo el texto (incluye ID, nombre, documento, ficha)
        card.style.display = texto.includes(busquedaLower) ? 'block' : 'none';
      });
    }

    async function cargarAprobados(){
      const cont = document.getElementById('listaAprobados');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/prestamos?estado=aprobado');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay pr√©stamos aprobados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const p of items) {
          // Usar datos del usuario desde la respuesta
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `
              <div class="usuario-info" style="background:#e3f2fd; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #2196f3;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:13px;">
                  <div><strong>üë§ Nombre:</strong> ${usuarioInfo.nombre || 'N/A'}</div>
                  <div><strong>üÜî Documento:</strong> ${usuarioInfo.documento || p.id_usuario || 'N/A'}</div>
                  <div><strong>üìã Ficha:</strong> ${usuarioInfo.numero_ficha || 'N/A'}</div>
                </div>
              </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `
              <div style="background:#f1f8f4; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #4caf50;">
                <div style="font-size:13px;">
                  <strong>üìö Elemento:</strong> ${elementoInfo.titulo || p.id_elemento.substring(0, 8) + '...'}<br>
                  ${elementoInfo.autor ? `<strong>üë§ Autor:</strong> ${elementoInfo.autor}` : ''}
                </div>
              </div>`;
          }
          
          card.innerHTML = `
            <div>
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div>
                  <div><strong>üÜî ID Pr√©stamo:</strong> <code style="background:#f5f5f5; padding:2px 6px; border-radius:4px;">${p.id}</code></div>
                  <div style="font-size:12px; color:#666; margin-top:4px;"><strong>Fecha pr√©stamo:</strong> ${new Date(p.fecha_prestamo).toLocaleString('es-ES')}</div>
                </div>
              </div>
              ${usuarioHtml}
              ${elementoHtml}
              <div style="margin-top:12px;">
                <button data-id="${p.id}" class="btn-devolver" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üì• Marcar Devuelto</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch (e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando aprobados</div>';
      }
    }

    async function filtrarAprobados() {
      const busqueda = document.getElementById('botBuscarAprobados').value.toLowerCase();
      const cards = document.querySelectorAll('#listaAprobados > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busqueda) ? 'block' : 'none';
      });
    }
    
    let tipoFiltroInventario = 'todos';
    function filtrarPorTipo(tipo) {
      tipoFiltroInventario = tipo;
      cargarInventario();
    }

    // Actualizar badge de mensajes en el header
    async function actualizarBadgeMensajes() {
      try {
        const res = await fetch('/api/mensajes?admin=true');
        const mensajes = res.ok ? await res.json() : [];
        const noLeidos = mensajes.filter(m => !m.leido && m.id_destinatario === 'admin').length;
        const badge = document.getElementById('badgeMensajesAdmin');
        if (badge) {
          if (noLeidos > 0) {
            badge.textContent = noLeidos;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch(e) {}
    }

    // Funciones de inventario
    async function cargarInventario(){
      const cont = document.getElementById('listaInventario');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        // Aplicar filtro de tipo si existe
        const res = await fetch('/api/libros');
        let items = res.ok ? await res.json() : [];
        
        // Filtrar por tipo (libro/PC/todos)
        if (tipoFiltroInventario === 'libro') {
          items = items.filter(x => {
            const cat = (x.categoria || '').toLowerCase();
            return cat === 'libros' || (!cat.includes('equipo') && !cat.includes('pc'));
          });
        } else if (tipoFiltroInventario === 'pc') {
          items = items.filter(x => {
            const cat = (x.categoria || '').toLowerCase();
            return cat.includes('equipo') || cat.includes('pc') || cat.includes('port√°til') || cat.includes('desktop') || cat.includes('tablet');
          });
        }
        // Si es 'todos', no filtrar por tipo
        
        // Aplicar otros filtros
        const fcat = (document.getElementById('fCat')?.value || '').toLowerCase();
        const fcod = (document.getElementById('fCodigo')?.value || '').toLowerCase();
        const ftit = (document.getElementById('fTitulo')?.value || '').toLowerCase();
        const filtrados = items.filter(x => 
          (!fcat || (x.categoria||'').toLowerCase().includes(fcat)) && 
          (!fcod || (x.codigo_inventario||'').toLowerCase().includes(fcod)) &&
          (!ftit || (x.titulo||'').toLowerCase().includes(ftit) || (x.autor||'').toLowerCase().includes(ftit))
        );
        if (!filtrados.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">Sin resultados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const it of filtrados) {
          const d = document.createElement('div');
          d.style.background = '#fff';
          d.style.padding = '12px';
          d.style.border = '1px solid #e1e8ed';
          d.style.borderRadius = '8px';
          d.style.marginBottom = '12px';
          d.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap;">
              <div style="flex:1;">
                <div><strong>${it.titulo || it.categoria || 'Elemento'}</strong> ${it.codigo_inventario ? `‚Äî <em>${it.codigo_inventario}</em>`:''}</div>
                <div style="color:#666; font-size:13px; margin-top:4px;">Cat: ${it.categoria || ''} | Sub: ${it.subcategoria || ''}</div>
                <div style="color:#666; font-size:13px;">Disp: ${it.cantidad_disponible}/${it.stock} | Prestados: ${it.cantidad_prestado}</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button onclick="location.href='detalle_libro.html?id=${it.id}'" style="background:#2196f3; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">Ver</button>
                <button onclick="eliminarLibro('${it.id}')" style="background:#dc3545; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">üóëÔ∏è</button>
              </div>
            </div>`;
          cont.appendChild(d);
        }
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando inventario</div>';
      }
    }

    async function eliminarLibro(id) {
      const result = await Swal.fire({
        icon: 'warning',
        title: '¬øEliminar libro?',
        html: 'Esta acci√≥n eliminar√° el libro y todas sus copias relacionadas.<br><br>‚ö†Ô∏è El historial de pr√©stamos se preservar√° para trazabilidad.',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        const res = await fetch(`/api/libros/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (res.ok && data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Eliminado',
            html: `Se eliminaron ${data.eliminados} registro(s) relacionado(s).<br><br>üìä Historial preservado: ${data.prestamos_preservados} pr√©stamo(s) hist√≥rico(s).`,
            timer: 3000,
            showConfirmButton: false
          });
          cargarInventario();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'No se pudo eliminar el libro'
          });
        }
      } catch(e) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error de conexi√≥n: ' + e.message
        });
      }
    }

    function mostrarConfirmEliminar() {
      document.getElementById('confirmEliminar').style.display = 'block';
      document.getElementById('confirmText').value = '';
    }

    function cancelarEliminar() {
      document.getElementById('confirmEliminar').style.display = 'none';
    }

    async function eliminarTodosLosLibros() {
      const confirmText = document.getElementById('confirmText').value;
      if (confirmText !== 'ELIMINAR TODO') {
        alert('Debes escribir exactamente: ELIMINAR TODO');
        return;
      }
      if (!confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esta acci√≥n eliminar√° TODOS los libros. Esta acci√≥n NO se puede deshacer.')) {
        return;
      }
      
      const confirmDiv = document.getElementById('confirmEliminar');
      
      try {
        const res = await fetch('/api/libros');
        const libros = res.ok ? await res.json() : [];
        
        if (libros.length === 0) {
          alert('No hay libros para eliminar');
          return;
        }
        
        // Crear barra de progreso
        confirmDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <strong>Eliminando todos los libros...</strong>
            <span id="porcentaje">0%</span>
          </div>
          <div style="background:#ccc; border-radius:10px; height:30px; overflow:hidden; position:relative; margin-bottom:10px;">
            <div id="barraProgreso" style="background:linear-gradient(90deg, #4caf50, #8bc34a); height:100%; width:0%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:14px;">
              0%
            </div>
          </div>
          <div style="font-size:14px; margin-bottom:10px;">
            <span id="contadorProgreso">0 / ${libros.length}</span> libros eliminados
          </div>
        `;
        
        let eliminados = 0;
        let errores = 0;
        
        for (let i = 0; i < libros.length; i++) {
          const libro = libros[i];
          try {
            const delRes = await fetch(`/api/libros/${libro.id}`, { method: 'DELETE' });
            if (delRes.ok) {
              const result = await delRes.json();
              // La nueva API devuelve cu√°ntos registros elimin√≥
              if (result.ok && result.eliminados) {
                eliminados += result.eliminados; // Sumar todos los registros eliminados
              } else {
                eliminados++;
              }
            } else {
              errores++;
              const errorData = await delRes.json().catch(() => ({}));
              console.error('Error eliminando', libro.id, errorData.error || 'Error desconocido');
            }
          } catch (e) {
            errores++;
            console.error('Error eliminando', libro.id, e);
          }
          
          // Actualizar progreso
          const porcentaje = Math.round(((i + 1) / libros.length) * 100);
          const barraProgreso = document.getElementById('barraProgreso');
          const porcentajeText = document.getElementById('porcentaje');
          const contadorProgreso = document.getElementById('contadorProgreso');
          
          if (barraProgreso) {
            barraProgreso.style.width = porcentaje + '%';
            barraProgreso.textContent = porcentaje + '%';
          }
          if (porcentajeText) porcentajeText.textContent = porcentaje + '%';
          if (contadorProgreso) contadorProgreso.textContent = `${i + 1} / ${libros.length} libros eliminados`;
          
          await new Promise(r => setTimeout(r, 50)); // Peque√±a pausa
        }
        
        confirmDiv.innerHTML = `
          <div style="background:#d4edda; padding:12px; border-radius:8px; color:#155724;">
            ‚úì Eliminaci√≥n completada<br>
            <strong>Total:</strong> ${libros.length}<br>
            <strong>Eliminados:</strong> ${eliminados}<br>
            <strong>Errores:</strong> ${errores}<br>
            <button onclick="cancelarEliminar(); cargarInventario();" style="background:#4caf50; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">Cerrar</button>
          </div>
        `;
        cargarInventario();
      } catch (e) {
        alert('Error al eliminar libros: ' + e.message);
      }
    }
    
    async function eliminarPorCategoriaAdmin() {
      try {
        // Obtener todas las categor√≠as √∫nicas de los elementos
        const resLibros = await fetch('/api/libros');
        const todosLosLibros = resLibros.ok ? await resLibros.json() : [];
        
        // Obtener categor√≠as √∫nicas
        const categoriasUnicas = [...new Set(todosLosLibros.map(l => l.categoria).filter(c => c))];
        
        if (categoriasUnicas.length === 0) {
          alert('No hay elementos con categor√≠as definidas');
          return;
        }
        
        // Crear modal de selecci√≥n
        const modalHtml = categoriasUnicas.map((c, i) => 
          `<button onclick="seleccionarCategoriaAdmin('${c}')" style="display:block; width:100%; padding:12px; margin:5px 0; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; text-align:left;">
            ${i + 1}. ${c}
          </button>`
        ).join('');
        
        const confirmDiv = document.getElementById('confirmEliminar');
        confirmDiv.style.display = 'block';
        confirmDiv.innerHTML = `
          <div style="margin-bottom:15px;">
            <strong>Selecciona la categor√≠a a eliminar:</strong>
          </div>
          ${modalHtml}
          <button onclick="cancelarEliminar()" style="background:#757575; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:15px; width:100%;">Cancelar</button>
        `;
      } catch (e) {
        alert('Error al cargar categor√≠as: ' + e.message);
      }
    }
    
    async function seleccionarCategoriaAdmin(categoria) {
      const confirmDiv = document.getElementById('confirmEliminar');
      
      try {
        const resLibros = await fetch('/api/libros');
        const todosLosLibros = resLibros.ok ? await resLibros.json() : [];
        
        const elementosAEliminar = todosLosLibros.filter(l => 
          l.categoria && l.categoria.toLowerCase() === categoria.toLowerCase()
        );
        
        if (elementosAEliminar.length === 0) {
          alert(`No hay elementos en la categor√≠a "${categoria}"`);
          cancelarEliminar();
          return;
        }
        
        if (!confirm(`¬øEliminar ${elementosAEliminar.length} elementos de la categor√≠a "${categoria}"?\n\n‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.`)) {
          cancelarEliminar();
          return;
        }
        
        // Crear barra de progreso
        confirmDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <strong>Eliminando "${categoria}"...</strong>
            <span id="porcentaje">0%</span>
          </div>
          <div style="background:#ccc; border-radius:10px; height:30px; overflow:hidden; position:relative; margin-bottom:10px;">
            <div id="barraProgreso" style="background:linear-gradient(90deg, #4caf50, #8bc34a); height:100%; width:0%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:14px;">
              0%
            </div>
          </div>
          <div style="font-size:14px; margin-bottom:10px;">
            <span id="contadorProgreso">0 / ${elementosAEliminar.length}</span> elementos eliminados
          </div>
        `;
        
        let eliminados = 0;
        let errores = 0;
        
        for (let i = 0; i < elementosAEliminar.length; i++) {
          const elem = elementosAEliminar[i];
          try {
            const delRes = await fetch(`/api/libros/${elem.id}`, { method: 'DELETE' });
            if (delRes.ok) {
              eliminados++;
            } else {
              errores++;
            }
          } catch (e) {
            errores++;
            console.error('Error eliminando', elem.id, e);
          }
          
          // Actualizar progreso
          const porcentaje = Math.round(((i + 1) / elementosAEliminar.length) * 100);
          const barraProgreso = document.getElementById('barraProgreso');
          const porcentajeText = document.getElementById('porcentaje');
          const contadorProgreso = document.getElementById('contadorProgreso');
          
          if (barraProgreso) {
            barraProgreso.style.width = porcentaje + '%';
            barraProgreso.textContent = porcentaje + '%';
          }
          if (porcentajeText) porcentajeText.textContent = porcentaje + '%';
          if (contadorProgreso) contadorProgreso.textContent = `${i + 1} / ${elementosAEliminar.length} elementos eliminados`;
          
          await new Promise(r => setTimeout(r, 50));
        }
        
        confirmDiv.innerHTML = `
          <div style="background:#d4edda; padding:12px; border-radius:8px; color:#155724;">
            ‚úì Eliminaci√≥n completada<br>
            <strong>Categor√≠a:</strong> ${categoria}<br>
            <strong>Total:</strong> ${elementosAEliminar.length}<br>
            <strong>Eliminados:</strong> ${eliminados}<br>
            <strong>Errores:</strong> ${errores}<br>
            <button onclick="cancelarEliminar(); cargarInventario();" style="background:#4caf50; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; margin-top:10px;">Cerrar</button>
          </div>
        `;
        cargarInventario();
      } catch (e) {
        alert('Error al eliminar por categor√≠a: ' + e.message);
      }
    }

    async function cargarEspera(){
      const cont = document.getElementById('listaEspera');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/espera');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay personas en espera.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const w of items) {
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '12px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap;">
              <div>
                <div><strong>ID Espera:</strong> ${w.id.substring(0, 8)}...</div>
                <div><strong>ID Elemento:</strong> ${w.id_elemento.substring(0, 8)}...</div>
                <div><strong>Contacto:</strong> ${w.contacto || w.id_usuario || ''}</div>
                <div><strong>Estado:</strong> <span style="color:${w.estado==='notificado'?'#4caf50':'#ff9800'}">${w.estado}</span></div>
              </div>
              <div>
                <button data-id="${w.id}" class="btn-notificar" ${w.estado==='notificado'?'disabled':''} style="background:#9c27b0; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; ${w.estado==='notificado'?'opacity:0.5; cursor:not-allowed;':''}">‚úÖ Marcar Notificado</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando espera</div>';
      }
    }

    async function cargarTrazabilidad() {
      const cont = document.getElementById('trazabilidadContent');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const estado = document.getElementById('filtroTrazabilidad').value;
        const url = estado ? `/prestamos?estado=${estado}` : '/prestamos';
        const res = await fetch(url);
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay pr√©stamos registrados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const p of items) {
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          const estadoColor = {
            'pendiente': '#ff9800',
            'aprobado': '#4caf50',
            'rechazado': '#f44336',
            'devuelto': '#2196f3'
          }[p.estado] || '#666';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `<div style="background:#e3f2fd; padding:8px; border-radius:6px; margin:8px 0; font-size:13px;">
              <strong>üë§ ${usuarioInfo.nombre || 'N/A'}</strong> - üÜî ${usuarioInfo.documento || p.id_usuario || 'N/A'}
            </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `<div style="background:#f1f8f4; padding:8px; border-radius:6px; margin:8px 0; font-size:13px;">
              <strong>üìö ${elementoInfo.titulo || p.id_elemento.substring(0, 12) + '...'}</strong>
              ${elementoInfo.codigo_inventario ? ` - üî¢ ${elementoInfo.codigo_inventario}` : ''}
            </div>`;
          }
          
          card.innerHTML = `
            <div style="display:grid; grid-template-columns: 1fr auto; gap:16px;">
              <div>
                <div style="margin-bottom:8px;"><strong>üÜî ID Pr√©stamo:</strong> <code>${p.id}</code></div>
                ${usuarioHtml}
                ${elementoHtml}
                <div style="margin-bottom:8px; font-size:13px;"><strong>üìÖ Fecha pr√©stamo:</strong> ${new Date(p.fecha_prestamo).toLocaleString('es-ES')}</div>
                ${p.fecha_devolucion ? `<div style="font-size:13px;"><strong>üì• Fecha devoluci√≥n:</strong> ${new Date(p.fecha_devolucion).toLocaleString('es-ES')}</div>` : ''}
                ${p.observaciones ? `<div style="margin-top:8px; padding:8px; background:#f5f5f5; border-radius:6px; font-size:13px;"><strong>üìù Observaciones:</strong> ${p.observaciones}</div>` : ''}
              </div>
              <div>
                <span style="background:${estadoColor}; color:white; padding:8px 16px; border-radius:20px; font-weight:600; text-transform:uppercase; display:inline-block;">${p.estado}</span>
              </div>
            </div>`;
          cont.appendChild(card);
        }
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando trazabilidad</div>';
      }
    }

    function bindAcciones(){
      document.querySelectorAll('.btn-aprobar').forEach(b => {
        // Remover listeners anteriores para evitar duplicados
        const nuevoBtn = b.cloneNode(true);
        b.parentNode.replaceChild(nuevoBtn, b);
        
        nuevoBtn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('¬øAprobar este pr√©stamo?')) return;
          
          try {
        const res = await fetch(`/prestamos/${id}/aprobar`, { method: 'PUT' });
            const data = await res.json().catch(()=>({}));
            
            if (res.ok && data.ok) {
              alert('‚úÖ Pr√©stamo aprobado correctamente');
              // Recargar ambas secciones
              await Promise.all([cargarPendientes(), cargarAprobados()]);
            } else {
              alert('‚ùå ' + (data.error || 'No se pudo aprobar'));
            }
          } catch (err) {
            alert('Error de conexi√≥n: ' + err.message);
          }
        });
      });
      document.querySelectorAll('.btn-rechazar').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        if (!confirm('¬øRechazar esta solicitud?')) return;
        const res = await fetch(`/prestamos/${id}/rechazar`, { method: 'PUT' });
        if (res.ok) {
          alert('‚ùå Rechazado');
          cargarPendientes();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo rechazar'));
        }
      }));
      document.querySelectorAll('.btn-devolver').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const res = await fetch(`/prestamos/${id}/devolver`, { method: 'PUT' });
        if (res.ok) {
          alert('üì• Devuelto');
          cargarAprobados();
          cargarEspera();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo marcar devuelto'));
        }
      }));
      document.querySelectorAll('.btn-notificar').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const res = await fetch(`/espera/${id}/notificar`, { method: 'PUT' });
        if (res.ok) {
          alert('‚úÖ Marcado como notificado');
          cargarEspera();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo marcar'));
        }
      }));
    }

    // Protecci√≥n: solo admins
    (function(){
      const t = localStorage.getItem('token');
      if (t !== 'admin-token') {
        alert('Acceso restringido a administradores');
        window.location.href = 'principal.html';
      }
    })();

    document.getElementById('formImport')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const res = await fetch('/import/csv', { method: 'POST', body: fd });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.ok) {
        alert(`‚úÖ Importados: ${data.creados} | Actualizados: ${data.actualizados || 0}`);
        cargarInventario();
      } else {
        alert('‚ùå ' + (data.error || 'No se pudo importar'));
      }
    });

    document.getElementById('btnBuscar')?.addEventListener('click', cargarInventario);

    // Funciones de gesti√≥n de usuarios
    async function cargarUsuarios() {
      const cont = document.getElementById('listaUsuarios');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/api/usuarios');
        const usuarios = res.ok ? await res.json() : [];
        if (!usuarios.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay usuarios registrados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const u of usuarios) {
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          const roleBadge = u.role === 'admin' ? '<span style="background:#f44336; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">ADMIN</span>' : '<span style="background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">USUARIO</span>';
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                  <strong>${u.nombre}</strong> ${roleBadge}
                </div>
                <div style="color:#666; font-size:13px;">
                  <div>üÜî Documento: ${u.documento}</div>
                  <div>üë§ Username: ${u.username}</div>
                  ${u.correo ? `<div>‚úâÔ∏è Correo: ${u.correo}</div>` : ''}
                  ${u.numero_ficha ? `<div>üìã Ficha: ${u.numero_ficha}</div>` : ''}
                  <div style="margin-top:4px; font-size:11px; color:#999;">Registrado: ${u.creado_en ? new Date(u.creado_en).toLocaleDateString('es-ES') : 'N/A'}</div>
                </div>
              </div>
              <div style="display:flex; gap:8px;">
                <button onclick="editarUsuario('${u.id}', '${u.nombre.replace(/'/g, "\\'")}', '${u.documento}', '${u.correo || ''}', '${u.username}', '${u.role}')" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">‚úèÔ∏è Editar</button>
                ${u.username !== 'admin' ? `<button onclick="eliminarUsuario('${u.id}', '${u.nombre.replace(/'/g, "\\'")}')" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">üóëÔ∏è Eliminar</button>` : ''}
              </div>
            </div>`;
          cont.appendChild(card);
        }
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando usuarios</div>';
      }
    }

    function filtrarUsuarios() {
      const busqueda = document.getElementById('buscarUsuarios').value.toLowerCase();
      const cards = document.querySelectorAll('#listaUsuarios > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busqueda) ? 'block' : 'none';
      });
    }

    function abrirModalUsuario() {
      document.getElementById('modalUsuarioTitulo').textContent = 'Agregar Usuario';
      document.getElementById('formUsuario').reset();
      document.getElementById('usuarioIdEdit').value = '';
      document.getElementById('usuarioPassword').required = true;
      document.getElementById('passwordLabel').textContent = '(requerida)';
      document.getElementById('modalUsuario').style.display = 'flex';
    }

    function editarUsuario(id, nombre, documento, correo, username, role) {
      document.getElementById('modalUsuarioTitulo').textContent = 'Editar Usuario';
      document.getElementById('usuarioIdEdit').value = id;
      document.getElementById('usuarioNombre').value = nombre;
      document.getElementById('usuarioDocumento').value = documento;
      document.getElementById('usuarioCorreo').value = correo || '';
      document.getElementById('usuarioUsername').value = username;
      document.getElementById('usuarioRole').value = role;
      document.getElementById('usuarioPassword').value = '';
      document.getElementById('usuarioPassword').required = false;
      document.getElementById('passwordLabel').textContent = '(dejar vac√≠o para no cambiar)';
      document.getElementById('modalUsuario').style.display = 'flex';
    }

    async function guardarUsuario(e) {
      e.preventDefault();
      const id = document.getElementById('usuarioIdEdit').value;
      const data = {
        nombre: document.getElementById('usuarioNombre').value,
        documento: document.getElementById('usuarioDocumento').value,
        correo: document.getElementById('usuarioCorreo').value,
        username: document.getElementById('usuarioUsername').value,
        role: document.getElementById('usuarioRole').value
      };
      
      const password = document.getElementById('usuarioPassword').value;
      if (password) {
        data.password = password;
      }
      
      try {
        let res;
        if (id) {
          res = await fetch(`/api/usuarios/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          if (!password) {
            alert('La contrase√±a es requerida para nuevos usuarios');
            return;
          }
          res = await fetch('/api/usuarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        const result = await res.json();
        if (res.ok && result.ok !== false) {
          alert('Usuario guardado correctamente');
          cerrarModalUsuario();
          cargarUsuarios();
        } else {
          alert('Error: ' + (result.error || 'No se pudo guardar'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function eliminarUsuario(id, nombre) {
      if (!confirm(`¬øEst√°s seguro de eliminar al usuario "${nombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) return;
      try {
        const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok && result.ok !== false) {
          alert('Usuario eliminado correctamente');
          cargarUsuarios();
        } else {
          alert('Error: ' + (result.error || 'No se pudo eliminar'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function cerrarModalUsuario() {
      document.getElementById('modalUsuario').style.display = 'none';
    }

    // ==================== GESTI√ìN DE TIPOS DE SANCI√ìN ====================
    
    // Contador de caracteres para descripci√≥n (se inicializa cuando se abre el modal)
    function inicializarContadorDescripcion() {
      const descripcionInput = document.getElementById('sancionTipoDescripcion');
      const contador = document.getElementById('contadorDescripcion');
      if (descripcionInput && contador) {
        descripcionInput.addEventListener('input', function() {
          contador.textContent = this.value.length;
          if (this.value.length < 5) {
            contador.style.color = '#f44336';
          } else if (this.value.length > 120) {
            contador.style.color = '#f44336';
          } else {
            contador.style.color = '#666';
          }
        });
      }
    }

    async function cargarSancionTipos() {
      const lista = document.getElementById('listaSancionTipos');
      if (!lista) return;
      
      lista.innerHTML = 'Cargando tipos de sanci√≥n...';
      
      try {
        const res = await fetch('/api/sancion-tipos');
        if (!res.ok) {
          lista.innerHTML = '<div style="padding:20px; color:#f44336;">Error al cargar tipos de sanci√≥n</div>';
          return;
        }
        
        const tipos = await res.json();
        
        if (tipos.length === 0) {
          lista.innerHTML = '<div style="padding:40px; text-align:center; color:#666; background:white; border-radius:8px; border:2px dashed #ddd;">No hay tipos de sanci√≥n registrados.<br><br>Haz clic en "‚ûï Agregar Tipo de Sanci√≥n" para crear uno.</div>';
          return;
        }
        
        let html = '<div style="display:grid; gap:12px;">';
        tipos.forEach(tipo => {
          html += `
            <div style="background:white; padding:16px; border-radius:8px; border-left:4px solid #f44336; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                <div>
                  <h4 style="margin:0 0 4px 0; color:#333; font-size:18px;">
                    <code style="background:#f5f5f5; padding:4px 8px; border-radius:4px; font-weight:bold; color:#f44336;">${tipo.codigo}</code>
                  </h4>
                  <p style="margin:8px 0; color:#666; font-size:14px;">${tipo.descripcion}</p>
                  <div style="font-size:12px; color:#999; margin-top:8px;">
                    Creado: ${new Date(tipo.creado_en).toLocaleDateString('es-ES')} 
                    ${tipo.usuario_creacion ? `| Por: ${tipo.usuario_creacion}` : ''}
                  </div>
                </div>
                <div style="display:flex; gap:8px;">
                  <button onclick="editarSancionTipo('${tipo.id}')" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px;">‚úèÔ∏è Editar</button>
                  <button onclick="eliminarSancionTipo('${tipo.id}', '${tipo.codigo}')" style="background:#f44336; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px;">üóëÔ∏è Eliminar</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        lista.innerHTML = html;
      } catch (e) {
        lista.innerHTML = '<div style="padding:20px; color:#f44336;">Error de conexi√≥n al cargar tipos de sanci√≥n</div>';
        console.error('Error:', e);
      }
    }

    function abrirModalSancionTipo(id = null) {
      const modal = document.getElementById('modalSancionTipo');
      const titulo = document.getElementById('modalSancionTipoTitulo');
      const form = document.getElementById('formSancionTipo');
      const codigoInput = document.getElementById('sancionTipoCodigo');
      const descripcionInput = document.getElementById('sancionTipoDescripcion');
      const idInput = document.getElementById('sancionTipoId');
      
      if (id) {
        // Modo edici√≥n
        titulo.textContent = '‚úèÔ∏è Editar Tipo de Sanci√≥n';
        idInput.value = id;
        
        // Cargar datos
        fetch(`/api/sancion-tipos/${id}`)
          .then(res => res.json())
          .then(tipo => {
            codigoInput.value = tipo.codigo;
            descripcionInput.value = tipo.descripcion;
            document.getElementById('contadorDescripcion').textContent = tipo.descripcion.length;
          })
          .catch(e => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo cargar el tipo de sanci√≥n'
            });
          });
      } else {
        // Modo creaci√≥n
        titulo.textContent = '‚ûï Agregar Tipo de Sanci√≥n';
        idInput.value = '';
        form.reset();
        document.getElementById('contadorDescripcion').textContent = '0';
      }
      
      modal.style.display = 'flex';
      codigoInput.focus();
      
      // Inicializar contador de descripci√≥n
      inicializarContadorDescripcion();
      
      // Actualizar contador si hay valor
      if (descripcionInput.value) {
        const contador = document.getElementById('contadorDescripcion');
        if (contador) {
          contador.textContent = descripcionInput.value.length;
        }
      }
    }

    function cerrarModalSancionTipo() {
      document.getElementById('modalSancionTipo').style.display = 'none';
      document.getElementById('formSancionTipo').reset();
      document.getElementById('sancionTipoId').value = '';
      document.getElementById('contadorDescripcion').textContent = '0';
    }

    async function guardarSancionTipo(e) {
      e.preventDefault();
      
      const id = document.getElementById('sancionTipoId').value;
      const codigo = document.getElementById('sancionTipoCodigo').value.trim();
      const descripcion = document.getElementById('sancionTipoDescripcion').value.trim();
      
      if (!codigo || !descripcion) {
        Swal.fire({
          icon: 'warning',
          title: 'Campos requeridos',
          text: 'Por favor completa todos los campos'
        });
        return;
      }
      
      const data = {
        codigo: codigo,
        descripcion: descripcion
      };
      
      try {
        let res;
        if (id) {
          // Actualizar
          res = await fetch(`/api/sancion-tipos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Crear
          res = await fetch('/api/sancion-tipos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        const result = await res.json();
        
        if (res.ok && result.ok !== false) {
          Swal.fire({
            icon: 'success',
            title: '¬°√âxito!',
            text: id ? 'Tipo de sanci√≥n actualizado correctamente' : 'Tipo de sanci√≥n creado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
          cerrarModalSancionTipo();
          cargarSancionTipos();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.error || 'No se pudo guardar el tipo de sanci√≥n'
          });
        }
      } catch (e) {
        Swal.fire({
          icon: 'error',
          title: 'Error de conexi√≥n',
          text: e.message
        });
      }
    }

    async function editarSancionTipo(id) {
      abrirModalSancionTipo(id);
    }

    async function eliminarSancionTipo(id, codigo) {
      const result = await Swal.fire({
        icon: 'warning',
        title: '¬øEliminar tipo de sanci√≥n?',
        html: `¬øEst√°s seguro de eliminar el tipo de sanci√≥n <strong>${codigo}</strong>?<br><br>‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`,
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
      });
      
      if (result.isConfirmed) {
        try {
          const res = await fetch(`/api/sancion-tipos/${id}`, { method: 'DELETE' });
          const data = await res.json();
          
          if (res.ok && data.ok !== false) {
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'Tipo de sanci√≥n eliminado correctamente',
              timer: 2000,
              showConfirmButton: false
            });
            cargarSancionTipos();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'No se pudo eliminar el tipo de sanci√≥n'
            });
          }
        } catch (e) {
          Swal.fire({
            icon: 'error',
            title: 'Error de conexi√≥n',
            text: e.message
          });
        }
      }
    }

    // Actualizar badge de mensajes cada 10 segundos
    setInterval(actualizarBadgeMensajes, 10000);

    // Cargar pendientes al inicio (por defecto)
    cargarPendientes();
    actualizarBadgeMensajes();
  </script>
</body>
</html>
