<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    .admin-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .admin-tab {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      position: relative;
    }
    .admin-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }
    .admin-tab:hover:not(.active) {
      background: #f0f0f0;
    }
    .admin-tab .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f44336;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .section-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    .section-content.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .usuario-info {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      margin-top: 8px;
      border-left: 4px solid #2196f3;
    }
    .mensajes-panel {
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      max-height: 500px;
      overflow-y: auto;
    }
    .mensaje-item {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .mensaje-item:hover {
      background: #f5f5f5;
    }
    .mensaje-item.no-leido {
      background: #fff3cd;
      font-weight: 600;
    }
    .btn-conectar {
      background: #9c27b0;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 12px;
    }
    .eliminar-todo-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .bot-busqueda {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .resource-shell {
      display:grid;
      gap:24px;
      grid-template-columns:minmax(0,1.35fr) minmax(0,1fr);
      align-items:start;
    }
    .inventory-panel,
    .resource-editor {
      background:#ffffff;
      border-radius:20px;
      border:1px solid rgba(102,126,234,0.12);
      box-shadow:0 18px 36px rgba(15,37,77,0.08);
      padding:24px;
    }
    .inventory-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:18px;
    }
    .inventory-header h3 {
      margin:0;
      font-size:22px;
      color:#1c2751;
    }
    .inventory-header p {
      margin:6px 0 0;
      color:#5a6685;
      font-size:14px;
    }
    .resource-heading__refresh {
      background:#2196f3;
      color:#ffffff;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 12px 28px rgba(33,150,243,0.25);
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .resource-heading__refresh:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(33,150,243,0.32);
    }
    .inventory-tools {
      display:grid;
      gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    .inventory-tools label {
      font-size:12px;
      font-weight:600;
      color:#42526e;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .inventory-tools input {
      border:1px solid rgba(102,126,234,0.2);
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    .inventory-tools input:focus {
      outline:none;
      border-color:rgba(102,126,234,0.55);
      box-shadow:0 0 0 3px rgba(102,126,234,0.18);
    }
    .resource-chips {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:18px 0 6px;
    }
    .resource-chips .chip {
      border:none;
      background:rgba(102,126,234,0.14);
      color:#4059ad;
      padding:8px 16px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .resource-chips .chip:hover {
      background:rgba(102,126,234,0.22);
      transform:translateY(-1px);
    }
    .resource-chips .chip.is-active {
      background:linear-gradient(135deg, #667eea, #764ba2);
      color:#ffffff;
      box-shadow:0 12px 26px rgba(102,126,234,0.3);
    }
    .inventory-actions {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .inventory-actions button {
      border:none;
      border-radius:12px;
      padding:10px 16px;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .inventory-actions button.primary {
      background:linear-gradient(135deg, #42a5f5, #7b61ff);
      color:#ffffff;
      box-shadow:0 12px 28px rgba(66,165,245,0.25);
    }
    .inventory-actions button.primary:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(66,165,245,0.32);
    }
    .inventory-actions button.ghost {
      background:rgba(102,126,234,0.1);
      color:#4059ad;
    }
    .inventory-actions button.ghost:hover {
      background:rgba(102,126,234,0.16);
    }
    .inventory-list {
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .inventory-empty {
      background:#f5f8ff;
      border:1px dashed rgba(102,126,234,0.35);
      border-radius:18px;
      padding:32px;
      text-align:center;
      color:#56617e;
      font-weight:600;
    }
    .resource-editor {
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .editor-tabs {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .editor-tabs button {
      border:none;
      border-radius:12px;
      padding:10px 16px;
      font-weight:600;
      background:rgba(102,126,234,0.12);
      color:#4059ad;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .editor-tabs button.is-active {
      background:linear-gradient(135deg, #667eea, #764ba2);
      color:#ffffff;
      box-shadow:0 12px 26px rgba(102,126,234,0.28);
    }
    .resource-form-block {
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .resource-form-grid {
      display:grid;
      gap:14px;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    }
    .resource-form-grid label {
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      font-weight:600;
      color:#42526e;
    }
    .resource-form-grid input,
    .resource-form-grid select,
    .resource-form-grid textarea {
      border:1px solid rgba(102,126,234,0.22);
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      background:#f9faff;
      transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    .resource-form-grid input:focus,
    .resource-form-grid select:focus,
    .resource-form-grid textarea:focus {
      outline:none;
      border-color:rgba(102,126,234,0.55);
      box-shadow:0 0 0 3px rgba(102,126,234,0.18);
      background:#ffffff;
    }
    .resource-form-grid textarea {
      min-height:90px;
      resize:vertical;
    }
    .resource-form-grid .full-width {
      grid-column:1 / -1;
    }
    .resource-editor button[type="submit"] {
      align-self:flex-end;
      border:none;
      border-radius:14px;
      padding:12px 24px;
      font-weight:700;
      background:linear-gradient(135deg, #42a5f5, #7b61ff);
      color:#ffffff;
      box-shadow:0 14px 32px rgba(66,165,245,0.28);
      cursor:pointer;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .resource-editor button[type="submit"]:hover {
      transform:translateY(-1px);
      box-shadow:0 18px 38px rgba(66,165,245,0.35);
    }
    .resource-grid {
      display:grid;
      gap:16px;
    }
    .resource-chips {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 0 0 18px 0;
    }
    .resource-chips .chip {
      border:none;
      background: rgba(102,126,234,0.12);
      color:#42526e;
      padding:8px 16px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    .resource-chips .chip:hover {
      background: rgba(102,126,234,0.22);
      transform: translateY(-1px);
    }
    .resource-chips .chip.is-active {
      background:linear-gradient(135deg, #667eea, #764ba2);
      color:#fff;
      box-shadow:0 10px 24px rgba(102,126,234,0.25);
    }
    .inventory-card {
      position:relative;
      background:#ffffff;
      border-radius:20px;
      border:1px solid rgba(102,126,234,0.12);
      box-shadow:0 18px 32px rgba(15,37,77,0.08);
      padding:22px 26px;
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow:hidden;
    }
    .inventory-card::before {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
      opacity:0.8;
      pointer-events:none;
    }
    .inventory-card > * {
      position:relative;
      z-index:1;
    }
    .inventory-card__header {
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .inventory-card__title {
      margin:0;
      font-size:20px;
      color:#1b2559;
      font-weight:700;
    }
    .inventory-card__meta {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:13px;
      color:#546e7a;
    }
    .inventory-card__badge {
      background:rgba(102,126,234,0.18);
      color:#4059ad;
      padding:6px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.6px;
    }
    .inventory-card__subbadge {
      background:rgba(69,170,242,0.16);
      color:#0b74b5;
      padding:6px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:12px;
    }
    .inventory-card__status {
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:13px;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(76,175,80,0.16);
      color:#1b5e20;
    }
    .inventory-card__status--alert {
      background:rgba(244,67,54,0.16);
      color:#b71c1c;
    }
    .inventory-card__description {
      font-size:14px;
      color:#455a64;
      line-height:1.5;
      margin:0;
    }
    .inventory-card__stats {
      display:grid;
      gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
    .inventory-card__stat {
      background:rgba(255,255,255,0.75);
      border-radius:14px;
      padding:12px 14px;
      border:1px solid rgba(102,126,234,0.16);
      box-shadow:0 12px 22px rgba(15,37,77,0.06);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .inventory-card__stat span {
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.6px;
      color:#6b7b93;
      font-weight:600;
    }
    .inventory-card__stat strong {
      font-size:18px;
      color:#29365a;
    }
    .inventory-card__progress {
      position:relative;
      height:8px;
      border-radius:999px;
      background:rgba(102,126,234,0.16);
      overflow:hidden;
    }
    .inventory-card__progress div {
      position:absolute;
      top:0;
      left:0;
      bottom:0;
      border-radius:999px;
      background:linear-gradient(135deg, #42a5f5, #5c6bc0);
    }
    .inventory-card__footer {
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .inventory-card__footer button {
      border:none;
      border-radius:10px;
      padding:10px 16px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .inventory-card__footer button:hover {
      transform: translateY(-1px);
      box-shadow:0 12px 24px rgba(33,150,243,0.2);
    }
    @media (min-width: 768px) {
      .resource-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }
    }
    .resource-item {
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(33,150,243,0.18);
      box-shadow:0 16px 32px rgba(33,150,243,0.12);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
      overflow:hidden;
    }
    .resource-item::after {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(33,150,243,0.12), rgba(118,75,162,0.12));
      opacity:0.6;
      pointer-events:none;
    }
    .resource-item__header,
    .resource-item__footer {
      position:relative;
      z-index:1;
    }
    .resource-item__title {
      font-size:18px;
      font-weight:700;
      color:#0d47a1;
      margin:0;
    }
    .resource-item__meta {
      margin-top:6px;
      color:#37474f;
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .resource-item__status {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:rgba(76,175,80,0.16);
      color:#1b5e20;
      padding:6px 12px;
      border-radius:999px;
      font-weight:600;
    }
    .resource-item__status--no {
      background:rgba(244,67,54,0.16);
      color:#b71c1c;
    }
    .resource-item__actions {
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .resource-empty {
      background:#f5f8ff;
      border:1px dashed rgba(102,126,234,0.4);
      border-radius:18px;
      padding:40px;
      text-align:center;
      color:#455a64;
    }
    @media (max-width: 1024px) {
      .admin-header {
        padding: 16px;
        text-align: center;
      }
      .admin-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .admin-tab {
        flex: 0 0 auto;
        min-width: 140px;
      }
      main {
        padding: 0 4vw 40px;
      }
      .mensajes-panel {
        max-height: none;
      }
      .resource-heading {
        flex-direction:column;
        align-items:flex-start;
      }
      .resource-heading__refresh {
        align-self:stretch;
        text-align:center;
      }
      .resource-card {
        padding:20px;
      }
      .resource-board,
      .resource-board--two {
        grid-template-columns:1fr;
      }
    }
    @media (max-width: 768px) {
      .admin-header {
        border-radius: 0;
      }
      .admin-tabs {
        gap: 6px;
        padding-bottom: 6px;
      }
      .admin-tab {
        padding: 10px 14px;
        font-size: 14px;
      }
      .bot-busqueda {
        padding: 12px;
      }
      .bot-busqueda input,
      .bot-busqueda button {
        width: 100%;
      }
      .bot-busqueda div {
        flex-direction: column;
      }
      .resource-card__title {
        font-size:18px;
      }
      .resource-summary__item {
        flex-direction:column;
        align-items:flex-start;
        gap:4px;
      }
    }
  </style>
</head>
<body>
  {% set active_page = 'admin' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarPanel' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <div class="admin-top-actions" style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between; background:rgba(102,126,234,0.12); border:1px solid rgba(102,126,234,0.2); padding:18px 20px; border-radius:16px; margin-bottom:20px;">
      <div>
        <h1 style="margin:0; font-size:26px; color:#2c3e50;">‚öôÔ∏è Panel de Administraci√≥n</h1>
        <p style="margin:6px 0 0; color:#546e7a;">Control centralizado para gestionar pr√©stamos, cat√°logos y usuarios.</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a href="principal.html" style="background:#546e7a; color:white; padding:10px 16px; border-radius:10px; text-decoration:none; font-weight:600; display:inline-flex; align-items:center; gap:8px;">
          ‚Üê Volver al inicio
        </a>
        <a href="admin_mensajes.html" style="background:#667eea; color:white; padding:10px 16px; border-radius:10px; text-decoration:none; font-weight:600; display:inline-flex; align-items:center; position:relative; gap:8px;">
          üí¨ Mensajes
          <span id="badgeMensajesAdmin" style="display:none; position:absolute; top:-10px; right:-10px; background:#f44336; color:white; border-radius:50%; width:22px; height:22px; font-size:11px; display:flex; align-items:center; justify-content:center; font-weight:bold;">0</span>
        </a>
      </div>
    </div>

    <div class="admin-header">
      <div class="admin-tabs">
        <div class="admin-tab active" data-section="pendientes">
          ‚è≥ Solicitudes Pendientes
          <span class="badge" id="badgePendientes" style="display:none;">0</span>
        </div>
        <div class="admin-tab" data-section="aprobados">‚úÖ Pr√©stamos Aprobados</div>
        <div class="admin-tab" data-section="recursos">üì¶ Gesti√≥n de Recursos</div>
        <div class="admin-tab" data-section="trazabilidad">üìä Trazabilidad</div>
        <div class="admin-tab" data-section="espera">
          üìã Lista de Espera
          <div style="font-size:11px; opacity:0.9; margin-top:2px;">(Cuando no hay stock)</div>
        </div>
        <div class="admin-tab" data-section="usuarios">üë• Gesti√≥n de Usuarios</div>
        <div class="admin-tab" data-section="sanciones">‚ö†Ô∏è Tipos de Sanci√≥n</div>
        <div class="admin-tab" data-section="importar">üì• Importar CSV/Excel</div>
      </div>
    </div>

    <!-- Secci√≥n: Solicitudes Pendientes -->
    <div id="section-pendientes" class="section-content active">
      <div class="bot-busqueda">
        <strong>üîç B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="botBuscarPendientes" placeholder="Buscar por ID pr√©stamo, nombre, documento, ficha..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <button onclick="filtrarPendientes()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">üîç Buscar</button>
        </div>
        <small style="color:#666; font-size:12px; margin-top:4px; display:block;">Puedes buscar por ID de pr√©stamo completo o parcial, nombre del usuario, documento o n√∫mero de ficha</small>
      </div>
      <h3 style="border-left:4px solid #ff9800; padding-left:12px;">‚è≥ Pr√©stamos Pendientes</h3>
      <div id="listaPendientes" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Solicitudes Aprobadas -->
    <div id="section-aprobados" class="section-content">
      <div class="bot-busqueda">
        <strong>ü§ñ Bot de B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="botBuscarAprobados" placeholder="Buscar por nombre, documento, elemento..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" />
          <button onclick="filtrarAprobados()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">üîç Buscar</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #4caf50; padding-left:12px;">‚úÖ Pr√©stamos Aprobados</h3>
      <div id="listaAprobados" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Gesti√≥n de Recursos -->
    <div id="section-recursos" class="section-content">
      <div class="resource-shell">
        <section class="inventory-panel">
          <div class="inventory-header">
            <div>
              <h3>üì¶ Inventario actual</h3>
              <p>Busca y revisa los recursos registrados en segundos.</p>
            </div>
            <button type="button" class="resource-heading__refresh" onclick="cargarRecursos()">‚ü≥ Actualizar lista</button>
          </div>

          <div class="inventory-tools">
            <label for="fCat">Filtrar por categor√≠a
              <input id="fCat" placeholder="Ej: Libros, Equipos..." />
            </label>
            <label for="fCodigo">C√≥digo o identificador
              <input id="fCodigo" placeholder="C√≥digo interno, barras o inventario" />
            </label>
            <label for="fTitulo">T√≠tulo o palabra clave
              <input id="fTitulo" placeholder="T√≠tulo, autor o descripci√≥n..." />
            </label>
          </div>

          <div class="resource-chips" id="inventoryFilters">
            <button type="button" class="chip is-active" data-filter="todos">Todo</button>
            <button type="button" class="chip" data-filter="libro">Solo libros</button>
            <button type="button" class="chip" data-filter="pc">Solo equipos</button>
          </div>

          <div class="inventory-actions">
            <button type="button" class="primary" id="btnBuscar">üîç Buscar</button>
            <button type="button" class="ghost" id="btnLimpiarFiltros">Limpiar filtros</button>
          </div>

          <div id="listaInventario" class="inventory-list"></div>
        </section>

        <aside class="resource-editor">
          <div class="editor-tabs" id="editorTabs">
            <button type="button" class="is-active" data-target="formLibro">Registrar libro</button>
            <button type="button" data-target="formPortatil">Registrar port√°til</button>
          </div>

          <form id="formLibro" class="resource-form-block" enctype="multipart/form-data">
            <input type="hidden" name="categoria" value="Libros">
            <input type="hidden" name="cantidad_disponible" value="1">
            <input type="hidden" name="cantidad_prestado" value="0">
            <div class="resource-form-grid">
              <label>T√≠tulo *
                <input type="text" name="titulo" required placeholder="Ej: El principito">
              </label>

              <label>Autor *
                <input type="text" name="autor" required placeholder="Nombre del autor">
              </label>

              <label>C√≥digo de barras / inventario
                <input type="text" name="codigo_inventario" placeholder="Opcional, para identificar copias">
              </label>

              <label>A√±o de publicaci√≥n
                <input type="number" name="anio_publicacion" min="0" placeholder="Ej: 2023">
              </label>

              <label class="full-width">Descripci√≥n
                <textarea name="descripcion" placeholder="A√±ade una rese√±a breve o notas importantes"></textarea>
              </label>

              <label>Unidades disponibles *
                <input type="number" name="stock" min="1" value="1" required>
              </label>

              <label>Estado del recurso
                <select name="estado_disponibilidad">
                <option value="Disponible" selected>Disponible</option>
                <option value="No disponible">No disponible</option>
                </select>
              </label>

              <label class="full-width">Imagen (opcional)
                <input type="file" name="imagen" accept="image/*">
              </label>
            </div>
            <button type="submit">üíæ Guardar libro</button>
          </form>

          <form id="formPortatil" class="resource-form-block" enctype="multipart/form-data" style="display:none;">
            <input type="hidden" name="categoria" value="Equipos Inform√°ticos">
            <input type="hidden" name="subcategoria" value="Port√°tiles">
            <input type="hidden" name="autor" value="">
            <input type="hidden" name="cantidad_disponible" value="1">
            <input type="hidden" name="cantidad_prestado" value="0">
            <div class="resource-form-grid">
              <label>C√≥digo interno *
                <input type="text" name="codigo_interno" required placeholder="Ej: PTL-024">
              </label>

              <label>N√∫mero de serie *
                <input type="text" name="numero_serie" required placeholder="Serie del fabricante">
              </label>

              <label>Placa SENA *
                <input type="text" name="placa_sena" required placeholder="C√≥digo patrimonial">
              </label>

              <label>Marca
                <input type="text" name="marca" placeholder="Ej: Lenovo">
              </label>

              <label>Modelo
                <input type="text" name="modelo" placeholder="Ej: ThinkPad L14">
              </label>

              <label>Unidades disponibles *
                <input type="number" name="stock" min="1" value="1" required>
              </label>

              <label>Estado del equipo
                <select name="estado_disponibilidad">
                <option value="Disponible" selected>Disponible</option>
                <option value="No disponible">No disponible</option>
                </select>
              </label>

              <label class="full-width">Especificaciones
                <textarea name="especificaciones" placeholder="Procesador, RAM, accesorios incluidos..."></textarea>
              </label>

              <label class="full-width">Descripci√≥n adicional
                <textarea name="descripcion" placeholder="Notas u observaciones relevantes"></textarea>
              </label>

              <label class="full-width">Imagen (opcional)
                <input type="file" name="imagen" accept="image/*">
              </label>
            </div>
            <button type="submit">üíæ Guardar port√°til</button>
          </form>
        </aside>
      </div>
    </div>

    <!-- Secci√≥n: Trazabilidad -->
    <div id="section-trazabilidad" class="section-content">
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üìä Trazabilidad de Pr√©stamos</h3>
      <div style="background:#fff; padding:16px; border:1px solid #e1e8ed; border-radius:8px; margin-top:16px;">
        <div style="display:flex; gap:8px; margin-bottom:16px;">
          <select id="filtroTrazabilidad" style="padding:10px; border:1px solid #ddd; border-radius:6px;">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendientes</option>
            <option value="aprobado">Aprobados</option>
            <option value="rechazado">Rechazados</option>
            <option value="devuelto">Devueltos</option>
          </select>
          <button onclick="cargarTrazabilidad()" style="background:#9c27b0; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üîç Ver</button>
        </div>
        <div id="trazabilidadContent"></div>
      </div>
    </div>

    <!-- Secci√≥n: Lista de Espera -->
    <div id="section-espera" class="section-content">
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üìã Lista de Espera</h3>
      <div id="listaEspera" class="relacionados-grid" style="grid-template-columns: 1fr; gap: 12px; margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Gesti√≥n de Usuarios -->
    <div id="section-usuarios" class="section-content">
      <div class="bot-busqueda">
        <strong>üîç B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="buscarUsuarios" placeholder="Buscar por nombre, documento, username, correo..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" onkeyup="filtrarUsuarios()" />
          <button onclick="abrirModalUsuario()" style="background:#4caf50; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ûï Agregar Usuario</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #9c27b0; padding-left:12px;">üë• Gesti√≥n de Usuarios</h3>
      <div id="listaUsuarios" style="margin-top:16px;"></div>
    </div>

    <!-- Secci√≥n: Tipos de Sanci√≥n -->
    <div id="section-sanciones" class="section-content">
      <div class="bot-busqueda">
        <strong>üîç B√∫squeda:</strong>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <input type="text" id="buscarSancionTipos" placeholder="Buscar por c√≥digo o descripci√≥n..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;" onkeyup="filtrarSancionTipos()" />
          <button onclick="abrirModalSancionTipo()" style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ûï Agregar Tipo de Sanci√≥n</button>
        </div>
      </div>
      <h3 style="border-left:4px solid #f44336; padding-left:12px;">‚ö†Ô∏è Tipos de Sanci√≥n Registrados</h3>
      <div id="listaSancionTipos" style="margin-top:16px;"></div>
    </div>

    <!-- Modal para agregar/editar tipo de sanci√≥n -->
    <div id="modalSancionTipo" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px; border-radius:12px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
        <h3 id="modalSancionTipoTitulo" style="margin-top:0; color:#f44336;">‚ûï Agregar Tipo de Sanci√≥n</h3>
        <form id="formSancionTipo" onsubmit="guardarSancionTipo(event)">
          <input type="hidden" id="sancionTipoId" />
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; font-weight:600; color:#333;">C√≥digo *</label>
            <input type="text" id="sancionTipoCodigo" required placeholder="Ej: SUSP_TEMP, MULTA_RETRASO" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; text-transform:uppercase;" />
            <small style="color:#666; font-size:12px;">C√≥digo √∫nico, sin espacios, en may√∫sculas (RB1)</small>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:6px; font-weight:600; color:#333;">Descripci√≥n *</label>
            <textarea id="sancionTipoDescripcion" required placeholder="Descripci√≥n del tipo de sanci√≥n (5-120 caracteres)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; min-height:80px; resize:vertical;" maxlength="120"></textarea>
            <small style="color:#666; font-size:12px;">Entre 5 y 120 caracteres (RB2) - <span id="contadorDescripcion">0</span>/120</small>
          </div>
          <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button type="button" onclick="cerrarModalSancionTipo()" style="background:#757575; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
            <button type="submit" style="background:#f44336; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Secci√≥n: Importar -->
    <div id="section-importar" class="section-content">
      <h3 style="border-left:4px solid #17a2b8; padding-left:12px;">üì• Importar Inventario (CSV/Excel)</h3>
      <div style="background:#fff; padding:20px; border:1px solid #e1e8ed; border-radius:8px; margin-top:16px;">
        <form id="formImport">
          <input type="file" name="file" accept=".csv,.xlsx,.xls" required style="margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; width:100%;" />
          <button type="submit" style="background:#17a2b8; color:white; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-weight:600; width:100%;">üì• Importar Archivo</button>
    </form>
        <div style="font-size:12px; color:#555; margin-top:12px; padding:12px; background:#f8f9fa; border-radius:6px;">
          <strong>Formato esperado (cabeceras):</strong><br>
          titulo, autor, isbn, editorial, anio_publicacion, categoria, subcategoria, descripcion, stock, cantidad_disponible, codigo_inventario, imagen_url
        </div>
      </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div id="modalUsuario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:white; padding:30px; border-radius:15px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
        <h2 id="modalUsuarioTitulo" style="margin-top:0;">Agregar Usuario</h2>
        <form id="formUsuario" onsubmit="guardarUsuario(event)" class="modern-form">
          <input type="hidden" id="usuarioIdEdit">
          <div class="form-grid">
            <div class="form-field">
              <label for="usuarioNombre">Nombre completo<span class="required">*</span></label>
              <input type="text" id="usuarioNombre" required placeholder="Ej: Ana Mar√≠a P√©rez">
            </div>
            <div class="form-field">
              <label for="usuarioDocumento">N√∫mero de documento<span class="required">*</span></label>
              <input type="text" id="usuarioDocumento" required placeholder="Identificaci√≥n">
            </div>
            <div class="form-field">
              <label for="usuarioTelefono">Celular<span class="required">*</span></label>
              <input type="tel" id="usuarioTelefono" required placeholder="(+57) 300 000 0000">
            </div>
            <div class="form-field">
              <label for="usuarioCorreo">Correo electr√≥nico</label>
              <input type="email" id="usuarioCorreo" placeholder="nombre@correo.com">
              <small>Se usar√° para notificaciones o restablecer contrase√±a.</small>
            </div>
            <div class="form-field">
              <label for="usuarioPrograma">Programa de formaci√≥n<span class="required">*</span></label>
              <input type="text" id="usuarioPrograma" required placeholder="Programa SENA">
            </div>
            <div class="form-field">
              <label for="usuarioFicha">N√∫mero de ficha<span class="required">*</span></label>
              <input type="text" id="usuarioFicha" required placeholder="Ej: 2547896">
            </div>
            <div class="form-field">
              <label for="usuarioRol">Tipo de rol<span class="required">*</span></label>
              <select id="usuarioRol" required>
                <option value="">Selecciona un rol</option>
                <option value="aprendiz">Aprendiz</option>
                <option value="instructor">Instructor</option>
                <option value="administrativo">Administrativo</option>
                <option value="funcionario">Funcionario</option>
                <option value="visitante">Visitante</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div class="form-field">
              <label for="usuarioUsername">Usuario de acceso<span class="required">*</span></label>
              <input type="text" id="usuarioUsername" required placeholder="Nombre de usuario">
            </div>
            <div class="form-field">
              <label for="usuarioPassword">Contrase√±a <span id="passwordLabel">(requerida)</span></label>
              <input type="password" id="usuarioPassword" placeholder="M√≠nimo 6 caracteres">
            </div>
            <div class="form-field">
              <label for="usuarioCanalPreferido">Medio preferido de contacto</label>
              <select id="usuarioCanalPreferido">
                <option value="correo">Correo electr√≥nico</option>
                <option value="telefono">Tel√©fono</option>
                <option value="ambos">Ambos</option>
              </select>
            </div>
          </div>
          <div class="form-state-switch" style="margin-top:16px;">
            <input type="checkbox" id="usuarioResetear">
            <label for="usuarioResetear" style="font-weight:600; color:#344151;">Forzar restablecimiento de contrase√±a al pr√≥ximo ingreso</label>
          </div>
          <div class="form-actions" style="margin-top:24px;">
            <button type="button" class="btn-ghost" onclick="cerrarModalUsuario()">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar usuario</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Sistema de tabs
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const section = tab.getAttribute('data-section');
        // Actualizar tabs activos
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // Ocultar todas las secciones
        document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
        // Mostrar secci√≥n seleccionada
        const targetSection = document.getElementById(`section-${section}`);
        if (targetSection) {
          targetSection.classList.add('active');
          // Cargar datos seg√∫n secci√≥n
          switch(section) {
            case 'pendientes': cargarPendientes(); break;
            case 'aprobados': cargarAprobados(); break;
            case 'recursos': cargarRecursos(); break;
            case 'trazabilidad': cargarTrazabilidad(); break;
            case 'espera': cargarEspera(); break;
            case 'usuarios': cargarUsuarios(); break;
            case 'sanciones': cargarSancionTipos(); break;
          }
        }
      });
    });

    // Cargar datos de solicitudes pendientes con informaci√≥n completa del usuario
    let cacheUsuarios = {};
    async function obtenerUsuarioInfo(idUsuario) {
      if (cacheUsuarios[idUsuario]) return cacheUsuarios[idUsuario];
      if (!idUsuario) return null;
      try {
        const res = await fetch(`/api/usuarios/${idUsuario}`);
        if (res.ok) {
          const data = await res.json();
          cacheUsuarios[idUsuario] = data;
          return data;
        }
      } catch(e) {}
      return null;
    }

    async function cargarPendientes(){
      const cont = document.getElementById('listaPendientes');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/prestamos?estado=pendiente');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay solicitudes pendientes.</div>';
          document.getElementById('badgePendientes').style.display = 'none';
          return;
        }
        
        // Actualizar badge
        const badge = document.getElementById('badgePendientes');
        if (items.length > 0) {
          badge.textContent = items.length;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }

        cont.innerHTML = '';
        for (const p of items) {
          // Usar datos del usuario desde la respuesta o buscar
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `
              <div class="usuario-info" style="background:#e3f2fd; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #2196f3;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:13px;">
                  <div><strong>üë§ Nombre:</strong> ${usuarioInfo.nombre || 'N/A'}</div>
                  <div><strong>üÜî Documento:</strong> ${usuarioInfo.documento || p.id_usuario || 'N/A'}</div>
                  <div><strong>üìã Ficha:</strong> ${usuarioInfo.numero_ficha || 'N/A'}</div>
                </div>
              </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `
              <div style="background:#f1f8f4; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #4caf50;">
                <div style="font-size:13px;">
                  <strong>üìö Elemento:</strong> ${elementoInfo.titulo || p.id_elemento.substring(0, 8) + '...'}<br>
                  ${elementoInfo.autor ? `<strong>üë§ Autor:</strong> ${elementoInfo.autor}<br>` : ''}
                  ${elementoInfo.codigo_inventario ? `<strong>üî¢ C√≥digo:</strong> ${elementoInfo.codigo_inventario}` : ''}
                </div>
              </div>`;
          }
          
          card.innerHTML = `
            <div>
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div>
                  <div><strong>üÜî ID Pr√©stamo:</strong> <code style="background:#f5f5f5; padding:2px 6px; border-radius:4px;">${p.id}</code></div>
                  <div style="font-size:12px; color:#666; margin-top:4px;"><strong>Fecha solicitud:</strong> ${new Date(p.creado_en).toLocaleString('es-ES')}</div>
                </div>
              </div>
              ${usuarioHtml}
              ${elementoHtml}
              <div style="display:flex; gap:8px; margin-top:12px;">
                <button data-id="${p.id}" class="btn-aprobar" style="background:#4caf50; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚úÖ Aprobar</button>
                <button data-id="${p.id}" class="btn-rechazar" style="background:#f44336; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚ùå Rechazar</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch (e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando solicitudes</div>';
      }
    }

    async function filtrarPendientes() {
      const busqueda = document.getElementById('botBuscarPendientes').value.trim();
      if (!busqueda) {
        // Si est√° vac√≠o, mostrar todos
        document.querySelectorAll('#listaPendientes > div').forEach(card => {
          card.style.display = 'block';
        });
        return;
      }
      
      // Buscar por ID de pr√©stamo, nombre, documento o ficha
      const cards = document.querySelectorAll('#listaPendientes > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        const busquedaLower = busqueda.toLowerCase();
        // Buscar en todo el texto (incluye ID, nombre, documento, ficha)
        card.style.display = texto.includes(busquedaLower) ? 'block' : 'none';
      });
    }

    async function cargarAprobados(){
      const cont = document.getElementById('listaAprobados');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/prestamos?estado=aprobado');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay pr√©stamos aprobados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const p of items) {
          // Usar datos del usuario desde la respuesta
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `
              <div class="usuario-info" style="background:#e3f2fd; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #2196f3;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:13px;">
                  <div><strong>üë§ Nombre:</strong> ${usuarioInfo.nombre || 'N/A'}</div>
                  <div><strong>üÜî Documento:</strong> ${usuarioInfo.documento || p.id_usuario || 'N/A'}</div>
                  <div><strong>üìã Ficha:</strong> ${usuarioInfo.numero_ficha || 'N/A'}</div>
                </div>
              </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `
              <div style="background:#f1f8f4; padding:12px; border-radius:8px; margin-top:8px; border-left:4px solid #4caf50;">
                <div style="font-size:13px;">
                  <strong>üìö Elemento:</strong> ${elementoInfo.titulo || p.id_elemento.substring(0, 8) + '...'}<br>
                  ${elementoInfo.autor ? `<strong>üë§ Autor:</strong> ${elementoInfo.autor}` : ''}
                </div>
              </div>`;
          }
          
          card.innerHTML = `
            <div>
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
              <div>
                  <div><strong>üÜî ID Pr√©stamo:</strong> <code style="background:#f5f5f5; padding:2px 6px; border-radius:4px;">${p.id}</code></div>
                  <div style="font-size:12px; color:#666; margin-top:4px;"><strong>Fecha pr√©stamo:</strong> ${new Date(p.fecha_prestamo).toLocaleString('es-ES')}</div>
                </div>
              </div>
              ${usuarioHtml}
              ${elementoHtml}
              <div style="margin-top:12px;">
                <button data-id="${p.id}" class="btn-devolver" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üì• Marcar Devuelto</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch (e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando aprobados</div>';
      }
    }

    async function filtrarAprobados() {
      const busqueda = document.getElementById('botBuscarAprobados').value.toLowerCase();
      const cards = document.querySelectorAll('#listaAprobados > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busqueda) ? 'block' : 'none';
      });
    }
    
    let tipoFiltroInventario = 'todos';
    function filtrarPorTipo(tipo) {
      tipoFiltroInventario = tipo;
      document.querySelectorAll('#inventoryFilters .chip').forEach(chip => {
        chip.classList.toggle('is-active', chip.dataset.filter === tipo);
      });
      cargarRecursos();
    }

    function resetFiltrosInventario() {
      const fCat = document.getElementById('fCat');
      const fCodigo = document.getElementById('fCodigo');
      const fTitulo = document.getElementById('fTitulo');
      if (fCat) fCat.value = '';
      if (fCodigo) fCodigo.value = '';
      if (fTitulo) fTitulo.value = '';
      tipoFiltroInventario = 'todos';
      const chips = document.querySelectorAll('#inventoryFilters .chip');
      chips.forEach((chip, idx) => chip.classList.toggle('is-active', idx === 0));
      cargarRecursos();
    }

    // Actualizar badge de mensajes en el header
    async function actualizarBadgeMensajes() {
      try {
        const res = await fetch('/api/mensajes?admin=true');
        const mensajes = res.ok ? await res.json() : [];
        const noLeidos = mensajes.filter(m => !m.leido && m.id_destinatario === 'admin').length;
        const badge = document.getElementById('badgeMensajesAdmin');
        if (badge) {
          if (noLeidos > 0) {
            badge.textContent = noLeidos;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch(e) {}
    }

    // Funciones de inventario
    async function cargarRecursos(){
      const cont = document.getElementById('listaInventario');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        // Aplicar filtro de tipo si existe
        const res = await fetch('/api/libros');
        let items = res.ok ? await res.json() : [];
        
        // Filtrar por tipo (libro/PC/todos)
        if (tipoFiltroInventario === 'libro') {
          items = items.filter(x => {
            const cat = (x.categoria || '').toLowerCase();
            return cat === 'libros' || (!cat.includes('equipo') && !cat.includes('pc'));
          });
        } else if (tipoFiltroInventario === 'pc') {
          items = items.filter(x => {
            const cat = (x.categoria || '').toLowerCase();
            return cat.includes('equipo') || cat.includes('pc') || cat.includes('port√°til') || cat.includes('desktop') || cat.includes('tablet');
          });
        }
        // Si es 'todos', no filtrar por tipo
        
        // Aplicar otros filtros
        const fcat = (document.getElementById('fCat')?.value || '').toLowerCase();
        const fcod = (document.getElementById('fCodigo')?.value || '').toLowerCase();
        const ftit = (document.getElementById('fTitulo')?.value || '').toLowerCase();
        const filtrados = items.filter(x => 
          (!fcat || (x.categoria||'').toLowerCase().includes(fcat)) && 
          (!fcod || (x.codigo_inventario||'').toLowerCase().includes(fcod)) &&
          (!ftit || (x.titulo||'').toLowerCase().includes(ftit) || (x.autor||'').toLowerCase().includes(ftit))
        );
        if (!filtrados.length) {
          cont.innerHTML = '<div class="inventory-empty">No encontramos coincidencias con los filtros seleccionados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const it of filtrados) {
          const titulo = (it.titulo || it.categoria || 'Recurso').trim();
          const codigo = (it.codigo_inventario || it.isbn || '').trim();
          const categoria = (it.categoria || 'Sin categor√≠a').trim();
          const subcategoria = (it.subcategoria || '').trim();
          const autor = (it.autor || '').trim();
          const descripcionLimpia = (it.descripcion || '').replace(/\s+/g, ' ').trim();
          const descripcion = descripcionLimpia.length > 160 ? `${descripcionLimpia.slice(0, 157)}...` : descripcionLimpia;
          const disponibles = Number(it.cantidad_disponible_total ?? it.cantidad_disponible ?? 0) || 0;
          const prestados = Number(it.cantidad_prestado_total ?? it.cantidad_prestado ?? 0) || 0;
          const stockHas = Number(it.stock_total ?? it.stock ?? 0) || 0;
          const stock = Math.max(stockHas, disponibles + prestados);
          const disponibilidadPct = stock > 0 ? Math.round((disponibles / stock) * 100) : 0;
          const enAlerta = stock === 0 || disponibles === 0;
          const statusLabel = enAlerta ? 'Sin stock' : 'Disponible';
          const statusIcon = enAlerta ? '‚ö†Ô∏è' : '‚úÖ';
          const metadata = [
            codigo ? `C√≥digo: ${codigo}` : null,
            autor ? `Autor / Responsable: ${autor}` : null
          ].filter(Boolean).join(' ¬∑ ');
          const safeTitle = titulo.replace(/'/g, "\\'");

          const card = document.createElement('article');
          card.className = 'inventory-card';
          card.innerHTML = `
            <div class="inventory-card__header">
              <div>
                <div class="inventory-card__meta">
                  <span class="inventory-card__badge">${categoria}</span>
                  ${subcategoria ? `<span class="inventory-card__subbadge">${subcategoria}</span>` : ''}
                  ${metadata ? `<span style="color:#6b7b93;">${metadata}</span>` : ''}
                </div>
                <h4 class="inventory-card__title">${titulo}</h4>
                ${descripcion ? `<p class="inventory-card__description">${descripcion}</p>` : ''}
              </div>
              <span class="inventory-card__status ${enAlerta ? 'inventory-card__status--alert' : ''}">
                ${statusIcon} ${statusLabel}
              </span>
            </div>
            <div class="inventory-card__stats">
              <div class="inventory-card__stat">
                <span>Disponibles</span>
                <strong>${disponibles}</strong>
              </div>
              <div class="inventory-card__stat">
                <span>Prestados</span>
                <strong>${prestados}</strong>
              </div>
              <div class="inventory-card__stat">
                <span>Total inventario</span>
                <strong>${stock}</strong>
                <div class="inventory-card__progress">
                  <div style="width:${Math.min(100, Math.max(0, disponibilidadPct))}%;"></div>
                </div>
              </div>
            </div>
            <div class="inventory-card__footer">
              <button type="button" style="background:#2196f3; color:#ffffff;" onclick="location.href='detalle_libro.html?id=${it.id}'">üîç Ver detalle</button>
              <button type="button" style="background:#dc3545; color:#ffffff;" onclick="eliminarRecurso('${it.id}', '${safeTitle}')">üóëÔ∏è Eliminar</button>
            </div>
          `;
          cont.appendChild(card);
        }
      } catch(e) {
        cont.innerHTML = '<div class="inventory-empty" style="color:#b71c1c; border-color:rgba(244,67,54,0.28);">Error cargando inventario</div>';
      }
    }

    async function eliminarRecurso(id, titulo) {
      const result = await Swal.fire({
        icon: 'warning',
        title: '¬øEliminar recurso?',
        html: `Esta acci√≥n eliminar√° <strong>${titulo}</strong> del inventario.<br><br>‚ö†Ô∏è El historial de pr√©stamos asociado se conservar√° para trazabilidad.`,
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        const res = await fetch(`/api/libros/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (res.ok && data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Recurso eliminado',
            html: data.eliminados
              ? `Se eliminaron ${data.eliminados} registros relacionados.<br>Historial preservado: ${data.prestamos_preservados || 0} pr√©stamos.`
              : 'Se elimin√≥ correctamente.',
            timer: 2600,
            showConfirmButton: false
          });
          cargarRecursos();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'No se pudo eliminar el recurso'
          });
        }
      } catch(e) {
        Swal.fire({
          icon: 'error',
          title: 'Error de conexi√≥n',
          text: e.message
        });
      }
    }

    async function cargarEspera(){
      const cont = document.getElementById('listaEspera');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/espera');
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay personas en espera.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const w of items) {
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '12px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap;">
              <div>
                <div><strong>ID Espera:</strong> ${w.id.substring(0, 8)}...</div>
                <div><strong>ID Elemento:</strong> ${w.id_elemento.substring(0, 8)}...</div>
                <div><strong>Contacto:</strong> ${w.contacto || w.id_usuario || ''}</div>
                <div><strong>Estado:</strong> <span style="color:${w.estado==='notificado'?'#4caf50':'#ff9800'}">${w.estado}</span></div>
              </div>
              <div>
                <button data-id="${w.id}" class="btn-notificar" ${w.estado==='notificado'?'disabled':''} style="background:#9c27b0; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; ${w.estado==='notificado'?'opacity:0.5; cursor:not-allowed;':''}">‚úÖ Marcar Notificado</button>
              </div>
            </div>`;
          cont.appendChild(card);
        }
        bindAcciones();
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando espera</div>';
      }
    }

    async function cargarTrazabilidad() {
      const cont = document.getElementById('trazabilidadContent');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const estado = document.getElementById('filtroTrazabilidad').value;
        const url = estado ? `/prestamos?estado=${estado}` : '/prestamos';
        const res = await fetch(url);
        const items = res.ok ? await res.json() : [];
        if (!items.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay pr√©stamos registrados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const p of items) {
          const usuarioInfo = p.usuario || await obtenerUsuarioInfo(p.id_usuario);
          const elementoInfo = p.elemento || null;
          
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          const estadoColor = {
            'pendiente': '#ff9800',
            'aprobado': '#4caf50',
            'rechazado': '#f44336',
            'devuelto': '#2196f3'
          }[p.estado] || '#666';
          
          let usuarioHtml = '';
          if (usuarioInfo) {
            usuarioHtml = `<div style="background:#e3f2fd; padding:8px; border-radius:6px; margin:8px 0; font-size:13px;">
              <strong>üë§ ${usuarioInfo.nombre || 'N/A'}</strong> - üÜî ${usuarioInfo.documento || p.id_usuario || 'N/A'}
            </div>`;
          }
          
          let elementoHtml = '';
          if (elementoInfo) {
            elementoHtml = `<div style="background:#f1f8f4; padding:8px; border-radius:6px; margin:8px 0; font-size:13px;">
              <strong>üìö ${elementoInfo.titulo || p.id_elemento.substring(0, 12) + '...'}</strong>
              ${elementoInfo.codigo_inventario ? ` - üî¢ ${elementoInfo.codigo_inventario}` : ''}
            </div>`;
          }
          
          card.innerHTML = `
            <div style="display:grid; grid-template-columns: 1fr auto; gap:16px;">
              <div>
                <div style="margin-bottom:8px;"><strong>üÜî ID Pr√©stamo:</strong> <code>${p.id}</code></div>
                ${usuarioHtml}
                ${elementoHtml}
                <div style="margin-bottom:8px; font-size:13px;"><strong>üìÖ Fecha pr√©stamo:</strong> ${new Date(p.fecha_prestamo).toLocaleString('es-ES')}</div>
                ${p.fecha_devolucion ? `<div style="font-size:13px;"><strong>üì• Fecha devoluci√≥n:</strong> ${new Date(p.fecha_devolucion).toLocaleString('es-ES')}</div>` : ''}
                ${p.observaciones ? `<div style="margin-top:8px; padding:8px; background:#f5f5f5; border-radius:6px; font-size:13px;"><strong>üìù Observaciones:</strong> ${p.observaciones}</div>` : ''}
              </div>
              <div>
                <span style="background:${estadoColor}; color:white; padding:8px 16px; border-radius:20px; font-weight:600; text-transform:uppercase; display:inline-block;">${p.estado}</span>
              </div>
            </div>`;
          cont.appendChild(card);
        }
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando trazabilidad</div>';
      }
    }

    function bindAcciones(){
      document.querySelectorAll('.btn-aprobar').forEach(b => {
        // Remover listeners anteriores para evitar duplicados
        const nuevoBtn = b.cloneNode(true);
        b.parentNode.replaceChild(nuevoBtn, b);
        
        nuevoBtn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('¬øAprobar este pr√©stamo?')) return;
          
          try {
        const res = await fetch(`/prestamos/${id}/aprobar`, { method: 'PUT' });
            const data = await res.json().catch(()=>({}));
            
            if (res.ok && data.ok) {
              alert('‚úÖ Pr√©stamo aprobado correctamente');
              // Recargar ambas secciones
              await Promise.all([cargarPendientes(), cargarAprobados()]);
            } else {
              alert('‚ùå ' + (data.error || 'No se pudo aprobar'));
            }
          } catch (err) {
            alert('Error de conexi√≥n: ' + err.message);
          }
        });
      });
      document.querySelectorAll('.btn-rechazar').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        if (!confirm('¬øRechazar esta solicitud?')) return;
        const res = await fetch(`/prestamos/${id}/rechazar`, { method: 'PUT' });
        if (res.ok) {
          alert('‚ùå Rechazado');
          cargarPendientes();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo rechazar'));
        }
      }));
      document.querySelectorAll('.btn-devolver').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const res = await fetch(`/prestamos/${id}/devolver`, { method: 'PUT' });
        if (res.ok) {
          alert('üì• Devuelto');
          cargarAprobados();
          cargarEspera();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo marcar devuelto'));
        }
      }));
      document.querySelectorAll('.btn-notificar').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const res = await fetch(`/espera/${id}/notificar`, { method: 'PUT' });
        if (res.ok) {
          alert('‚úÖ Marcado como notificado');
          cargarEspera();
        } else {
          const d = await res.json().catch(()=>({}));
          alert('‚ùå ' + (d.error || 'No se pudo marcar'));
        }
      }));
    }

    // Protecci√≥n: solo admins
    (function(){
      const t = localStorage.getItem('token');
      if (t !== 'admin-token') {
        alert('Acceso restringido a administradores');
        window.location.href = 'principal.html';
      }
    })();

    document.getElementById('formImport')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const res = await fetch('/import/csv', { method: 'POST', body: fd });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.ok) {
        alert(`‚úÖ Importados: ${data.creados} | Actualizados: ${data.actualizados || 0}`);
        cargarRecursos();
      } else {
        alert('‚ùå ' + (data.error || 'No se pudo importar'));
      }
    });

    document.getElementById('btnBuscar')?.addEventListener('click', cargarRecursos);
    document.getElementById('btnLimpiarFiltros')?.addEventListener('click', resetFiltrosInventario);

    document.querySelectorAll('#inventoryFilters .chip').forEach(chip => {
      chip.addEventListener('click', () => filtrarPorTipo(chip.dataset.filter || 'todos'));
    });

    const editorTabs = document.getElementById('editorTabs');
    if (editorTabs) {
      editorTabs.addEventListener('click', (event) => {
        const targetBtn = event.target.closest('button[data-target]');
        if (!targetBtn) return;
        editorTabs.querySelectorAll('button').forEach(btn => {
          btn.classList.toggle('is-active', btn === targetBtn);
        });
        const objetivo = targetBtn.dataset.target;
        document.querySelectorAll('.resource-editor form').forEach(form => {
          form.style.display = form.id === objetivo ? '' : 'none';
        });
      });
    }

    const formLibro = document.getElementById('formLibro');
    if (formLibro) {
      formLibro.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(formLibro);
        const unidades = Math.max(1, parseInt(formData.get('stock') || '1', 10));
        formData.set('stock', unidades);
        formData.set('cantidad_disponible', unidades);
        formData.set('cantidad_prestado', 0);
        const autor = (formData.get('autor') || '').toString().trim();
        if (!autor) {
          Swal.fire({ icon: 'warning', title: 'Falta informaci√≥n', text: 'A√±ade el autor del libro antes de guardar.' });
          return;
        }
        const imagenInput = formLibro.querySelector('input[name="imagen"]');
        if (imagenInput && (!imagenInput.files || imagenInput.files.length === 0)) {
          formData.delete('imagen');
        }
        try {
          const res = await fetch('/api/libros', {
            method: 'POST',
            body: formData
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.ok) {
            Swal.fire({ icon: 'success', title: 'Libro guardado', timer: 2200, showConfirmButton: false });
            formLibro.reset();
            formLibro.querySelector('input[name="stock"]').value = 1;
            formLibro.querySelector('input[name="cantidad_disponible"]').value = 1;
            formLibro.querySelector('input[name="cantidad_prestado"]').value = 0;
            cargarRecursos();
          } else {
            Swal.fire({ icon: 'error', title: 'No se pudo registrar', text: data.error || 'Revisa los datos e int√©ntalo nuevamente.' });
          }
        } catch (error) {
          Swal.fire({ icon: 'error', title: 'Error de conexi√≥n', text: error.message });
        }
      });
    }

    const formPortatil = document.getElementById('formPortatil');
    if (formPortatil) {
      formPortatil.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(formPortatil);
        const codigoInterno = (formData.get('codigo_interno') || '').toString().trim();
        const numeroSerie = (formData.get('numero_serie') || '').toString().trim();
        const placaSena = (formData.get('placa_sena') || '').toString().trim();
        if (!codigoInterno || !numeroSerie || !placaSena) {
          Swal.fire({ icon: 'warning', title: 'Datos incompletos', text: 'Ingresa c√≥digo interno, n√∫mero de serie y placa SENA.' });
          return;
        }
        const unidades = Math.max(1, parseInt(formData.get('stock') || '1', 10));
        formData.set('stock', unidades);
        formData.set('cantidad_disponible', unidades);
        formData.set('cantidad_prestado', 0);
        formData.set('codigo_inventario', codigoInterno);
        formData.set('isbn', numeroSerie);
        formData.set('editorial', placaSena);
        const estado = (formData.get('estado_disponibilidad') || 'Disponible').toString();
        formData.set('estado_disponibilidad', estado);
        formData.set('estado_elemento', estado === 'Disponible' ? 'Operativo' : 'No disponible');
        const descripcionManual = (formData.get('descripcion') || '').toString().trim();
        if (!descripcionManual) {
          const resumen = [
            `C√≥digo interno: ${codigoInterno}`,
            `N√∫mero de serie: ${numeroSerie}`,
            `Placa SENA: ${placaSena}`
          ];
          const marca = (formData.get('marca') || '').toString().trim();
          const modelo = (formData.get('modelo') || '').toString().trim();
          const especificaciones = (formData.get('especificaciones') || '').toString().trim();
          if (marca) resumen.push(`Marca: ${marca}`);
          if (modelo) resumen.push(`Modelo: ${modelo}`);
          if (especificaciones) resumen.push(especificaciones);
          formData.set('descripcion', resumen.join('\n'));
        }
        const imagenInput = formPortatil.querySelector('input[name="imagen"]');
        if (imagenInput && (!imagenInput.files || imagenInput.files.length === 0)) {
          formData.delete('imagen');
        }
        try {
          const res = await fetch('/api/libros', {
            method: 'POST',
            body: formData
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.ok) {
            Swal.fire({ icon: 'success', title: 'Port√°til guardado', timer: 2200, showConfirmButton: false });
            formPortatil.reset();
            formPortatil.querySelector('input[name="stock"]').value = 1;
            formPortatil.querySelector('input[name="cantidad_disponible"]').value = 1;
            formPortatil.querySelector('input[name="cantidad_prestado"]').value = 0;
            cargarRecursos();
          } else {
            Swal.fire({ icon: 'error', title: 'No se pudo registrar', text: data.error || 'Revisa los datos e int√©ntalo nuevamente.' });
          }
        } catch (error) {
          Swal.fire({ icon: 'error', title: 'Error de conexi√≥n', text: error.message });
        }
      });
    }

    // Funciones de gesti√≥n de usuarios
    async function cargarUsuarios() {
      const cont = document.getElementById('listaUsuarios');
      if (!cont) return;
      cont.innerHTML = 'Cargando...';
      try {
        const res = await fetch('/api/usuarios');
        const usuarios = res.ok ? await res.json() : [];
        if (!usuarios.length) {
          cont.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay usuarios registrados.</div>';
          return;
        }
        cont.innerHTML = '';
        for (const u of usuarios) {
          const card = document.createElement('div');
          card.style.background = '#fff';
          card.style.padding = '16px';
          card.style.border = '1px solid #e1e8ed';
          card.style.borderRadius = '8px';
          card.style.marginBottom = '12px';
          const rolVisible = (u.tipo_usuario || (u.role === 'admin' ? 'Administrador' : 'Usuario')).toString();
          const roleBadge = `<span class="pill-badge">${rolVisible.toUpperCase()}</span>`;
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                  <strong>${u.nombre}</strong> ${roleBadge}
                </div>
                <div style="color:#666; font-size:13px;">
                  <div>üÜî Documento: ${u.documento}</div>
                  <div>üë§ Username: ${u.username}</div>
                  ${u.telefono ? `<div>üì± Tel√©fono: ${u.telefono}</div>` : ''}
                  ${u.correo ? `<div>‚úâÔ∏è Correo: ${u.correo}</div>` : ''}
                  ${u.numero_ficha ? `<div>üìã Ficha: ${u.numero_ficha}</div>` : ''}
                  ${u.programa_formacion ? `<div>üéì Programa: ${u.programa_formacion}</div>` : ''}
                  ${u.canal_contacto ? `<div>üì° Contacto preferido: ${u.canal_contacto}</div>` : ''}
                  <div style="margin-top:4px; font-size:11px; color:#999;">Registrado: ${u.creado_en ? new Date(u.creado_en).toLocaleDateString('es-ES') : 'N/A'}</div>
                </div>
              </div>
              <div style="display:flex; gap:8px;">
                <button onclick="editarUsuario('${u.id}')" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">‚úèÔ∏è Editar</button>
                ${u.username !== 'admin' ? `<button onclick="eliminarUsuario('${u.id}', '${u.nombre.replace(/'/g, "\\'")}')" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">üóëÔ∏è Eliminar</button>` : ''}
              </div>
            </div>`;
          cont.appendChild(card);
        }
      } catch(e) {
        cont.innerHTML = '<div style="padding:20px; color:#f44336;">Error cargando usuarios</div>';
      }
    }

    function filtrarUsuarios() {
      const busqueda = document.getElementById('buscarUsuarios').value.toLowerCase();
      const cards = document.querySelectorAll('#listaUsuarios > div');
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(busqueda) ? 'block' : 'none';
      });
    }

    function abrirModalUsuario() {
      document.getElementById('modalUsuarioTitulo').textContent = 'Agregar Usuario';
      document.getElementById('formUsuario').reset();
      document.getElementById('usuarioIdEdit').value = '';
      document.getElementById('usuarioPassword').required = true;
      document.getElementById('passwordLabel').textContent = '(requerida)';
      document.getElementById('usuarioRol').value = '';
      document.getElementById('usuarioCanalPreferido').value = 'correo';
      document.getElementById('usuarioResetear').checked = false;
      document.getElementById('modalUsuario').style.display = 'flex';
    }

    async function editarUsuario(id) {
      try {
        const res = await fetch(`/api/usuarios/${id}`);
        if (!res.ok) {
          alert('No se pudo obtener la informaci√≥n del usuario');
          return;
        }
        const usuario = await res.json();
        document.getElementById('modalUsuarioTitulo').textContent = 'Editar Usuario';
        document.getElementById('usuarioIdEdit').value = usuario.id;
        document.getElementById('usuarioNombre').value = usuario.nombre || '';
        document.getElementById('usuarioDocumento').value = usuario.documento || '';
        document.getElementById('usuarioCorreo').value = usuario.correo || '';
        document.getElementById('usuarioTelefono').value = usuario.telefono || '';
        document.getElementById('usuarioPrograma').value = usuario.programa_formacion || usuario.programa || '';
        document.getElementById('usuarioFicha').value = usuario.numero_ficha || '';
        document.getElementById('usuarioUsername').value = usuario.username || '';
        document.getElementById('usuarioRol').value = usuario.tipo_usuario || (usuario.role === 'admin' ? 'administrativo' : 'aprendiz');
        document.getElementById('usuarioCanalPreferido').value = usuario.canal_contacto || 'correo';
        document.getElementById('usuarioPassword').value = '';
        document.getElementById('usuarioPassword').required = false;
        document.getElementById('usuarioResetear').checked = false;
        document.getElementById('passwordLabel').textContent = '(dejar vac√≠o para no cambiar)';
        document.getElementById('modalUsuario').style.display = 'flex';
      } catch (error) {
        console.error(error);
        alert('Error cargando la informaci√≥n del usuario');
      }
    }

    async function guardarUsuario(e) {
      e.preventDefault();
      const id = document.getElementById('usuarioIdEdit').value;
      const rolSeleccionado = document.getElementById('usuarioRol').value;
      const rolSistema = (rolSeleccionado === 'admin' || rolSeleccionado === 'administrativo') ? 'admin' : 'user';
      const data = {
        nombre: document.getElementById('usuarioNombre').value,
        documento: document.getElementById('usuarioDocumento').value,
        correo: document.getElementById('usuarioCorreo').value,
        telefono: document.getElementById('usuarioTelefono').value,
        programa_formacion: document.getElementById('usuarioPrograma').value,
        numero_ficha: document.getElementById('usuarioFicha').value,
        canal_contacto: document.getElementById('usuarioCanalPreferido').value,
        tipo_usuario: rolSeleccionado || 'aprendiz',
        username: document.getElementById('usuarioUsername').value,
        role: rolSistema,
        reset_password: document.getElementById('usuarioResetear').checked
      };
      
      const password = document.getElementById('usuarioPassword').value;
      if (password) {
        data.password = password;
      }
      
      try {
        let res;
        if (id) {
          res = await fetch(`/api/usuarios/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          if (!password) {
            alert('La contrase√±a es requerida para nuevos usuarios');
            return;
          }
          res = await fetch('/api/usuarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        const result = await res.json();
        if (res.ok && result.ok !== false) {
          alert('Usuario guardado correctamente');
          cerrarModalUsuario();
          cargarUsuarios();
        } else {
          alert('Error: ' + (result.error || 'No se pudo guardar'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function eliminarUsuario(id, nombre) {
      if (!confirm(`¬øEst√°s seguro de eliminar al usuario "${nombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) return;
      try {
        const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok && result.ok !== false) {
          alert('Usuario eliminado correctamente');
          cargarUsuarios();
        } else {
          alert('Error: ' + (result.error || 'No se pudo eliminar'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function cerrarModalUsuario() {
      document.getElementById('modalUsuario').style.display = 'none';
    }

    // ==================== GESTI√ìN DE TIPOS DE SANCI√ìN ====================
    
    function filtrarSancionTipos() {
      const busqueda = document.getElementById('buscarSancionTipos').value.toLowerCase();
      const cards = document.querySelectorAll('.sancion-tipo-card');
      cards.forEach(card => {
        const codigo = card.getAttribute('data-codigo') || '';
        const descripcion = card.getAttribute('data-descripcion') || '';
        const textoCompleto = (codigo + ' ' + descripcion).toLowerCase();
        card.style.display = textoCompleto.includes(busqueda) ? 'block' : 'none';
      });
    }
    
    // Contador de caracteres para descripci√≥n (se inicializa cuando se abre el modal)
    function inicializarContadorDescripcion() {
      const descripcionInput = document.getElementById('sancionTipoDescripcion');
      const contador = document.getElementById('contadorDescripcion');
      if (descripcionInput && contador) {
        descripcionInput.addEventListener('input', function() {
          contador.textContent = this.value.length;
          if (this.value.length < 5) {
            contador.style.color = '#f44336';
          } else if (this.value.length > 120) {
            contador.style.color = '#f44336';
          } else {
            contador.style.color = '#666';
          }
        });
      }
    }

    async function cargarSancionTipos() {
      const lista = document.getElementById('listaSancionTipos');
      if (!lista) return;
      
      lista.innerHTML = 'Cargando tipos de sanci√≥n...';
      
      try {
        const res = await fetch('/api/sancion-tipos');
        if (!res.ok) {
          lista.innerHTML = '<div style="padding:20px; color:#f44336;">Error al cargar tipos de sanci√≥n</div>';
          return;
        }
        
        const tipos = await res.json();
        
        if (tipos.length === 0) {
          lista.innerHTML = '<div style="padding:40px; text-align:center; color:#666; background:white; border-radius:8px; border:2px dashed #ddd;">No hay tipos de sanci√≥n registrados.<br><br>Haz clic en "‚ûï Agregar Tipo de Sanci√≥n" para crear uno.</div>';
          return;
        }
        
        let html = '<div style="display:grid; gap:12px;">';
        tipos.forEach(tipo => {
          html += `
            <div class="sancion-tipo-card" style="background:white; padding:16px; border-radius:8px; border-left:4px solid #f44336; box-shadow:0 2px 8px rgba(0,0,0,0.1);" data-codigo="${tipo.codigo.toLowerCase()}" data-descripcion="${tipo.descripcion.toLowerCase()}">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                <div>
                  <h4 style="margin:0 0 4px 0; color:#333; font-size:18px;">
                    <code style="background:#f5f5f5; padding:4px 8px; border-radius:4px; font-weight:bold; color:#f44336;">${tipo.codigo}</code>
                  </h4>
                  <p style="margin:8px 0; color:#666; font-size:14px;">${tipo.descripcion}</p>
                  <div style="font-size:12px; color:#999; margin-top:8px;">
                    Creado: ${new Date(tipo.creado_en).toLocaleDateString('es-ES')} 
                    ${tipo.usuario_creacion ? `| Por: ${tipo.usuario_creacion}` : ''}
                  </div>
                </div>
                <div style="display:flex; gap:8px;">
                  <button onclick="editarSancionTipo('${tipo.id}')" style="background:#2196f3; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px;">‚úèÔ∏è Editar</button>
                  <button onclick="eliminarSancionTipo('${tipo.id}', '${tipo.codigo}')" style="background:#f44336; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px;">üóëÔ∏è Eliminar</button>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        lista.innerHTML = html;
        
        // Aplicar filtro si hay un valor en el campo de b√∫squeda
        const busquedaInput = document.getElementById('buscarSancionTipos');
        if (busquedaInput && busquedaInput.value.trim()) {
          filtrarSancionTipos();
        }
      } catch (e) {
        lista.innerHTML = '<div style="padding:20px; color:#f44336;">Error de conexi√≥n al cargar tipos de sanci√≥n</div>';
        console.error('Error:', e);
      }
    }

    function abrirModalSancionTipo(id = null) {
      const modal = document.getElementById('modalSancionTipo');
      const titulo = document.getElementById('modalSancionTipoTitulo');
      const form = document.getElementById('formSancionTipo');
      const codigoInput = document.getElementById('sancionTipoCodigo');
      const descripcionInput = document.getElementById('sancionTipoDescripcion');
      const idInput = document.getElementById('sancionTipoId');
      
      if (id) {
        // Modo edici√≥n
        titulo.textContent = '‚úèÔ∏è Editar Tipo de Sanci√≥n';
        idInput.value = id;
        
        // Cargar datos
        fetch(`/api/sancion-tipos/${id}`)
          .then(res => res.json())
          .then(tipo => {
            codigoInput.value = tipo.codigo;
            descripcionInput.value = tipo.descripcion;
            document.getElementById('contadorDescripcion').textContent = tipo.descripcion.length;
          })
          .catch(e => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo cargar el tipo de sanci√≥n'
            });
          });
      } else {
        // Modo creaci√≥n
        titulo.textContent = '‚ûï Agregar Tipo de Sanci√≥n';
        idInput.value = '';
        form.reset();
        document.getElementById('contadorDescripcion').textContent = '0';
      }
      
      modal.style.display = 'flex';
      codigoInput.focus();
      
      // Inicializar contador de descripci√≥n
      inicializarContadorDescripcion();
      
      // Actualizar contador si hay valor
      if (descripcionInput.value) {
        const contador = document.getElementById('contadorDescripcion');
        if (contador) {
          contador.textContent = descripcionInput.value.length;
        }
      }
    }

    function cerrarModalSancionTipo() {
      document.getElementById('modalSancionTipo').style.display = 'none';
      document.getElementById('formSancionTipo').reset();
      document.getElementById('sancionTipoId').value = '';
      document.getElementById('contadorDescripcion').textContent = '0';
    }

    async function guardarSancionTipo(e) {
      e.preventDefault();
      
      const id = document.getElementById('sancionTipoId').value;
      const codigo = document.getElementById('sancionTipoCodigo').value.trim();
      const descripcion = document.getElementById('sancionTipoDescripcion').value.trim();
      
      if (!codigo || !descripcion) {
        Swal.fire({
          icon: 'warning',
          title: 'Campos requeridos',
          text: 'Por favor completa todos los campos'
        });
        return;
      }
      
      const data = {
        codigo: codigo,
        descripcion: descripcion
      };
      
      try {
        let res;
        if (id) {
          // Actualizar
          res = await fetch(`/api/sancion-tipos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Crear
          res = await fetch('/api/sancion-tipos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        const result = await res.json();
        
        if (res.ok && result.ok !== false) {
          Swal.fire({
            icon: 'success',
            title: '¬°√âxito!',
            text: id ? 'Tipo de sanci√≥n actualizado correctamente' : 'Tipo de sanci√≥n creado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
          cerrarModalSancionTipo();
          cargarSancionTipos();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.error || 'No se pudo guardar el tipo de sanci√≥n'
          });
        }
      } catch (e) {
        Swal.fire({
          icon: 'error',
          title: 'Error de conexi√≥n',
          text: e.message
        });
      }
    }

    async function editarSancionTipo(id) {
      abrirModalSancionTipo(id);
    }

    async function eliminarSancionTipo(id, codigo) {
      const result = await Swal.fire({
        icon: 'warning',
        title: '¬øEliminar tipo de sanci√≥n?',
        html: `¬øEst√°s seguro de eliminar el tipo de sanci√≥n <strong>${codigo}</strong>?<br><br>‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`,
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
      });
      
      if (result.isConfirmed) {
        try {
          const res = await fetch(`/api/sancion-tipos/${id}`, { method: 'DELETE' });
          const data = await res.json();
          
          if (res.ok && data.ok !== false) {
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'Tipo de sanci√≥n eliminado correctamente',
              timer: 2000,
              showConfirmButton: false
            });
            cargarSancionTipos();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'No se pudo eliminar el tipo de sanci√≥n'
            });
          }
        } catch (e) {
          Swal.fire({
            icon: 'error',
            title: 'Error de conexi√≥n',
            text: e.message
          });
        }
      }
    }

    // Actualizar badge de mensajes cada 10 segundos
    setInterval(actualizarBadgeMensajes, 10000);

    // Cargar pendientes al inicio (por defecto)
    cargarPendientes();
    actualizarBadgeMensajes();
  </script>
</body>
</html>
