<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipos y PCs Disponibles</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}">
</head>
<body>
  {% set active_page = 'equipos' %}
  {% set nav_context = 'general' %}
  {% set search_placeholder = 'Buscar en la biblioteca...' %}
  {% set search_button_id = 'btnBuscarEquipos' %}
  {% include 'includes/topbar.html' %}

  <main class="content">
    <h2 style="margin-top:8px">üíª EQUIPOS Y PCs DISPONIBLES</h2>
    <section class="carousel" aria-label="Carrusel de equipos">
      <button type="button" class="carousel__btn carousel__btn--prev" id="prevBtn" aria-label="Anterior">‚ùÆ</button>
      <div class="carousel__viewport" id="carouselViewport">
        <div class="carousel__track" id="carouselTrack"></div>
      </div>
      <button type="button" class="carousel__btn carousel__btn--next" id="nextBtn" aria-label="Siguiente">‚ùØ</button>
    </section>
  </main>

  <script src="/static/js/main.js" defer></script>
  <script>
    let categoriaActual = 'Equipos Inform√°ticos';
    
    async function cargarCarrusel() {
      try {
        const res = await fetch('/api/libros');
        if (!res.ok) return;
        const todosElementos = await res.json();
        // Filtrar solo equipos/PCs (no libros)
        const equipos = todosElementos.filter(l => {
          const cat = (l.categoria || '').toLowerCase();
          return cat.includes('equipo') || cat.includes('pc') || cat.includes('port√°til') || cat.includes('desktop') || cat.includes('tablet');
        });
        
        const track = document.getElementById('carouselTrack');
        track.innerHTML = '';
        
        if (equipos.length === 0) {
          track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No hay equipos disponibles.</div>';
          return;
        }
        
        for (const equipo of equipos) {
      const placeholder = '/static/img/placeholder-book.svg';
      const imgSrc = equipo.imagen ? (equipo.imagen.startsWith('uploads/') ? `/${equipo.imagen}` : equipo.imagen) : placeholder;
          const disponible = (equipo.cantidad_disponible || 0) > 0;
          const art = document.createElement('article');
          art.className = 'book';
          art.onclick = () => window.location.href = `detalle_libro.html?id=${equipo.id}`;
          art.innerHTML = `
            <div class="book__image"><img src="${imgSrc}" alt="${equipo.titulo || ''}"></div>
            ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">‚úÖ ${equipo.cantidad_disponible || 0}</div>` : ''}
            <div class="book__overlay">
              <h3>${equipo.titulo || ''}</h3>
              ${equipo.codigo_inventario ? `<p><strong>C√≥digo:</strong> ${equipo.codigo_inventario}</p>` : ''}
              <p>${equipo.categoria || ''}</p>
              ${disponible ? `<p style="color:#4caf50; font-weight:600;">‚úÖ ${equipo.cantidad_disponible || 0} disponible(s)</p>` : '<p style="color:#f44336;">‚ùå No disponible</p>'}
            </div>`;
          track.appendChild(art);
        }
      } catch (e) {
        console.error('Error cargando equipos:', e);
      }
    }
    
    function filtrarPorCategoria(cat) {
      categoriaActual = cat;
      cargarCarrusel();
    }
    
    document.getElementById('btnBuscarEquipos')?.addEventListener('click', () => {
      const input = document.getElementById('buscadorInput');
      if (input && input.value.trim()) {
        realizarBusqueda(input.value);
      } else {
        cargarCarrusel();
      }
    });
    
    async function realizarBusqueda(consulta) {
      const res = await fetch('/api/libros');
      const todosElementos = res.ok ? await res.json() : [];
      const equipos = todosElementos.filter(l => {
        const cat = (l.categoria || '').toLowerCase();
        return cat.includes('equipo') || cat.includes('pc') || cat.includes('port√°til') || cat.includes('desktop') || cat.includes('tablet');
      });
      
      const palabras = consulta.toLowerCase().split(' ').filter(p => p.length > 0);
      const resultados = equipos.filter(equipo => {
        const texto = `${equipo.titulo || ''} ${equipo.categoria || ''} ${equipo.codigo_inventario || ''}`.toLowerCase();
        return palabras.some(pal => texto.includes(pal));
      });
      
      const track = document.getElementById('carouselTrack');
      track.innerHTML = '';
      
      if (resultados.length === 0) {
        track.innerHTML = '<div style="padding:40px; text-align:center; color:#666;">No se encontraron equipos.</div>';
        return;
      }
      
      resultados.sort((a, b) => ((b.cantidad_disponible || 0) > 0 ? 1 : 0) - ((a.cantidad_disponible || 0) > 0 ? 1 : 0));
      
      const placeholder = '/static/img/placeholder-book.svg';
      for (const equipo of resultados) {
        const imgSrc = equipo.imagen ? (equipo.imagen.startsWith('uploads/') ? `/${equipo.imagen}` : equipo.imagen) : placeholder;
        const disponible = (equipo.cantidad_disponible || 0) > 0;
        const art = document.createElement('article');
        art.className = 'book';
        art.onclick = () => window.location.href = `detalle_libro.html?id=${equipo.id}`;
        art.innerHTML = `
          <div class="book__image"><img src="${imgSrc}" alt="${equipo.titulo || ''}" onerror="this.src='${placeholder}'"></div>
          ${disponible ? `<div style="position:absolute; top:8px; right:8px; background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">‚úÖ ${equipo.cantidad_disponible || 0}</div>` : ''}
          <div class="book__overlay">
            <h3>${equipo.titulo || ''}</h3>
            ${equipo.codigo_inventario ? `<p><strong>C√≥digo:</strong> ${equipo.codigo_inventario}</p>` : ''}
            <p>${disponible ? `‚úÖ ${equipo.cantidad_disponible || 0} disponible(s)` : '‚ùå No disponible'}</p>
          </div>`;
        track.appendChild(art);
      }
    }
    
    cargarCarrusel();
    
    window.initializeTopbar && window.initializeTopbar();
  </script>
</body>
</html>

