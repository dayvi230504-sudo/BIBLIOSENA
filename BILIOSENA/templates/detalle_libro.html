<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalles del Libro - Biblioteca SENA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/detalle_libro.css') }}">
</head>
<body>
  <header class="encabezado">
    <img src="/static/uploads/logosena.jpg" alt="Logo SENA" class="logo">
    <div class="buscador">
      <input type="text" placeholder="Buscar">
      <button><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06zM10.5 7a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0" clip-rule="evenodd"/></svg></button>
    </div>
    <div class="usuario">
      <span>Andres Vergel</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 48 48"><path fill="currentColor" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="5" d="M24 20a7 7 0 1 0 0-14a7 7 0 0 0 0 14M6 40.8V42h36v-1.2c0-4.48 0-6.72-.872-8.432a8 8 0 0 0-3.496-3.496C35.92 28 33.68 28 29.2 28H18.8c-4.48 0-6.72 0-8.432.872a8 8 0 0 0-3.496 3.496C6 34.08 6 36.32 6 40.8"/></svg>
    </div>
  </header>

  <nav class="breadcrumb">
    <a href="principal.html">Inicio</a> > <span>Detalles del Libro</span>
  </nav>

  <main class="detalle-container">
    <div class="libro-detalle">
      <div class="libro-imagen">
        <img id="libro-portada" src="/static/uploads/libro1.jpg" alt="Portada del libro">
      </div>
      
      <div class="libro-info">
        <h1 id="libro-titulo">LA ERA DE LOS PIONEROS</h1>
        <p class="autor libro-field">Por <strong id="libro-autor">TRIGUERO MORENO, GUILLERMO</strong></p>
        <p class="equipo-field" style="display:none;"><strong id="equipo-marca-modelo">-</strong></p>
        
        <div class="disponibilidad">
          <span class="estado disponible">‚úì Disponible</span>
          <span class="copias">3 copias disponibles</span>
        </div>

        <div class="acciones">
          <button class="btn-prestamo" id="btnSolicitar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            Solicitar Pr√©stamo
          </button>
          <button class="btn-favorito">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          </button>
        </div>

        <div class="detalles-tecnicos">
          <h3 id="titulo-detalles">Informaci√≥n del Libro</h3>
          <div class="info-grid" id="info-grid">
            <!-- Campos para libros -->
            <div class="info-item libro-field">
              <span class="label">Editorial:</span>
              <span id="libro-editorial">UNIVERSITAT OBERTA D CATALUNYA</span>
            </div>
            <div class="info-item">
              <span class="label">Categor√≠a:</span>
              <span id="libro-categoria">CINE</span>
            </div>
            <div class="info-item libro-field">
              <span class="label">ISBN:</span>
              <span id="libro-isbn">978-84-9788-XXX-X</span>
            </div>
            <div class="info-item libro-field">
              <span class="label">A√±o:</span>
              <span id="libro-a√±o">2023</span>
            </div>
            <div class="info-item libro-field">
              <span class="label">P√°ginas:</span>
              <span id="libro-paginas">245</span>
            </div>
            <!-- Campos para equipos/PCs -->
            <div class="info-item equipo-field" style="display:none;">
              <span class="label">C√≥digo de Inventario:</span>
              <span id="equipo-codigo">-</span>
            </div>
            <div class="info-item equipo-field" style="display:none;">
              <span class="label">Subcategor√≠a:</span>
              <span id="equipo-subcategoria">-</span>
            </div>
            <div class="info-item">
              <span class="label">Estado:</span>
              <span class="estado-libro" id="libro-estado">Buen estado</span>
            </div>
          </div>
        </div>

        <div class="descripcion">
          <h3>Descripci√≥n</h3>
          <p id="libro-descripcion">
            Una fascinante exploraci√≥n de los primeros d√≠as del cine, desde sus humildes comienzos hasta convertirse en el medio de entretenimiento m√°s influyente del mundo. Este libro examina las innovaciones t√©cnicas, los pioneros visionarios y las obras maestras que definieron los fundamentos del s√©ptimo arte.
          </p>
        </div>
      </div>
    </div>

    <div class="libros-relacionados">
      <h3>Libros Relacionados</h3>
      <div class="relacionados-grid">
        <div class="libro-mini">
          <img src="/static/uploads/libro2.jpg" alt="Libro relacionado">
          <p>Con Tantito Epazote</p>
        </div>
        <div class="libro-mini">
          <img src="/static/uploads/libro3.jpg" alt="Libro relacionado">
          <p>Una Dise√±adora en NY</p>
        </div>
        <div class="libro-mini">
          <img src="/static/uploads/libro4.jpg" alt="Libro relacionado">
          <p>RSEI</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="pie">
    <a href="#">Listado de editoriales</a>
    <a href="#">Contacto</a>
    <a href="#">Ayuda</a>
  </footer>

  <script>
    // Obtener par√°metros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const libroId = urlParams.get('id');
    
    // Datos de ejemplo (en una app real vendr√≠an de la base de datos)
    const libros = {
      '1': {
        titulo: 'LA ERA DE LOS PIONEROS',
        autor: 'TRIGUERO MORENO, GUILLERMO',
        editorial: 'UNIVERSITAT OBERTA D CATALUNYA',
        categoria: 'CINE',
        imagen: '/static/uploads/libro1.jpg',
        isbn: '978-84-9788-001-1',
        a√±o: '2023',
        descripcion: 'Una fascinante exploraci√≥n de los primeros d√≠as del cine, desde sus humildes comienzos hasta convertirse en el medio de entretenimiento m√°s influyente del mundo.'
      },
      '2': {
        titulo: 'CON TANTITO EPAZOTE SE COMPONE',
        autor: 'BOSCH, PEDRO',
        editorial: 'FONDO DE CULTURA ECONOMICA',
        categoria: 'NARRATIVA LATINOAMERICANA',
        imagen: '/static/uploads/libro2.jpg',
        isbn: '978-84-9788-002-2',
        a√±o: '2022',
        descripcion: 'Una colecci√≥n de relatos que exploran la cultura mexicana a trav√©s de historias llenas de sabor y tradici√≥n.'
      },
      '3': {
        titulo: 'UNA DISE√ëADORA EN NUEVA YORK',
        autor: 'TRIGUERO MORENO, GUILLERMO',
        editorial: 'EDITORIAL CLUB UNIVERSITARIO (ECU)',
        categoria: 'DISE√ëO',
        imagen: '/static/uploads/libro3.jpg',
        isbn: '978-84-9788-003-3',
        a√±o: '2023',
        descripcion: 'La historia de una joven dise√±adora que busca hacer realidad sus sue√±os en la gran manzana.'
      },
      '4': {
        titulo: 'RSEI',
        autor: 'RSEI',
        editorial: 'EDICIONES UNIVERSIDAD SALAMANCA',
        categoria: 'LENGUA Y LING√ú√çSTICA',
        imagen: '/static/uploads/libro4.jpg',
        isbn: '978-84-9788-004-4',
        a√±o: '2023',
        descripcion: 'Revista de estudios sobre lengua y ling√º√≠stica con los √∫ltimos avances en investigaci√≥n.'
      },
      '5': {
        titulo: 'TECNOLOG√çA MODERNA',
        autor: 'GARC√çA L√ìPEZ, MAR√çA',
        editorial: 'EDITORIAL TECNOL√ìGICA',
        categoria: 'TECNOLOG√çA',
        imagen: '/static/uploads/libro5.jpg',
        isbn: '978-84-9788-005-5',
        a√±o: '2023',
        descripcion: 'Un an√°lisis completo de las tecnolog√≠as emergentes y su impacto en la sociedad actual.'
      },
      '6': {
        titulo: 'HISTORIA DEL ARTE',
        autor: 'MART√çNEZ RUIZ, CARLOS',
        editorial: 'EDITORIAL ARTE Y CULTURA',
        categoria: 'ARTE',
        imagen: '/static/uploads/libro6.jpg',
        isbn: '978-84-9788-006-6',
        a√±o: '2022',
        descripcion: 'Un recorrido por las principales corrientes art√≠sticas desde el Renacimiento hasta la actualidad.'
      },
      '7': {
        titulo: 'CIENCIAS NATURALES',
        autor: 'RODR√çGUEZ P√âREZ, ANA',
        editorial: 'EDITORIAL CIENT√çFICA',
        categoria: 'CIENCIA',
        imagen: '/static/uploads/libro7.jpg',
        isbn: '978-84-9788-007-7',
        a√±o: '2023',
        descripcion: 'Introducci√≥n a las ciencias naturales con ejemplos pr√°cticos y experimentos.'
      },
      '8': {
        titulo: 'LITERATURA CL√ÅSICA',
        autor: 'FERN√ÅNDEZ SILVA, LUIS',
        editorial: 'EDITORIAL CL√ÅSICOS',
        categoria: 'LITERATURA',
        imagen: '/static/uploads/libro8.jpg',
        isbn: '978-84-9788-008-8',
        a√±o: '2022',
        descripcion: 'Una selecci√≥n de las obras m√°s importantes de la literatura universal.'
      },
      '9': {
        titulo: 'MATEM√ÅTICAS APLICADAS',
        autor: 'GONZ√ÅLEZ TORRES, PEDRO',
        editorial: 'EDITORIAL MATEM√ÅTICA',
        categoria: 'MATEM√ÅTICAS',
        imagen: '/static/uploads/libro9.jpg',
        isbn: '978-84-9788-009-9',
        a√±o: '2023',
        descripcion: 'Conceptos matem√°ticos aplicados a problemas reales del mundo moderno.'
      },
      '10': {
        titulo: 'FILOSOF√çA CONTEMPOR√ÅNEA',
        autor: 'L√ìPEZ MORALES, ELENA',
        editorial: 'EDITORIAL FILOSOF√çA',
        categoria: 'FILOSOF√çA',
        imagen: '/static/uploads/libro10.jpg',
        isbn: '978-84-9788-010-0',
        a√±o: '2023',
        descripcion: 'An√°lisis de las corrientes filos√≥ficas del siglo XXI y su relevancia actual.'
      }
    };

    // Intentar cargar datos desde la API y hacer fallback a datos est√°ticos
    async function cargarDesdeAPI(id) {
      try {
        const res = await fetch(`/api/libros/${id}`);
        if (!res.ok) return false;
        const elemento = await res.json();
        
        // Detectar si es un equipo/PC o un libro
        const categoria = (elemento.categoria || '').toLowerCase();
        const esEquipo = categoria.includes('equipo') || 
                        categoria.includes('inform√°tico') || 
                        categoria.includes('pc') ||
                        categoria === 'tablets' || 
                        categoria === 'proyectores';
        
        // Actualizar t√≠tulo
        document.getElementById('libro-titulo').textContent = elemento.titulo || '';
        
        // Mostrar/ocultar campos seg√∫n tipo
        if (esEquipo) {
          // Es un equipo/PC
          document.querySelector('.autor.libro-field').style.display = 'none';
          const equipoMarca = document.querySelector('.equipo-field');
          if (equipoMarca) equipoMarca.style.display = 'block';
          document.getElementById('equipo-marca-modelo').textContent = elemento.titulo || '';
          
          // Ocultar campos de libro
          document.querySelectorAll('.libro-field').forEach(el => el.style.display = 'none');
          // Mostrar campos de equipo
          document.querySelectorAll('.equipo-field').forEach(el => el.style.display = 'block');
          
          // Actualizar t√≠tulo de secci√≥n
          document.getElementById('titulo-detalles').textContent = 'Informaci√≥n del Equipo';
          
          // Llenar campos de equipo
          document.getElementById('equipo-codigo').textContent = elemento.codigo_inventario || '-';
          document.getElementById('equipo-subcategoria').textContent = elemento.subcategoria || '-';
        } else {
          // Es un libro
          document.querySelector('.autor.libro-field').style.display = 'block';
          document.querySelector('.equipo-field')?.style.setProperty('display', 'none');
          
          // Mostrar campos de libro
          document.querySelectorAll('.libro-field').forEach(el => el.style.display = 'block');
          // Ocultar campos de equipo
          document.querySelectorAll('.equipo-field').forEach(el => el.style.display = 'none');
          
          // Actualizar t√≠tulo de secci√≥n
          document.getElementById('titulo-detalles').textContent = 'Informaci√≥n del Libro';
          
          // Llenar campos de libro
          document.getElementById('libro-autor').textContent = elemento.autor || 'Sin autor';
          document.getElementById('libro-editorial').textContent = elemento.editorial || '-';
          document.getElementById('libro-isbn').textContent = elemento.isbn || '-';
          document.getElementById('libro-a√±o').textContent = elemento.anio_publicacion || '-';
          // Las p√°ginas no vienen de la BD, mantener valor por defecto
        }
        
        // Campos comunes
        document.getElementById('libro-categoria').textContent = elemento.categoria || '';
        document.getElementById('libro-estado').textContent = elemento.estado_elemento || 'Buen estado';
        const portada = elemento.imagen ? (elemento.imagen.startsWith('uploads/') ? `/${elemento.imagen}` : elemento.imagen) : '/static/uploads/libro1.jpg';
        document.getElementById('libro-portada').src = portada;
        document.getElementById('libro-descripcion').textContent = elemento.descripcion || '';
        
        return true;
      } catch (e) {
        console.error('Error cargando datos:', e);
        return false;
      }
    }

    async function solicitarPrestamo(idElemento) {
      // Obtener informaci√≥n del usuario actual
      const token = localStorage.getItem('token');
      let idUsuario = null;
      let nombreUsuario = '';
      let documentoUsuario = '';
      
      if (token && token.startsWith('user-')) {
        idUsuario = token.replace('user-', '');
        // Intentar obtener datos del usuario
        try {
          const resUser = await fetch(`/api/usuarios/${idUsuario}`);
          if (resUser.ok) {
            const userData = await resUser.json();
            nombreUsuario = userData.nombre || '';
            documentoUsuario = userData.documento || '';
          }
        } catch(e) {}
      }
      
      if (!idUsuario) {
        alert('Necesitas iniciar sesi√≥n para solicitar un pr√©stamo');
        window.location.href = 'login.html';
        return;
      }
      try {
        // Incluir id_usuario desde el inicio
        let payload = { 
          id_elemento: idElemento, 
          id_usuario: idUsuario, // Incluir siempre el ID del usuario
          fecha_prestamo: new Date().toISOString() 
        };
        let res = await fetch('/prestamos', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(payload) 
        });
        
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) {
          alert(`‚úÖ Solicitud enviada correctamente.\n\nüë§ Usuario: ${nombreUsuario || 'N/A'}\nüÜî C√©dula: ${documentoUsuario || idUsuario}\n\nQueda pendiente de aprobaci√≥n por el administrador.`);
          return;
        }
        alert('‚ùå ' + (data.error || 'No se pudo registrar el pr√©stamo'));
      } catch (e) {
        alert('Error de red al solicitar el pr√©stamo: ' + e.message);
      }
    }

    (async () => {
      if (libroId) {
        const ok = await cargarDesdeAPI(libroId);
        if (!ok && libros[libroId]) {
          const libro = libros[libroId];
          document.getElementById('libro-titulo').textContent = libro.titulo;
          document.getElementById('libro-autor').textContent = libro.autor;
          document.getElementById('libro-editorial').textContent = libro.editorial;
          document.getElementById('libro-categoria').textContent = libro.categoria;
          document.getElementById('libro-portada').src = libro.imagen;
          document.getElementById('libro-isbn').textContent = libro.isbn;
          document.getElementById('libro-a√±o').textContent = libro.a√±o;
          document.getElementById('libro-descripcion').textContent = libro.descripcion;
        }
        const btn = document.getElementById('btnSolicitar');
        if (btn) btn.addEventListener('click', () => solicitarPrestamo(libroId));
      }
    })();
  </script>
</body>
</html>